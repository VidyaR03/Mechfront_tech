{% extends 'dashboard/base_template.html' %}
{% block title %}
CRM - Edit Expense
{% endblock %}

{% block custom_css %}
<style>
    /* Inactive tab styles */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link {
        color: #ccc;
        /* Faint gray color for inactive tabs */
    }

    /* Active tab style */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link.active {
        color: #000;
        /* Black color for active tab */
    }
</style>
{% endblock custom_css %}

{% block main_content %}
<div class="page-wrapper" data-select2-id="8" style="min-height: 432px;">
    <div class="content container-fluid" data-select2-id="7">
        <div class="page-header invoices-page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title"> <a href="{% url 'expense_vendor_list' %}" style="margin-right: 10px;"><i
                                class="fa fa-arrow-left" data-bs-toggle="tooltip" title="" data-bs-original-title="Back"
                                aria-label="fa fa-arrow-left"></i></a> Edit Expense</h3>
                </div>
                <div class="col-auto"> </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card invoices-add-card">
                    <div class="card-body">
                        <form class="invoices-form" method="post" id="invoice_form"
                            action="{% url 'edit_expense_vendor_data' id=expense_data.id%}" enctype="multipart/form-data"
                            autocomplete="off">
                            {% csrf_token %}
                            <div class="invoices-main-form">
                                <div class="row">
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <div>
                                                <label>Vendor Name <span style="color: red;">*</span></label>
                                                <select class="form-control" name="ac_vendor" id="ac_vendor" required>
                                                    <option value="" disabled>Select Vendor</option>
                                                    {% for item in vendor_name %}
                                                    <option value="{{ item.company_name }}" {% if item.company_name == expense_data.ex_vendor_name.company_name %}selected{% endif %}>{{ item.company_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <div class=" ">
                                                <span>
                                                    <label>Invoice Date <span style="color: red;">*</span></label>
                                                    <input type="date" class="form-control" name="acc_date"
                                                        id="acc_date" placeholder="Date" value="{{ expense_data.ex_invoice_date|date:'Y-m-d' }}" required>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>GST No.<span style="color: red;">*</span></label>
                                            <input type="text" class="form-control" name="acc_gst" id="acc_gst" value="{{ expense_data.ex_gst_number }}" required>
                                            <span id="gstError" style="color: red;"></span>
                                            <input type="hidden" id="gst_option" name="gst_option">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight<span style="color: red;">*</span></label>
                                            <input type="text" class="form-control" name="freight" id="freight" value="{{ expense_data.ex_freight }}" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="rowbb">
                                    <div class="invoice-add-table">
                                        <div class="table-responsive">
                                            <table class="table table-center add-table-items" id="append_table">
                                                <thead>
                                                    <tr>
                                                        <th style="padding-left: 30px;">Item Code</th>
                                                        <th width="180px">Description of Goods</th>
                                                        <th>HSN</th>
                                                        <th>Qty</th>
                                                        <th>UOM</th>
                                                        <th>Unit Price</th>
                                                        <th>Disc(%)</th>
                                                        <th>Tax Rate</th>
                                                        <th>Tax Amt</th>
                                                        <th>Total</th>
                                                        <th>Actions</th>
                                                        <th hidden>Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for item in expense_items %}
                                                    <tr class="add-row">
                                                        <input type="hidden" name="iid[]" class="iid" value="{{ forloop.counter0 }}">
                                                        <td><input type="text" style="width: 120px;" class="form-control" name="itemcode_{{ forloop.counter0 }}" id="itemcode_{{ forloop.counter0 }}" value="{{ item.ex_item_code }}"></td>
                                                        <td><input type="text" class="form-control" name="item_{{ forloop.counter0 }}" id="item_{{ forloop.counter0 }}" value="{{ item.ex_description_goods }}"></td>
                                                        <td><input type="text" class="form-control" name="hsn_{{ forloop.counter0 }}" id="hsn_{{ forloop.counter0 }}" value="{{ item.ex_hsn }}"></td>
                                                        <td><input type="text" class="form-control" name="qty_{{ forloop.counter0 }}" id="qty_{{ forloop.counter0 }}" value="{{ item.ex_qantity }}" onkeyup="qty('qty_{{ forloop.counter0 }}');"></td>
                                                        <td><input type="text" class="form-control" name="uom_{{ forloop.counter0 }}" id="uom_{{ forloop.counter0 }}" value="{{ item.ex_uom }}"></td>
                                                        <td><input type="text" class="form-control" name="rate_{{ forloop.counter0 }}" id="rate_{{ forloop.counter0 }}" value="{{ item.ex_unit_price }}" onkeyup="rate('rate_{{ forloop.counter0 }}');"></td>
                                                        <td><input type="text" class="form-control" name="discount_{{ forloop.counter0 }}" id="discount_{{ forloop.counter0 }}" value="{{ item.ex_discount }}" onkeyup="discountamt('discount_{{ forloop.counter0 }}');"></td>
                                                        <td><input type="number" class="form-control taxrate_{{ forloop.counter0 }}" name="taxrate_{{ forloop.counter0 }}" id="taxrate_{{ forloop.counter0 }}" value="{{ item.ex_tax_rate }}" onkeyup="rate('taxrate_{{ forloop.counter0 }}');" required></td>
                                                        <td><input type="text" class="form-control taxamt" name="taxamt_{{ forloop.counter0 }}" id="taxamt_{{ forloop.counter0 }}" value="{{ item.ex_tax_amount }}" readonly></td>
                                                        <td><input type="text" class="form-control totalamt" name="total_{{ forloop.counter0 }}" id="total_{{ forloop.counter0 }}" value="{{ item.ex_total }}" readonly></td>
                                                        <td class="add-remove text-end">
                                                            <a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a>
                                                            <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-7 col-md-6">
                                            <div class="invoice-fields">
                                                <h4 class="field-title">Terms and Conditions</h4> <br> <textarea
                                                    class="form-control" name="terms_condition">{{expense_data.terms_condition}}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-lg-5 col-md-6">
                                            <div class="invoice-total-card">
                                                <h4 class="invoice-total-title">Summary</h4>
                                                <div class="invoice-total-box">
                                                    <div class="invoice-total-inner">
                                                        <div class="total-tax-amt" hidden>
                                                            <label for="total_tax_amount">Total Tax Amount:</label>
                                                            <input type="text" id="total_tax_amount" class="form-control" readonly>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-6">
                                                                <p>Sub Total </p>
                                                            </div>
                                                            <div class="col-lg-6 ">
                                                                <input type="text" class="subtotal billamt utrt1"
                                                                    name="subtotal" id="subtotal" value="0.00"
                                                                    readonly="">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-6">
                                                                <p>CGST </p>
                                                            </div>
                                                            <div class="col-lg-6 ">
                                                                <input type="text" class="utrt1 billamt" name="cgst"
                                                                    id="cgst" value="0.00" readonly="">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-6">
                                                                <p>SGST </p>
                                                            </div>
                                                            <div class="col-lg-6 ">
                                                                <input type="text" class="utrt1 billamt" name="sgst"
                                                                    id="sgst" value="0.00" readonly="">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-6">
                                                                <p>IGST </p>
                                                            </div>
                                                            <div class="col-lg-6 ">
                                                                <input type="text" class="billamt utrt1" name="igst"
                                                                    id="igst" value="0.00" readonly="">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-6">
                                                                <p>Adjustments</p>
                                                            </div>
                                                            <div class="col-lg-6 ">
                                                                <input class="billamt utrt1" type="text"
                                                                    name="adjustment" id="adjustment" value="0.00"
                                                                    onkeyup="subtotal();" readonly>
                                                            </div>
                                                        </div>
                                                        <div id="pfamtgst" style="display: none;">
                                                            <div class="row">
                                                                <div class="col-lg-6"><p>P&F (Amount) + GST</p></div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1 " name="packaging_forwording_amt_amt" type="text" id="pf_amount" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="pfpergst" style="display: none;">
                                                            <div class="row">
                                                                <div class="col-lg-6"><p>P&F (Percentage) + GST</p></div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1 " type="text" name="packaging_forwording_percentage_amt" id="pf_percentage" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="freight_amount_gst_row" style="display: none;">
                                                            <div class="row">
                                                                <div class="col-lg-6"><p>Freight (Amount) + GST</p></div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text" name="freight_amt_amt" id="fr_amount" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="freight_percentage_gst_row" style="display: none;">
                                                            <div class="row">
                                                                <div class="col-lg-6"><p>Freight (Percentage) + GST</p></div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text" name="freight_percentage_amt" id="fr_percentage" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-6">
                                                                <p>TCS on Sale Of any Goods </p>
                                                            </div>
                                                            <div class="col-lg-6 ">
                                                                <input class="billamt utrt1" type="text"
                                                                    name="sale_of_good" id="sale_of_good"
                                                                    value="0.00" onkeyup="subtotal();" readonly>
                                                            </div>
                                                        </div>
                                                        <div class="invoice-total-footer">
                                                            <h4>Total Amount <input class="finalamt utrt1"
                                                                    type="text" name="totalamt" id="totalamt"
                                                                    value="{{ expense_data.all_total }}" readonly="">(Rs.)
                                                            </h4>
                                                        </div>
                                                        <div class="invoice-total-footer">
                                                            <h4>Total Amount in Words
                                                                <textarea name="so_total_amt_word" id="totalamt_word" readonly="" style="width: 370px; border: none;"></textarea>
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="upload-sign">
                                                    <div class="form-group float-end mb-0"> <a
                                                            href="{% url 'expense_vendor_list' %}"
                                                            class="btn btn-primary">Cancel</a></div>
                                                    <div class="form-group float-end mb-0"> <button
                                                            class="btn btn-primary" type="submit" id="btn_submit"
                                                            name="btn_submit">Update</button> </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row col-sm-6 p-5">
                                        <div class="success_message row"></div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.js"></script>
<script src="https://olatechs.in/crm/supreeno/assets/js/malsup-jquery.js"></script>

<!-- Consolidated JavaScript -->
<script>
$(document).ready(function () {
    // Assume company's GST state code (e.g., Maharashtra - 27)
    const companyStateCode = "27"; // Replace with dynamic value from server if available

    // GST number validation
    function validateGST(gstNo) {
        const gstPattern = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[0-9A-Z]{3}$/;
        return gstPattern.test(gstNo);
    }

    // Extract state code from GST number
    function getStateCode(gstNo) {
        return gstNo.substring(0, 2);
    }

    // Determine GST type based on GST number
    function setGstOption(gstNo) {
        if (!validateGST(gstNo)) {
            $('#gstError').text("Invalid GST Number");
            $('#gst_option').val("");
            updateTaxFields();
            return false;
        }
        $('#gstError').text("");
        const vendorStateCode = getStateCode(gstNo);
        const gstType = (vendorStateCode === companyStateCode) ? "Intrastate" : "Interstate";
        $('#gst_option').val(gstType);
        updateTaxFields();
        return true;
    }

    // GST number input handler
    $('#acc_gst').on('input', function () {
        const gstNo = $(this).val().toUpperCase();
        if (gstNo.length === 15) {
            setGstOption(gstNo);
            $('.add-row').each(function (index) {
                rate(`rate_${index}`);
            });
            subtotal();
            updateTotalInWords();
        } else {
            $('#gstError').text("Enter a valid GST number (e.g., 12ABCDE1234F1Z5).");
            $('#gst_option').val("");
            updateTaxFields();
        }
    });

    // Clear related fields
    function clearRelatedFields(inputname, item, description, godown, qty, rate, uom, discount, taxrate, hsn) {
        $('#' + inputname).val('');
        $('#' + item).val('');
        $('#' + description).val('');
        $('#' + godown).val('');
        $('#' + qty).val('');
        $('#' + rate).val('');
        $('#' + uom).val('');
        $('#' + discount).val('');
        $('#' + taxrate).val('');
        $('#' + hsn).val('');
        calculateTotalTaxAmount();
        subtotal();
        updateTotalInWords();
    }

    // Autocomplete for itemcode
    function initializeItemCodeAutocomplete(inputname, item, description, godown, qty, rate, uom, discount, taxrate, hsn) {
        let input = inputname.split("_");
        let id_val = input[1];

        $('#' + inputname).autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "{% url 'getitemscodedetails' %}",
                    dataType: "json",
                    type: "POST",
                    data: {
                        name_startsWith: request.term,
                        itemsdetails: input,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (data) {
                        console.log("Response for " + inputname + ":", data);
                        if (data.length === 0) {
                            response([{ label: "No results found", value: "" }]);
                        } else {
                            response($.map(data, function (item) {
                                var code = item.split("|");
                                return {
                                    label: code[0],
                                    value: code[0],
                                    data: item
                                };
                            }));
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX error for " + inputname + ":", error);
                        response([]);
                    }
                });
            },
            autoFocus: true,
            minLength: 1,
            select: function (event, ui) {
                if (ui.item.value !== "") {
                    var names = ui.item.data.split("|");
                    $('#' + inputname).val(names[0]); // item_code
                    $('#' + item).val(names[1]); // inventory_name
                    $('#' + hsn).val(names[2]); // hsn
                    $('#' + qty).val(names[3]); // qty (default 1)
                    $('#' + discount).val(names[4]); // default_discount
                    $('#' + rate).val(names[5]); // sales_rate
                    $('#' + uom).val(names[7]); // units
                    $('#' + description).val(names[8]); // sales_information_description
                    $('#' + taxrate).val(names[6] || '0'); // tax rate

                    calculateTotalTaxAmount();
                    updateTaxFields();
                    discountamt(inputname);
                    subtotal();
                    calculatePFPercentage();
                    calculateFreightPercentage();
                    updateTotalInWords();
                    updatePFAmount();
                    updateFreightPercentage();
                    updatePFPercentage();
                }
            },
            change: function (event, ui) {
                if (!ui.item && !$('#' + inputname).val()) {
                    clearRelatedFields(inputname, item, description, godown, qty, rate, uom, discount, taxrate, hsn);
                }
            },
            open: function () {
                console.log("Dropdown opened for " + inputname);
            }
        });
    }

    // Autocomplete for item
    function initializeItemAutocomplete(inputname, description, godown, qty, rate, uom, discount, taxrate, hsn, itemcode) {
        let input = inputname.split("_");
        let id_val = input[1];

        $('#' + inputname).autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "{% url 'getitemscodedetails' %}",
                    dataType: "json",
                    type: "POST",
                    data: {
                        name_startsWith: request.term,
                        itemsdetails: input,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (data) {
                        console.log("Response for " + inputname + ":", data);
                        if (data.length === 0) {
                            response([{ label: "No results found", value: "" }]);
                        } else {
                            response($.map(data, function (item) {
                                var code = item.split("|");
                                return {
                                    label: code[0],
                                    value: code[0],
                                    data: item
                                };
                            }));
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX error for " + inputname + ":", error);
                        response([]);
                    }
                });
            },
            autoFocus: true,
            minLength: 1,
            select: function (event, ui) {
                if (ui.item.value !== "") {
                    var names = ui.item.data.split("|");
                    $('#' + inputname).val(names[0]);
                    $('#' + description).val(names[1]);
                    $('#' + godown).val(names[2]);
                    $('#' + qty).val('1');
                    $('#' + rate).val(names[8]);
                    $('#' + uom).val(names[10]);
                    $('#' + discount).val(names[6]);
                    $('#' + taxrate).val(names[7]);
                    $('#' + hsn).val(names[5]);
                    $('#' + itemcode).val(names[11]);

                    calculateTotalTaxAmount();
                    updateTaxFields();
                    discountamt(inputname);
                    subtotal();
                    calculatePFPercentage();
                    calculateFreightPercentage();
                    updateTotalInWords();
                    updatePFAmount();
                    updateFreightPercentage();
                    updatePFPercentage();
                }
            },
            change: function (event, ui) {
                if (!ui.item && !$('#' + inputname).val()) {
                    clearRelatedFields(inputname, itemcode, description, godown, qty, rate, uom, discount, taxrate, hsn);
                }
            },
            open: function () {
                console.log("Dropdown opened for " + inputname);
            }
        });
    }

    // Initialize autocomplete for existing rows
    {% for item in expense_items %}
    initializeItemCodeAutocomplete('itemcode_{{ forloop.counter0 }}', 'item_{{ forloop.counter0 }}', 'description_{{ forloop.counter0 }}', 'godown_{{ forloop.counter0 }}', 'qty_{{ forloop.counter0 }}', 'rate_{{ forloop.counter0 }}', 'uom_{{ forloop.counter0 }}', 'discount_{{ forloop.counter0 }}', 'taxrate_{{ forloop.counter0 }}', 'hsn_{{ forloop.counter0 }}');
    initializeItemAutocomplete('item_{{ forloop.counter0 }}', 'description_{{ forloop.counter0 }}', 'godown_{{ forloop.counter0 }}', 'qty_{{ forloop.counter0 }}', 'rate_{{ forloop.counter0 }}', 'uom_{{ forloop.counter0 }}', 'discount_{{ forloop.counter0 }}', 'taxrate_{{ forloop.counter0 }}', 'hsn_{{ forloop.counter0 }}', 'itemcode_{{ forloop.counter0 }}');
    {% endfor %}

    // Handle dynamically added rows
    $(document).on('click', '.add-btn', function () {
        var i = $('.add-row').length;
        var experiencecontent = `
            <tr class="add-row">
                <input type="hidden" name="iid[]" class="iid" value="${i}">
                <td><input type="text" class="form-control" style="width: 120px;" name="itemcode_${i}" id="itemcode_${i}"></td>
                <td><input type="text" class="form-control" name="item_${i}" id="item_${i}" placeholder=" "></td>
                <td><input type="text" class="form-control" name="hsn_${i}" id="hsn_${i}"></td>
                <td><input type="text" class="form-control" name="qty_${i}" id="qty_${i}"></td>
                <td><input type="text" class="form-control" name="uom_${i}" id="uom_${i}"></td>
                <td><input type="text" class="form-control" name="rate_${i}" id="rate_${i}"></td>
                <td><input type="text" class="form-control" name="discount_${i}" id="discount_${i}"></td>
                <td><input type="number" class="form-control taxrate_${i}" name="taxrate_${i}" id="taxrate_${i}" required></td>
                <td><input type="text" class="form-control taxamt" name="taxamt_${i}" id="taxamt_${i}" readonly></td>
                <td><input type="text" class="form-control totalamt" name="total_${i}" id="total_${i}" readonly></td>
                <td class="add-remove text-end">
                    <a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a>
                    <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
                </td>
            </tr>`;
        
        $("#append_table > tbody").append(experiencecontent);

        // Attach autocomplete
        initializeItemCodeAutocomplete(`itemcode_${i}`, `item_${i}`, `description_${i}`, `godown_${i}`, `qty_${i}`, `rate_${i}`, `uom_${i}`, `discount_${i}`, `taxrate_${i}`, `hsn_${i}`);
        initializeItemAutocomplete(`item_${i}`, `description_${i}`, `godown_${i}`, `qty_${i}`, `rate_${i}`, `uom_${i}`, `discount_${i}`, `taxrate_${i}`, `hsn_${i}`, `itemcode_${i}`);

        // Attach event listeners to the new inputs
        $(`#qty_${i}, #rate_${i}, #discount_${i}, #taxrate_${i}`).on('keyup', function () {
            calculateRow(i);
        });

        // Optional: recalculate immediately to initialize tax if needed
        calculateRow(i);
    });

    // Handle row removal
    $(document).on('click', '.remove-btn', function () {
        $(this).closest('.add-row').remove();
        calculateTotalTaxAmount();
        subtotal();
        updateTotalInWords();
    });

    // Datepicker initialization
    $('#quotation_date, #expiry_date').datepicker({
        dateFormat: 'dd-mm-yy',
        minDate: 0
    });

    // Customer selection
    $('#customer_Name').on('input', function () {
        var input = this.value;
        var list = $('#customer_Name_list').find('option');
        for (var i = 0; i < list.length; i++) {
            if (list[i].value === input) {
                $('#customer_id').val(list[i].dataset.id);
                $('#contact_person_name').val(list[i].dataset.contact_person);
                $('#contact_person_email').val(list[i].dataset.email);
                $('#destination').val(list[i].dataset.address);
                $('#q_ser_type').val(list[i].dataset.service_type);
                break;
            }
        }
    });

    // Email validation
    function isValidEmail(email) {
        if (email.toLowerCase() === 'na' || email.toLowerCase() === 'nan') return true;
        var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailPattern.test(email);
    }

    $('#contact_person_email').on('input', function () {
        var email = this.value;
        var errorMsg = $('#email-error-message');
        if (!isValidEmail(email) && email !== "") {
            errorMsg.show();
            this.setCustomValidity('Invalid email address');
        } else {
            errorMsg.hide();
            this.setCustomValidity('');
        }
    });

    $('#invoice_form').on('submit', function (event) {
        if (!isValidEmail($('#contact_person_email').val())) {
            event.preventDefault();
        }
    });

    // Freight and Packaging field toggling
    function toggleFreightFields() {
        const freightAmount = parseFloat($('#freight_amount').val()) || 0;
        const freightPercentage = parseFloat($('#freight_percentage').val()) || 0;
        $('#freight_amount_gst_row').toggle(freightAmount > 0);
        $('#freight_percentage_gst_row').toggle(freightPercentage > 0);
        $('#freight_percentage').prop('disabled', freightAmount > 0);
        $('#freight_amount').prop('disabled', freightPercentage > 0);
    }

    function togglePfFields() {
        const pfAmount = parseFloat($('#packaging_forwording_amount').val()) || 0;
        const pfPercentage = parseFloat($('#packaging_forwording_percentage').val()) || 0;
        $('#pfamtgst').toggle(pfAmount > 0);
        $('#pfpergst').toggle(pfPercentage > 0);
        $('#packaging_forwording_percentage').prop('disabled', pfAmount > 0);
        $('#packaging_forwording_amount').prop('disabled', pfPercentage > 0);
    }

    $('#freight_amount, #freight_percentage').on('input', toggleFreightFields);
    $('#packaging_forwording_amount, #packaging_forwording_percentage').on('input', togglePfFields);
    toggleFreightFields();
    togglePfFields();

    // Calculations
    function calculateTotalTaxAmount() {
        let totalTaxAmount = 0;
        $('.taxamt').each(function () {
            let taxAmt = parseFloat($(this).val()) || 0;
            totalTaxAmount += taxAmt;
        });
        $('#total_tax_amount').val(totalTaxAmount.toFixed(2));
        updateTaxFields();
    }

    function updateTaxFields() {
        const gstOption = $('#gst_option').val();
        const totalTaxAmount = parseFloat($('#total_tax_amount').val()) || 0;

        if (gstOption === 'Interstate') {
            $('#igst').val(totalTaxAmount.toFixed(2));
            $('#cgst').val('0.00');
            $('#sgst').val('0.00');
        } else if (gstOption === 'Intrastate') {
            const halfTax = (totalTaxAmount / 2).toFixed(2);
            $('#cgst').val(halfTax);
            $('#sgst').val(halfTax);
            $('#igst').val('0.00');
        } else {
            $('#cgst, #sgst, #igst').val('0.00');
        }
        subtotal();
    }

    function updatePFAmount() {
        var pfAmount = parseFloat($('#packaging_forwording_amount').val()) || 0;
        var gstAmount = (pfAmount * 0.18).toFixed(2);
        $('#pf_amount').val((pfAmount + parseFloat(gstAmount)).toFixed(2));
        updateTotalInWords();
    }

    function updateFreightAmount() {
        var frAmount = parseFloat($('#freight_amount').val()) || 0;
        var gstAmount = (frAmount * 0.18).toFixed(2);
        $('#fr_amount').val((frAmount + parseFloat(gstAmount)).toFixed(2));
        updateTotalInWords();
    }

    function calculatePFPercentage() {
        var subtotal = parseFloat($('#subtotal').val()) || 0;
        var percentage = parseFloat($('#packaging_forwording_percentage').val()) || 0;
        var pfAmount = (subtotal * percentage) / 100;
        var gstAmount = (pfAmount * 0.18).toFixed(2);
        $('#pf_percentage').val((pfAmount + parseFloat(gstAmount)).toFixed(2));
        updateTotalInWords();
    }

    function calculateFreightPercentage() {
        var subtotal = parseFloat($('#subtotal').val()) || 0;
        var percentage = parseFloat($('#freight_percentage').val()) || 0;
        var frAmount = (subtotal * percentage) / 100;
        var gstAmount = (frAmount * 0.18).toFixed(2);
        $('#fr_percentage').val((frAmount + parseFloat(gstAmount)).toFixed(2));
        updateTotalInWords();
    }

    function discountamt(inputname) {
        let input = inputname.split("_");
        let id_val = input[1];
        let rate = parseFloat($('#rate_' + id_val).val()) || 0;
        let discount = parseFloat($('#discount_' + id_val).val()) || 0;
        let qty = parseFloat($('#qty_' + id_val).val()) || 0;
        let item_rate = $('#item_rate').val();

        let total = rate - (rate * discount / 100);
        let totalamt = total * qty;
        let taxrate = parseFloat($('#taxrate_' + id_val).val()) || 0;
        let taxamt = totalamt * taxrate / 100;

        if (item_rate === 'tax_exclusive') {
            $('#total_' + id_val).val(totalamt.toFixed(2));
            $('#taxamt_' + id_val).val(taxamt.toFixed(2));
        } else {
            $('#taxamt_' + id_val).val(taxamt.toFixed(2));
            $('#total_' + id_val).val((totalamt - taxamt).toFixed(2));
        }

        subtotal();
        calculateTotalTaxAmount();
        updateTotalInWords();
    }

    function qty(inputname) {
        let input = inputname.split("_");
        let id_val = input[1];
        let rate = parseFloat($('#rate_' + id_val).val()) || 0;
        let qty = parseFloat($('#qty_' + id_val).val()) || 0;
        let discount = parseFloat($('#discount_' + id_val).val()) || 0;
        let item_rate = $('#item_rate').val();

        let total = rate - (rate * discount / 100);
        let totalamt = total * qty;
        let taxrate = parseFloat($('#taxrate_' + id_val).val()) || 0;
        let taxamt = totalamt * taxrate / 100;

        if (item_rate === 'tax_exclusive') {
            $('#total_' + id_val).val(totalamt.toFixed(2));
            $('#taxamt_' + id_val).val(taxamt.toFixed(2));
        } else {
            $('#taxamt_' + id_val).val(taxamt.toFixed(2));
            $('#total_' + id_val).val((totalamt - taxamt).toFixed(2));
        }

        subtotal();
        calculateTotalTaxAmount();
        updateTotalInWords();
    }

    function rate(inputname) {
        const input = inputname.split("_");
        const id_val = input[1];

        if (!isGstSelected()) {
            alert("Please select GST type first.");
            return;
        }

        const rate = parseFloat($('#rate_' + id_val).val()) || 0;
        const qty = parseFloat($('#qty_' + id_val).val()) || 0;
        const discount = parseFloat($('#discount_' + id_val).val()) || 0;
        const taxrate = parseFloat($('#taxrate_' + id_val).val()) || 0;
        const item_rate = $('#item_rate').val();

        const discounted_rate = rate - (rate * discount / 100);
        const base_amount = discounted_rate * qty;
        const tax_amount = base_amount * taxrate / 100;

        if (item_rate === 'tax_exclusive') {
            $('#total_' + id_val).val(base_amount.toFixed(2));
            $('#taxamt_' + id_val).val(tax_amount.toFixed(2));
        } else {
            const base = base_amount / (1 + taxrate / 100);
            const tax = base_amount - base;
            $('#total_' + id_val).val(base.toFixed(2));
            $('#taxamt_' + id_val).val(tax.toFixed(2));
        }

        subtotal();
        calculateTotalTaxAmount();
        updateTotalInWords();
    }

    function subtotal() {
        let totalamt = 0;
        $('.totalamt').each(function () {
            totalamt += parseFloat($(this).val()) || 0;
        });
        $('#subtotal').val(totalamt.toFixed(2));

        let taxamt = 0;
        $('.taxamt').each(function () {
            taxamt += parseFloat($(this).val()) || 0;
        });

        let adjustment = parseFloat($('#adjustment').val()) || 0;
        let pf_amount = parseFloat($('#pf_amount').val()) || 0;
        let fr_amount = parseFloat($('#fr_amount').val()) || 0;
        let pf_percentage = parseFloat($('#pf_percentage').val()) || 0;
        let fr_percentage = parseFloat($('#fr_percentage').val()) || 0;
        let sale_of_good = parseFloat($('#sale_of_good').val()) || 0;

        let finalamt = totalamt + taxamt + adjustment + pf_amount + fr_amount + pf_percentage + fr_percentage + sale_of_good;
        $('#totalamt').val(finalamt.toFixed(2));

        updateTotalInWords();
    }

    function isGstSelected() {
        return $('#gst_option').val() !== "";
    }

    function test(n) {
        if (n < 0) return false;
        const single_digit = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const double_digit = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const below_hundred = ['Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

        if (n === 0) return 'Zero Rupees';

        function translate(n) {
            let word = "";
            if (n < 10) {
                word = single_digit[n] + ' ';
            } else if (n < 20) {
                word = double_digit[n - 10] + ' ';
            } else if (n < 100) {
                const rem = translate(n % 10);
                word = below_hundred[Math.floor(n / 10) - 2] + ' ' + rem;
            } else if (n < 1000) {
                word = single_digit[Math.floor(n / 100)] + ' Hundred ' + translate(n % 100);
            } else if (n < 100000) {
                word = translate(Math.floor(n / 1000)).trim() + ' Thousand ' + translate(n % 1000);
            } else if (n < 10000000) {
                word = translate(Math.floor(n / 100000)).trim() + ' Lakh ' + translate(n % 100000);
            } else if (n < 1000000000) {
                word = translate(Math.floor(n / 10000000)).trim() + ' Crore ' + translate(n % 10000000);
            } else {
                word = translate(Math.floor(n / 1000000000)).trim() + ' Arab ' + translate(n % 1000000000);
            }
            return word;
        }

        let [integerPart, decimalPart] = n.toString().split('.');
        let result = translate(parseInt(integerPart)).trim() + ' Rupees';
        if (decimalPart) {
            decimalPart = decimalPart.padEnd(2, '0');
            result += ' and ' + translate(parseInt(decimalPart)) + ' Paise';
        }
        return result.trim() + '.';
    }

    function updateTotalInWords() {
        const totalAmt = parseFloat($('#totalamt').val()) || 0;
        $('#totalamt_word').val(isNaN(totalAmt) ? '' : test(totalAmt));
    }

    $('#freight_amount, #freight_percentage, #packaging_forwording_amount, #packaging_forwording_percentage, #gst_option, #igst').on('input', function () {
        subtotal();
        updateTotalInWords();
    });

    $('#gst_option, #item_rate').on('change', function () {
        $('.add-row').each(function (index) {
            rate(`rate_${index}`);
        });
    });

    $('#adjustment, #packaging_forwording_amount, #freight_amount, #packaging_forwording_percentage, #freight_percentage').on('input', function () {
        subtotal();
        updateTotalInWords();
    });

    function calculateRow(index) {
        const rate = parseFloat($('#rate_' + index).val()) || 0;
        const qty = parseFloat($('#qty_' + index).val()) || 0;
        const discount = parseFloat($('#discount_' + index).val()) || 0;
        const taxrate = parseFloat($('#taxrate_' + index).val()) || 0;
        const item_rate = $('#item_rate').val();

        const discounted_rate = rate - (rate * discount / 100);
        const base_amount = discounted_rate * qty;
        const tax_amount = base_amount * taxrate / 100;

        if (item_rate === 'tax_exclusive') {
            $('#total_' + index).val(base_amount.toFixed(2));
            $('#taxamt_' + index).val(tax_amount.toFixed(2));
        } else {
            const base = base_amount / (1 + taxrate / 100);
            const tax = base_amount - base;
            $('#total_' + index).val(base.toFixed(2));
            $('#taxamt_' + index).val(tax.toFixed(2));
        }

        subtotal();
        calculateTotalTaxAmount();
        updateTotalInWords();
    }

    {% for item in expense_items %}
    $('#qty_{{ forloop.counter0 }}, #rate_{{ forloop.counter0 }}, #discount_{{ forloop.counter0 }}, #taxrate_{{ forloop.counter0 }}').on('keyup', function () {
        calculateRow({{ forloop.counter0 }});
    });
    {% endfor %}

    // Initial calculations
    calculateTotalTaxAmount();
    subtotal();
    updateTotalInWords();
});
</script>
{% endblock main_content %}