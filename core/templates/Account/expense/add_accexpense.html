{% extends 'dashboard/base_template.html' %}
{% block title %}
CRM
{% endblock %}

{% block custom_css %}
<style>
    /* Inactive tab styles */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link {
        color: #ccc;
        /* Faint gray color for inactive tabs */
    }

    /* Active tab style */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link.active {
        color: #000;
        /* Black color for active tab */
    }
    
    .toast {
        min-width: 250px;
        font-size: 14px;
    }
    .toast-success {
        background-color: #28a745;
        color: white;
    }
    .toast-error {
        background-color: #dc3545;
        color: white;
    }
    .toast-container {
        z-index: 1055; /* Bootstrap's default z-index for toasts */
        top: 70px; /* Adjust based on header height */
    }
    /* Ensure parent containers don't clip the toast */
    .page-wrapper, .content {
        overflow: visible !important;
    }

</style>
{% endblock custom_css %}

{% block main_content %}
<div class="page-wrapper" data-select2-id="8" style="min-height: 415px;">
    <div class="content container-fluid" data-select2-id="7">
        <div class="page-header invoices-page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title"> <a href="{% url 'accexpense_list'%}" style="margin-right: 10px;"><i
                                class="fa fa-arrow-left" data-bs-toggle="tooltip" title="" data-bs-original-title="Back"
                                aria-label="fa fa-arrow-left"></i></a> Add Expense </h3>
                </div>
                <div class="col-auto"> </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card invoices-add-card">
                    <div class="card-body">
                        <form class="invoices-form" method="post" id="invoice_form" action="{% url 'add_accexpense'%}"
                            enctype="multipart/form-data" autocomplete="off">
                            {% csrf_token %}
                            <div class="invoices-main-form">
                                <div class="row">
                                

                                    <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <div class=" ">
                                                <span>
                                                    <label>Invoice Date  <span class="text-danger">*</span></label></label>
                                                    <input class="form-control datetimepicker" type="text"
                                                        name="invoice_date" id="invoice_date" placeholder="Date" value="{{current_date}}"  required>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                    

          
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>GST No. <span class="text-danger">*</span></label></label>
                                            <input type="text" class="form-control" name="acc_gst" id="gst_no_input" placeholder="GST No." required>
                                            <span id="gstError" style="color: red;"></span>

                                        </div>
                                    </div>


                                    <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label style="color:black">Vendor Name  <span class="text-danger">*</span></label></label>
                                            <div>
                                                <select class="form-control" required name="vendor_Name"
                                                    id="vendor_Name">
                                                    <option value="" selected disabled hidden>Select Vendor</option>
                                                    {% for i in vendor_name %}
                                                    <option value="{{i.id}}">{{i.company_name}}</option>
                                                    {% endfor %}

                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight</label>
                                            <input type="number" class="form-control" name="freight" id="freight"
                                                value="0.00">
                                        </div>
                                    </div>
                                        <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                            <div class="form-group">
                                                <label>Invoice No</label>
                                                <input type="text" class="form-control" name="ae_invoice_no" id="ae_invoice_no">
                                            </div>
                                        </div>
                                    

                                        <div class="col-md-3">
                                            <div class="form-group">
                                            <label>Cost Centre  <span class="text-danger">*</span></label></label>
                                            <select class="form-select" name="ae_cost_center" id="ae_cost_center                                               " required>                                               
                                                <option value="">Select Cost Center</option>
                                                <option value="Office Cleaning">Office Cleaning</option>
                                                <option value="Electricity Bill">Electricity Bill</option>
                                                <option value="Rent">Rent</option>
                                                <option value="Drinking Water">Drinking Water</option>
                                                <option value="Consultancy Charges">Consultancy Charges</option>
                                                <option value="Software Design">Software Design</option>
                                                <option value="Repair And Maintenance">Repair And Maintenance</option>
                                                <option value="Other Expenses">Other Expenses</option>
                                                <option value="Transport">Transport</option>
                                                <option value="Loading &amp; Unloading Wages">Loading &amp; Unloading Wages</option>
                                                <option value="Canteen">Canteen</option>
                                                <option value="Freight and Other Charges">Freight and Other Charges</option>
                                                

                                            </select>
                                            </div>
                                        </div>
                                     <div class="col-lg-2">
                                        <label >Upload File <span style="color: red;"></span></label>
                                        <div class="form-group">
                                            <input type="file" class="form-control" name="ae_upload_file" accept="acc_expence/*" >
                                     </div>
                                    </div>
                                    <div class="col-lg-2" style="visibility: hidden;">
                                        <div class="form-group">
                                            <label>Item Rates Are </label>
                                            <select class="form-control" name="item_rate" id="item_rate">
                                                <option value="tax_exclusive">Tax Exclusive</option>
                                                <option value="tax_inclusive">Tax Inclusive </option>
                                            </select>
                                        </div>
                                    </div>
                                    

                              
                                    <div class="rowbb">
                                        <div class="invoice-add-table">
                                            <div class="table-responsive">
                                                <table class="table table-center add-table-items">
                                                    <thead>
                                                        <tr>
                                                            <th>Item Code</th>
                                                            <th width="180px">Description of Goods</th>
                                                            <th>HSN</th>
                                                            <th>Qty</th>
                                                            <th>UOM</th>
                                                            <th>Unit Price</th>
                                                            <th>Disc(%)</th>
                                                            <th>Tax Rate</th>
                                                            <th>Tax Amt</th>
                                                            <th>Total</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <input type="hidden" name="iid[]" class="iid" value="0">
                                                        <tr class="add-row">
                                                            <td><input type="text" class="form-control"
                                                                    name="itemcode_0" id="itemcode_0"
                                                                    onkeyup="purchasegetitemscodedetails('itemcode_0','item_0','qty_0','rate_0','hsn_0','sac_0','uom_0','discount_0','taxrate_0','itemcode_0');">
                                                            </td>

                                                            <td><input type="text" class="form-control item-input" name="item_0"
                                                                    id="item_0"
                                                                    onkeyup="purchasegetitemsdetails('item_0','qty_0','rate_0','hsn_0','sac_0','uom_0','discount_0','taxrate_0','itemcode_0');"
                                                                    autocomplete="off"> </td>

                                                            <td><input type="text" class="form-control" name="hsn_0"
                                                                    id="hsn_0"></td>

                                                            <!-- <td><input type="text" class="form-control" name="sac_0"
                                                                    id="sac_0"></td> -->

                                                            <td><input type="number" class="form-control" step="0.01" name="qty_0"
                                                                    id="qty_0" onkeyup="qty('qty_0')"> </td>

                                                            <td><input type="text" class="form-control" name="uom_0"
                                                                    id="uom_0"></td>

                                                            <td><input type="number" step="0.001" class="form-control" step="0.01" name="rate_0"
                                                                    id="rate_0" onkeyup="rate('rate_0')"></td>

                                                            <td><input type="number" class="form-control"
                                                                    step="0.01" name="discount_0" id="discount_0"
                                                                    onkeyup="discountamt('discount_0')"></td>

                                                            <td><input type="number" class="form-control" name="taxrate_0"
                                                                    id="taxrate_0" onkeyup="rate('taxrate_0')"></td>

                                                            <td><input type="text" class="form-control taxamt"
                                                                    name="taxamt_0" id="taxamt_0" readonly></td>

                                                            <td><input type="text" class="form-control totalamt"
                                                                    name="total_0" id="total_0" readonly></td>

                                                            <td class="add-remove text-end"> <a
                                                                    href="javascript:void(0);" class="add-btn me-2"><i
                                                                        class="fas fa-plus"></i></a> <a
                                                                    href="javascript:void(0);" class="remove-btn"><i
                                                                        class="fe fe-trash-2"></i></a></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-7 col-md-6">
                                                <!-- <div class="form-group float-end mb-0"> <button class="btn btn-primary" type="submit">Add Item</button> </div> -->
                                                <div class="invoice-fields">
                                                    <h4 class="field-title">T&amp;C Note..</h4> <br> <textarea
                                                        class="form-control" name="note"></textarea>
                                                </div>
                                            </div>
                                            <div class="col-lg-5 col-md-6">
                                                <div class="invoice-total-card">
                                                    <h4 class="invoice-total-title">Summary</h4>
                                                    <div class="invoice-total-box">
                                                        <div class="invoice-total-inner">

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>Sub Total </p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="subtotal billamt utrt1"
                                                                        name="subtotal" value="0.00" readonly="">
                                                                </div>
                                                            </div>

                                                            <!-- <div class="row">
                                                                        <div class="col-lg-6"><p>Freight</p></div>
                                                                        <div class="col-lg-6 ">
                                                                            <input class="billamt utrt1" type="text" name="freight" id="freight" value="0.00" onkeyup="getbillamt();" >
                                                                        </div>
                                                                    </div> -->

                                                            <div class="row">
                                                                <!-- <div class="col-lg-6"><p>Tax Amt</p></div> -->
                                                                <div class="col-lg-6 ">
                                                                    <input type="hidden"
                                                                        class="totaltaxamt billamt utrt1"
                                                                        name="total_taxamt" id="total_taxamt"
                                                                        value="0.00" readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>CGST @ <input type="text" name="cgstper"
                                                                            id="cgstper" value="0%" size="1"
                                                                            class="no-outline"></p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="utrt1" name="cgst"
                                                                        id="cgst" value="0.00" readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>SGST @ <input type="text" name="sgstper"
                                                                            id="sgstper" value="0%" size="1"
                                                                            class="no-outline"></p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="utrt1" name="sgst"
                                                                        id="sgst" value="0.00" readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>IGST @ <input type="text" name="igstper"
                                                                            id="igstper" value="0%" size="1"
                                                                            class="no-outline"></p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="utrt1" name="igst"
                                                                        id="igst" value="0.00" readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>Adjustments</p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text"
                                                                        name="adjustment" id="adjustment" value="0.00"
                                                                        onkeyup="getbillamt();">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>TCS on Sale Of any Goods </p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text"
                                                                        name="sale_of_good" id="sale_of_good"
                                                                        value="0.00" onkeyup="getbillamt();">
                                                                </div>
                                                            </div>

                                                            <div class="invoice-total-footer">
                                                                <h4>Total Amount <input class="finalamt utrt1"
                                                                        type="text" name="all_total" value="0.00"
                                                                        readonly=""></h4>
                                                            </div>

                                                        </div>
                                                    </div>

                                                    <div class="upload-sign">
                                                        <div class="form-group float-end mb-0"> <a
                                                                href="{% url 'purchase_order_list' %}"
                                                                class="btn btn-primary">Cancel</a> </div>
                                                        <div class="form-group float-end mb-0"> <button
                                                                class="btn btn-primary" type="submit" id="btn_submit"
                                                                name="btn_submit">Save</button>
                                                        </div>
                                                        <button type="reset"
                                                            class="btn btn-outline-secondary me-1 btn-rounded">Reset</button>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row col-sm-6 p-5">
                                        <div class="success_message row"></div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>


{% block custom_js %}

<!-- External Dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.js"></script>
<script src="https://olatechs.in/crm/supreeno/assets/js/malsup-jquery.js"></script>


<script>
    $(function () {
        $("#vendor_Name_id").autocomplete({
            source: "{% url 'autocomplete_vendor_name' %}",
            minLength: 1,
            select: function (event, ui) {
                // Set the selected customer's ID in the hidden field
                $("#vendor_id").val(ui.item.id);
            }
        });
    });
</script>


        
<script type="text/javascript">
    $(document).ready(function () {
        var i = 1;
        function reindexRows() {
    var rowIndex = 0;
    $(".add-table-items .add-row").each(function () {
        $(this).find('.iid').val(rowIndex);
        $(this).find('input').each(function () {
            var name = $(this).attr('name');
            var id = $(this).attr('id');
 
            // Update name and id by replacing the current index with rowIndex
            if (name) {
                name = name.replace(/_\d+$/, '_' + rowIndex);
                $(this).attr('name', name);
            }
            if (id) {
                id = id.replace(/_\d+$/, '_' + rowIndex);
                $(this).attr('id', id);
            }
            var onkeyup = $(this).attr('onkeyup');
                if (onkeyup) {
                    onkeyup = onkeyup.replace(/_\d+/g, '_' + rowIndex); // Update all instances of _\d+ to the current rowIndex
                    $(this).attr('onkeyup', onkeyup);
                }
        });
        rowIndex++;
    });
    i = rowIndex;  // Update the global index `i` to the new row count
    }
  

        // Function to handle removing rows
        $(".add-table-items").on('click', '.remove-btn', function () {
            if ($('.add-row').length > 1) {
                $(this).closest('.add-row').remove();
                reindexRows();

                subtotal();
                getbillamt();
                totaltaxamt();

            } else {
                alert("At least one row must remain.");
            }
            return false;
        });

        // Function to handle adding rows
        $(document).on("click", ".add-btn", function () {
            var experiencecontent = '<tr class="add-row">' +
                '<input type="hidden" name="iid[]" class="iid" value="' + i + '">' +
           

                '<td>' +
                '<input type="text" class="form-control itemcode" name="itemcode_' + i + '" id="itemcode_' + i + '">' +
                '</td>' +

                '<td>' +
                '<input type="text" name="item_' + i + '" id="item_' + i + '" class="form-control item-input">' +
                '</td>' +

               

                '<td>' +
                '<input type="text" class="form-control" name="hsn_' + i + '" id="hsn_' + i + '">' +
                '</td>' +

                '<td>' +
                '<input type="number" class="form-control" step="0.01" name="qty_' + i + '" id="qty_' + i + '" onkeyup="qty(\'qty_' + i + '\');">' +
                '</td>' +

                '<td>' +
                '<input type="text" class="form-control" name="uom_' + i + '" id="uom_' + i + '">' +
                '</td>' +

                '<td>' +
                '<input type="number" step="0.001" class="form-control" step="0.01" name="rate_' + i + '" id="rate_' + i + '" onkeyup="rate(\'rate_' + i + '\');">' +
                '</td>' +

                '<td>' +
                '<input type="number" class="form-control" step="0.01" name="discount_' + i + '" id="discount_' + i + '" onkeyup="discountamt(\'discount_' + i + '\');">' +
                '</td>' +

                '<td>' +
                '<input type="number" class="form-control taxrate_0" name="taxrate_' + i + '" id="taxrate_' + i + '" onkeyup="taxrate(\'taxrate_' + i + '\');">' +
                '</td>' +

                '<td>' +
                '<input type="text" class="form-control taxamt" name="taxamt_' + i + '" id="taxamt_' + i + '" readonly>' +
                '</td>' +

                '<td>' +
                '<input type="text" class="form-control totalamt" name="total_' + i + '" id="total_' + i + '" readonly>' +
                '</td>' +

                '<td class="add-remove text-end">' +
                '<a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus"></i></a> ' +
                '<a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>' +
                '</td>' +
                '</tr>';
            i++;
            $(".add-table-items").append(experiencecontent);

            // Initialize autocomplete for the new row
            initializeAutocompleteForRow(i - 1);
            return false;
        });

        // Function to initialize autocomplete for all rows
        // Function to initialize autocomplete for all rows
function initializeAutocompleteForRow(index) {
    purchasegetitemscodedetails(`itemcode_${index}`, `item_${index}`, `qty_${index}`, `rate_${index}`, `hsn_${index}`, `sac_${index}`, `uom_${index}`, `discount_${index}`, `taxrate_${index}`, `itemcode_${index}`, `taxamt_${index}`);
    purchasegetitemsdetails(`itemcode_${index}`, `item_${index}`, `qty_${index}`, `rate_${index}`, `hsn_${index}`, `sac_${index}`, `uom_${index}`, `discount_${index}`, `taxrate_${index}`, `itemcode_${index}`, `taxamt_${index}`);
}

        // Initialize autocomplete for the first row and existing rows
        $(".add-table-items .add-row").each(function (index) {
            initializeAutocompleteForRow(index);
        });
    });

    function purchasegetitemscodedetails(inputname, item, qty, rate, hsn, sac, uom, discount, taxrate, itemcode, taxamt) {
    $('#' + inputname).autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "{% url 'purchasegetitemscodedetails' %}",
                dataType: "json",
                type: "POST",
                data: {
                    name_startsWith: request.term,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (data) {
                    if (data.length === 0) {
                        // Return no-results item
                        response([{ label: "No results found", value: "", noSelect: true }]);
                    } else {
                        // Normal mapping of results
                        response($.map(data, function (item) {
                            var code = item.split("|");
                            return {
                                label: code[0],
                                value: code[0],
                                data: item
                            }
                        }));
                    }
                }
            });
        },
        autoFocus: true,
        minLength: 1,
        select: function (event, ui) {
            // Prevent selection of no-results item
            if (ui.item.noSelect) {
                return false;
            }
            var names = ui.item.data.split("|");
            $('#' + inputname).val(names[0]); // item_code
            $('#' + qty).val(1); // qty
            $('#' + rate).val(names[5]); // purchase_rate
            $('#' + hsn).val(names[2]); // hsn
            $('#' + sac).val(names[6]); // sku
            $('#' + discount).val(names[4]); // default_discount
            $('#' + taxrate).val(0.0); // taxrate
            $('#' + uom).val(names[7] || ''); // units
            $('#' + item).val(names[1]); // inventory_name
            $('#' + taxamt).val(0.0); // taxamt (set to 0.0 as it's calculated later)

            discountamt(inputname);
            subtotal();
            totaltaxamt();
            getbillamt();
        },
        // Optional: Add open event to apply CSS class to no-results item
        open: function(event, ui) {
            $('.ui-menu-item').has(':contains("No results found")').addClass('ui-menu-item-no-results');
        }
    });

}

function purchasegetitemsdetails(inputname, item, qty, rate, hsn, sac, uom, discount, taxrate, itemcode, taxamt) {
    $('#' + item).autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "{% url 'purchasegetitemscodedetails' %}",
                dataType: "json",
                type: "POST",
                data: {
                    description_startsWith: request.term,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (data) {
                    if (data.length === 0) {
                        // Return no-results item
                        response([{ label: "No results found", value: "", noSelect: true }]);
                    } else {
                        // Normal mapping of results
                        response($.map(data, function (item) {
                            var code = item.split("|");
                            return {
                                label: code[1], // Display inventory_name
                                value: code[1], // Set the input field value to inventory_name
                                data: item
                            }
                        }));
                    }
                }
            });
        },
        autoFocus: true,
        minLength: 1,
        select: function (event, ui) {
            // Prevent selection of no-results item
            if (ui.item.noSelect) {
                return false;
            }
            var names = ui.item.data.split("|");
            $('#' + inputname).val(names[0]); // item_code
            $('#' + qty).val(1); // qty
            $('#' + rate).val(names[5]); // purchase_rate
            $('#' + hsn).val(names[2]); // hsn
            $('#' + sac).val(names[6]); // sku
            $('#' + discount).val(names[4]); // default_discount
            $('#' + taxrate).val(0.0); // taxrate
            $('#' + uom).val(names[7] || ''); // units
            $('#' + item).val(names[1]); // inventory_name
            $('#' + taxamt).val(0.0); // taxamt (set to 0.0 as it's calculated later)

            discountamt(inputname);
            subtotal();
            totaltaxamt();
            getbillamt();
        },
        // Optional: Add open event to apply CSS class to no-results item
        open: function(event, ui) {
            $('.ui-menu-item').has(':contains("No results found")').addClass('ui-menu-item-no-results');
        }
    });
}
</script>

<script type="text/javascript">
 


    function discountamt(inputname) {
        //alert(inputname);
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);

        var rate = $('#rate_' + id_val).val();
        var discount = $('#discount_' + id_val).val();
        var qty = $('#qty_' + id_val).val();

      

        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            //t = $('#total_'+id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt()
    }

    function taxrate(inputname) {
        //alert(inputname);
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);

        var rate = $('#rate_' + id_val).val();
        var discount = $('#discount_' + id_val).val();
        var qty = $('#qty_' + id_val).val();

      
        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
            var total = rate - (rate * discount / 100);
            //alert(totalamt);

            var totalamt = total * qty;
            //alert(totalamt);

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
            var total = rate - (rate * discount / 100);
            //alert(totalamt);

            var totalamt = total * qty;
            //alert(totalamt);

            //t = $('#total_'+id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt();

        totaltaxamt()
    }

   
    function totaltaxamt() {
        place_of_supply = $('#place_of_supply').val();

        taxrate_0 = $('#taxrate_0').val();
        //alert(taxrate_0);

        taxrate = taxrate_0 / 2;

        if (place_of_supply == 'MAHARASHTRA') {
            var sum1 = 0;
            $(".totaltaxamt").each(function () {
                sum1 += +this.value;
            });

            taxamt = sum1 / 2;

            $('#cgst').val(taxamt);
            $('#sgst').val(taxamt);
            $('#igst').val("0.00");

            $('#cgstper').val(taxrate + '%');
            $('#sgstper').val(taxrate + '%');
            $('#igstper').val("0%");
        }
        else {
            var sum1 = 0.0;
            $(".totaltaxamt").each(function () {
                sum1 += +this.value;
            });

            taxamt = sum1 / 2;

            $('#cgst').val("0.00");
            $('#sgst').val("0.00");
            $('#igst').val(parseFloat(sum1).toFixed(2));
      

            $('#cgstper').val("0%");
            $('#sgstper').val("0%");
            $('#igstper').val(taxrate_0 + '%');
        }

    }

    function qty(inputname) {
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);

        var rate = $('#rate_' + id_val).val();
        var qty = $('#qty_' + id_val).val();
        var discount = $('#discount_' + id_val).val();


        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
            //var discountamt = rate/100;
            //var total = rate-discountamt;
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
            //var discountamt = rate/100;
            //var total = rate-discountamt;
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            //t = $('#total_'+id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt();

        totaltaxamt();
    }

    function rate(inputname) {
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);

        var rate = $('#rate_' + id_val).val();
        var qty = $('#qty_' + id_val).val();
        var discount = $('#discount_' + id_val).val();


        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
            //var discountamt = rate/100;
            //var total = rate-discountamt;
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
            //var discountamt = rate/100;
            //var total = rate-discountamt;
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            //t = $('#total_'+id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt();

        totaltaxamt();
    }

   
  
function subtotal() {
    var freight = parseFloat($('#freight').val()) || 0;
    var totalamt = 0;



    $(".totalamt").each(function () {
        totalamt += parseFloat(this.value) || 0;
    });

    sub_total = freight + totalamt;
    $('.subtotal').val(sub_total.toFixed(2) || '0.00');

    var taxrate = parseFloat($('#taxrate_0').val()) || 0;
    gst_amount = (sub_total * taxrate) / 100;

    $('.totaltaxamt').val(gst_amount.toFixed(2) || '0.00');

    var sum1 = 0;
    $(".taxamt").each(function () {
        sum1 += parseFloat(this.value) || 0;
    });

    finalamt = totalamt + sum1;
    $('.finalamt').val(finalamt.toFixed(2) || '0.00');
}

    function getbillamt() {
        var sum = 0;
        $(".billamt").each(function () {
            sum += +this.value;
        });
        //alert(sum);

        $('.finalamt').val((sum).toFixed(2));
    }

    $(document).on('change', '#item_rate', function () {
        var item_rate = $(this).val();
        //alert(item_rate);

        for (var i = 0; i < 2; i++) {
            //alert(i);

            if (item_rate == 'tax_inclusive') {
                qty('qty_' + i);
                rate('rate_' + i);
                discountamt('discount_' + i);
            }

            if (item_rate == 'tax_exclusive') {
                qty('qty_' + i);
                rate('rate_' + i);
                discountamt('discount_' + i);
            }
        }


    });

    $(document).on('keyup', '#freight', function () {
        subtotal();

        totaltaxamt();
        getbillamt();
    });
</script>


<script type="text/javascript">
    $(document).on('change', '#vendor_name', function () {
        if ($(this).val() != 'none') {
            var vendor_id = $(this).val();

            $.ajax({
                type: 'POST',
                url: '#',
                data: { vendor_id: vendor_id },
                dataType: 'json',
                success: function (response) {
                    $('#vendor_code').val(response.vendor_code);
                }
            })
        }
    });
</script>

<script>
    $(document).on("mouseenter", ".item-input", function () {
  var currentValue = $(this).val();
  $(this).attr("title", currentValue);
});</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('order_date');
 
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
        const year = today.getFullYear();
        const formattedDate = `${day}-${month}-${year}`;
        dateInput.value = formattedDate;
 
    });
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.js"></script>

<script src="https://olatechs.in/crm/supreeno/assets/js/malsup-jquery.js"></script>

<script type="text/javascript">
    $(document).on('change', '#customer_name', function () {
        $('#customer_address').empty();
        if ($(this).val() != 'none') {
            var customer_id = $(this).val();
            $.ajax({
                type: 'POST',
                url: '#',
                data: { customer_id: customer_id },
                dataType: 'json',
                success: function (response) {
                    $('#customer_address').val(response['billing_attention'] + ', ' + response['billing_street'] + ', ' + response['billing_city'] + ', ' + response['billing_state'] + ', ' + response['billing_pincode']);
                    $('#gst_no').val(response.gst_no);
                }
            })
        }
        else {
            $("#customer_address").empty();
        }
    });
</script>



<script>
    // Function to validate email
    function isValidEmail(email) {
       var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
       return emailPattern.test(email);
    }
 
    // Function to validate email and show/hide error message
    function validateEmail() {
       var emailInput = document.getElementById('id_email').value;
       var emailErrorMessage = document.getElementById('email-error-message');
 
       // Check if the email is valid
       var isValid = isValidEmail(emailInput);
 
       // Display or hide the error message based on validation result
       if (emailInput.trim() === '' || !isValid) {
          emailErrorMessage.style.display = 'inline';
       } else {
          emailErrorMessage.style.display = 'none';
       }
    }
 
    // Add an event listener for blur event (when the user leaves the input field)
    var emailInputField = document.getElementById('id_email');
    if (emailInputField) {
       emailInputField.addEventListener('blur', validateEmail);
    }
 </script>
 
 <script>
    document.addEventListener("DOMContentLoaded", function () {
     const gstNoInput = document.getElementById("gst_no_input");
     const gstError = document.getElementById("gstError");
 
     function validateGSTNo(gstNoValue) {
         if (gstNoValue.trim() === '') {
             return true;  // Allow empty value
         }
 
         const gstNoRegex = /^([0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[Z]{1}[0-9A-Z]{1})$/;
         return gstNoRegex.test(gstNoValue);
     }
 
     gstNoInput.addEventListener("input", function () {
         const gstNoValue = this.value;
 
         if (!validateGSTNo(gstNoValue)) {
             gstError.textContent = "Enter a valid GST number (e.g., 12ABCDE1234F1Z5).";
         } else {
             gstError.textContent = "";
         }
     });
 });
 
 </script>

<script type="text/javascript">
    var input = document.getElementById("freight");
    input.addEventListener("keyup", function () {
        subtotal();
    });
</script>


<script>
    $(document).on("mouseenter", ".item-input", function () {
  var currentValue = $(this).val();
  $(this).attr("title", currentValue);
});</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('invoice_date');
 
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
        const year = today.getFullYear();
        const formattedDate = `${day}-${month}-${year}`;
        dateInput.value = formattedDate;
 
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const gstNoInput = document.getElementById("gst_no_input");
        const gstError = document.getElementById("gstError");
        const form = document.getElementById("invoice_form");

        // List of valid Indian state codes for GST (01-38 as per 2025 rules)
        const validStateCodes = [
            "01", "02", "03", "04", "05", "06", "07", "08", "09", "10",
            "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
            "21", "22", "23", "24", "25", "26", "27", "28", "29", "30",
            "31", "32", "33", "34", "35", "36", "37", "38"
        ];

        function validateGSTNo(gstNoValue) {
            if (gstNoValue.trim() === '') {
                return { valid: false, message: "GST number is required." };
            }

            // Convert to uppercase and remove spaces
            gstNoValue = gstNoValue.toUpperCase().replace(/\s/g, '');

            // Basic length and format check (15 chars: 2 digits + 10 PAN-like + 1 entity + Z + 1 checksum)
            const gstNoRegex = /^([0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1})$/;
            if (!gstNoRegex.test(gstNoValue)) {
                return { valid: false, message: "Invalid GST format. Expected: 12ABCDE1234F1Z5 (15 chars, ends with Z)" };
            }

            // Validate state code (positions 1-2)
            const stateCode = gstNoValue.substring(0, 2);
            if (!validStateCodes.includes(stateCode)) {
                return { valid: false, message: "Invalid state code (must be 01-38)." };
            }

            // Validate PAN part (positions 3-12: 5 letters + 4 digits + 1 letter)
            const pan = gstNoValue.substring(2, 12);
            const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
            if (!panRegex.test(pan)) {
                return { valid: false, message: "Invalid PAN format in GST number." };
            }

            // Validate entity code (position 13: 1-9 or A-Z)
            const entityCode = gstNoValue.charAt(12);
            if (!/[1-9A-Z]/.test(entityCode)) {
                return { valid: false, message: "Invalid entity code (position 13: 1-9 or A-Z)." };
            }

            // Position 14 must be 'Z'
            if (gstNoValue.charAt(13) !== 'Z') {
                return { valid: false, message: "14th character must be 'Z'." };
            }

            // Checksum (position 15: 0-9 or A-Z)
            const checksum = gstNoValue.charAt(14);
            if (!/[0-9A-Z]/.test(checksum)) {
                return { valid: false, message: "Invalid checksum (position 15: 0-9 or A-Z)." };
            }

            // Optional: Basic checksum validation (modulo 36 algorithm - simplified)
            // Full implementation can be added if needed, but format check suffices for client-side
            return { valid: true, message: "" };
        }

        // Real-time validation on input
        gstNoInput.addEventListener("input", function () {
            const gstNoValue = this.value;
            const validation = validateGSTNo(gstNoValue);
            gstError.textContent = validation.message;
            gstError.style.display = validation.valid ? "none" : "block";
            if (validation.valid) {
                this.setCustomValidity(''); // Clear browser validation
            } else {
                this.setCustomValidity(validation.message);
            }
        });

        // Form submission validation (prevents submit if invalid)
        form.addEventListener("submit", function (event) {
            const gstNoValue = gstNoInput.value;
            const validation = validateGSTNo(gstNoValue);
            if (!validation.valid) {
                event.preventDefault();
                gstError.textContent = validation.message;
                gstError.style.display = "block";
                gstNoInput.focus();
                // Optional: Show toast/alert for better UX
            }
        });
    });
</script>





<script>
$(document).ready(function () {
    // Initialize datepickers
    $('.datetimepicker').datepicker({
        dateFormat: 'dd-mm-yy',
        minDate: -365
    });

    // Set default dates
    const today = new Date();
    const formattedDate = `${('0' + today.getDate()).slice(-2)}-${('0' + (today.getMonth() + 1)).slice(-2)}-${today.getFullYear()}`;
    $('#sales_order_date, #buyer_order_date, #due_date').val(formattedDate);

    // Form validation
    $('#invoice_form').validate({
        rules: {
            invoice_no: "required",
            dispatch_date: "required",
            customer_Name_id: "required",
            challan_type: "required",
            payment_term: "required",
            so_date: "required",
            place_of_supply: "required",
            destination: "required",
            contact_person_name: "required",
            transporter_name: "required",
            invoice_type: "required",
            delivery_type: "required",
            buyer_order_no: "required",
            buyer_date: "required",
            gst_option: "required",
            'qty_0': "required",
            'rate_0': "required",
            'taxrate_0': "required"
        },
        messages: {
            dispatch_date: "Dispatch Date is required",
            invoice_no: "Invoice Number is required",
            customer_Name_id: "Customer is required",
            challan_type: "Challan is required",
            payment_term: "Payment Term is required",
            so_date: "Sales Order Date is required",
            place_of_supply: "Place of Supply is required",
            destination: "Destination is required",
            contact_person_name: "Contact Person is required",
            transporter_name: "Dispatch Through is required",
            invoice_type: "Invoice Type is required",
            delivery_type: "Delivery Type is required",
            buyer_order_no: "Buyer Order No is required",
            buyer_date: "Buyer Order Date is required",
            gst_option: "GST option is required",
            'qty_0': "Quantity is required",
            'rate_0': "Unit Price is required",
            'taxrate_0': "Tax Rate is required"
        },
        highlight: function(element) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function(element) {
            $(element).removeClass('is-invalid');
        },
        errorElement: 'span',
        errorClass: 'invalid-feedback',
        errorPlacement: function(error, element) {
            if (element.is('select')) {
                error.insertAfter(element.closest('.form-group'));
            } else {
                error.insertAfter(element);
            }
        },
        invalidHandler: function(event, validator) {
            var errors = validator.numberOfInvalids();
            if (errors) {
                $("html, body").animate({
                    scrollTop: $(validator.errorList[0].element).offset().top - 100
                }, 500);
            }
        },
        submitHandler: function(form) {
            var email = $('#contact_person_email').val();
            if (email && email.toLowerCase() !== 'na' && email.toLowerCase() !== 'nan' && !isValidEmail(email)) {
                alert('Invalid email address.');
                return false;
            }
            form.submit();
        }
    });

});
</script>

{% endblock custom_js %}

{% endblock main_content %}