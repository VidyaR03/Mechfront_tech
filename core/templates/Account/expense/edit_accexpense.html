{% extends 'dashboard/base_template.html' %}
{% block title %}
crm
{% endblock %}

{% block custom_css %}

<style>
    /* Inactive tab styles */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link {
        color: #ccc;
        /* Faint gray color for inactive tabs */
    }

    /* Active tab style */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link.active {
        color: #000;
        /* Black color for active tab */
    }
</style>
{% endblock custom_css %}

{% block main_content %}
<div class="page-wrapper" style="min-height: 415px;">
    <div class="content container-fluid">
        <div class="page-header invoices-page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title"> <a href="{% url 'accexpense_list'%}" style="margin-right: 10px;"><i class="fa fa-arrow-left"
                                data-bs-toggle="tooltip" title="" data-bs-original-title="Back"
                                aria-label="fa fa-arrow-left"></i></a> Update Expense</h3>
                </div>
                <div class="col-auto"> </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card invoices-add-card">
                    <div class="card-body">
                        <form class="invoices-form" method="post" id="quotation_form"
                            action="{% url 'edit_accexpense' id=account_expense_data.id %}" enctype="multipart/form-data"
                            autocomplete="off">
                            {% csrf_token %}
                            <input type="hidden" name="quotation_id" id="quotation_id" value="347">
                            <div class="invoices-main-form">
                                <div class="row">
                                    <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <div class=" ">
                                                <span>
                                                    <label>Invoice Date</label>
                                                    <input class="form-control datetimepicker" type="text"
                                                        name="invoice_date" id="invoice_date"
                                                        value="{{account_expense_data.ae_invoice_date|date:'d-m-Y'}}" required>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                

                                           
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>GST No.</label>
                                            <input type="text" class="form-control" name="ae_gst_number" id="gst_no_input"  value="{{account_expense_data.ae_gst_number}}" placeholder="GST No.">
                                            <span id="gstError" style="color: red;"></span>

                                        </div>
                                    </div>

                                    <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Vendor Name</label>
                                            <div data-select2-id="4">
                                                <div data-select2-id="4">
                                                    <select id="vendor_Name" name="vendor_Name"
                                                        class="form-select" required>
                                                        <option value="{{account_expense_data.ae_vendor_name.id}}" selected  hidden>{{account_expense_data.ae_vendor_name.company_name}}</option>
                                                        {% for i in all_vendor_name %}
                                                        <option value="{{i.id}}">{{i.company_name}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight</label>
                                            <input type="number" class="form-control" name="freight" id="freight"
                                                value="{{account_expense_data.ae_freight}}">

                                                <input type="hidden" class="form-control" name="ae_due_amount" id="ae_due_amount"
                                                value="{{account_expense_data.ae_due_amount}}">
                                        </div>
                                    </div>
                                    <div class="col-xl-2 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Invoice No</label>
                                            <input type="text" class="form-control" name="ae_invoice_no" id="ae_invoice_no" value="{{account_expense_data.ae_invoice_no}}">
                                        </div>
                                    </div>
                                  

                                    <div class="col-md-3">
                                        <div class="form-group">
                                        <label>Cost Centre</label>
                                           <select class="form-select" name="ae_cost_center" id="ae_cost_center                                               " required>                                               
                                            <option value="ae_cost_center">{{account_expense_data.ae_cost_center}}</option>
                                            <option value="Office Cleaning">Office Cleaning</option>
                                            <option value="Electricity Bill">Electricity Bill</option>
                                            <option value="Rent">Rent</option>
                                            <option value="Drinking Water">Drinking Water</option>
                                            <option value="Consultancy Charges">Consultancy Charges</option>
                                            <option value="Software Design">Software Design</option>
                                            <option value="Repair And Maintenance">Repair And Maintenance</option>
                                            <option value="Other Expenses">Other Expenses</option>
                                            <option value="Transport">Transport</option>
                                            <option value="Loading &amp; Unloading Wages">Loading &amp; Unloading Wages</option>
                                            <option value="Canteen">Canteen</option>
                                            <option value="Freight and Other Charges">Freight and Other Charges</option>
                                                
                                         </select>
                                        </div>
                                     </div>
                                    <!-- <div class="col-lg-2">
                                        <label >Upload File <span style="color: red;"></span></label>
                                        <div class="form-group">
                                            <input type="file" class="form-control" name="ae_upload_file" accept="acc_expence/*" required>
                                           
                                     </div>
                                                                   
                                     {% if form.ae_upload_file %}
                                     <img src="{{ form.ae_upload_file.url }}" alt="Upload File" style="width: 100px;">
                                 {% endif %}
                                    </div> -->

                                    <div class="col-md-3">
                                       
                                        <label >Upload File <span style="color: red;"></span></label>
                                        <div class="form-group">
                                            <input type="file" class="form-control" name="ae_upload_file" accept="acc_expence/*" >
                                           
                                            {% if account_expense_data.ae_upload_file %}
                                            <img src="{{account_expense_data.ae_upload_file.url}}" alt="Upload File" style="width: 100px;">
                                        {% endif %}
                                     </div>


                                      

                                 
                                </div>
                                    <div class="col-lg-2" style="visibility: hidden;">
                                        <div class="form-group">
                                            <label>Item Rates Are </label>
                                            <select class="form-control" name="item_rate" id="item_rate">
                                                <option value="tax_exclusive" selected="">Tax Exclusive</option>
                                                <option value="tax_inclusive">Tax Inclusive </option>
                                            </select>
                                        </div>
                                    </div>


                                    <div class="rowbb">
                                        <div class="invoice-add-table">
                                            <div class="table-responsive">
                                                <table class="table table-center add-table-items">
                                                    <thead>
                                                        <tr>
                                                            <th></th>
                                                            <th>Item Code</th>
                                                            <th width="180px">Description of Goods</th>
                                                            <th>HSN</th>
                                                            <th>Qty</th>
                                                            <th>UOM</th>
                                                            <th>Unit Price</th>
                                                            <th>Disc(%)</th>
                                                            <th>Tax Rate</th>
                                                            <th>Tax Amt</th>
                                                            <th>Total</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for j in account_expense_item_data %}
                                                        <tr class="add-row">
                                                            <td><input type="hidden" name="iid[]" class="iid" value="{{len_quotation_item}}">
                                                            </td>

                                                            <td><input type="text" class="form-control"
                                                                    name="itemcode_{{ forloop.counter }}"
                                                                    id="itemcode_{{ forloop.counter }}"
                                                                    value="{{j.ae_item_code}}"
                                                                    onkeyup="purchasegetitemscodedetails('itemcode_{{ forloop.counter }}','item_{{ forloop.counter }}','godown_{{ forloop.counter }}','qty_{{ forloop.counter }}','rate_{{ forloop.counter }}','hsn_{{ forloop.counter }}','uom_{{ forloop.counter }}','discount_{{ forloop.counter }}','taxrate_{{ forloop.counter }}');">
                                                            </td>

                                                            <td><input type="text" class="form-control item-input"
                                                                    name="item_{{ forloop.counter }}"
                                                                    id="item_{{ forloop.counter }}"
                                                                    onkeyup="purchasegetitemsdetails('item_{{ forloop.counter }}','godown_{{ forloop.counter }}','qty_{{ forloop.counter }}','rate_{{ forloop.counter }}','hsn_{{ forloop.counter }}','uom_{{ forloop.counter }}','discount_{{ forloop.counter }}','taxrate_{{ forloop.counter }}','itemcode_{{ forloop.counter }}');"
                                                                    value="{{j.ae_description_goods}}" placeholder=" ">
                                                            </td>

                                                            <td><input type="text" class="form-control"
                                                                    name="hsn_{{ forloop.counter }}"
                                                                    id="hsn_{{ forloop.counter }}" value="{{j.ae_hsn}}">
                                                            </td>

                                                            <td><input type="number" class="form-control"
                                                                    step="0.01" name="qty_{{ forloop.counter }}"
                                                                    id="qty_{{ forloop.counter }}"
                                                                    value="{{j.ae_qantity}}"
                                                                    onkeyup="qty('qty_{{ forloop.counter }}')"> </td>

                                                            <td><input type="text" class="form-control"
                                                                    name="uom_{{ forloop.counter }}"
                                                                    id="uom_{{ forloop.counter }}" value="{{j.ae_uom}}">
                                                            </td>

                                                            <td><input type="number" step="0.001" class="form-control"
                                                                    step="0.01" name="rate_{{ forloop.counter }}"
                                                                    id="rate_{{ forloop.counter }}"
                                                                    value="{{j.ae_unit_price}}"
                                                                    onkeyup="rate('rate_{{ forloop.counter }}')"></td>

                                                            <td><input type="number" class="form-control"
                                                                    step="0.01" name="discount_{{ forloop.counter }}"
                                                                    id="discount_{{ forloop.counter }}"
                                                                    value="{{j.ae_discount}}"
                                                                    onkeyup="discountamt('discount_{{ forloop.counter }}')">
                                                            </td>

                                                            <td><input type="number" class="form-control"
                                                                    name="taxrate_{{ forloop.counter }}"
                                                                    id="taxrate_{{ forloop.counter }}"
                                                                    value="{{j.ae_tax_rate}}" step="0.001"
                                                                    onkeyup="rate('taxrate_{{ forloop.counter }}')">
                                                            </td>

                                                            <td><input type="text" class="form-control taxamt"
                                                                    name="taxamt_{{ forloop.counter }}"
                                                                    id="taxamt_{{ forloop.counter }}"
                                                                    value="{{j.ae_tax_amount}}" readonly></td>

                                                            <td><input type="text" class="form-control totalamt"
                                                                    name="total_{{ forloop.counter }}"
                                                                    id="total_{{ forloop.counter }}"
                                                                    value="{{j.ae_total}}" readonly> </td>

                                                            <td class="add-remove text-end">
                                                                <a href="javascript:void(0);" class="add-btn me-2"><i
                                                                        class="fas fa-plus"></i></a>

                                                                <a href="javascript:void(0);" class="remove-btn "><i
                                                                        class="fe fe-trash-2"></i></a>
                                                            </td>
                                                        </tr>
                                                        <input type="hidden" id="i_field" value="{{len_quotation_item}}">
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-7 col-md-6">
                                                <!-- <div class="form-group float-end mb-0"> <button class="btn btn-primary" type="submit">Add Item</button> </div> -->
                                                <div class="invoice-fields">
                                                    <h4 class="field-title">T&amp;C Note..</h4> <br> <textarea
                                                        class="form-control" name="note"style="min-height: 100px;" >{{account_expense_data.ae_note}}</textarea>
                                                </div>
                                            </div>
                                            <div class="col-lg-5 col-md-6">
                                                <div class="invoice-total-card">
                                                    <h4 class="invoice-total-title">Summary</h4>
                                                    <div class="invoice-total-box">
                                                        <div class="invoice-total-inner">
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>Sub Total</p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="subtotal billamt utrt1"
                                                                        name="subtotal" value="{{account_expense_data.ae_sub_total|floatformat:2}}" readonly="">
                                                                </div>
                                                            </div>

                                                            <!-- <div class="row">
                                                                <div class="col-lg-6"><p>Freight</p></div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text" name="freight" id="freight" value="0.00" onkeyup="getbillamt();" value="20.00">
                                                                </div>
                                                            </div> -->

                                                            <div class="row">
                                                                <!-- <div class="col-lg-6"><p>Tax Amt</p></div> -->
                                                                <div class="col-lg-6 ">
                                                                    <input type="hidden"
                                                                        class="totaltaxamt billamt utrt1"
                                                                        name="total_taxamt" id="total_taxamt" value=""
                                                                        readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>CGST @ <input type="text" name="cgstper"
                                                                            id="cgstper" value="0%" size="1"
                                                                            class="no-outline"></p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="utrt1" name="cgst"
                                                                        id="cgst" value="{{account_expense_data.ae_cgstval|floatformat:2}}" readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>SGST @ <input type="text" name="sgstper"
                                                                            id="sgstper" value="0%" size="1"
                                                                            class="no-outline"></p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="utrt1" name="sgst"
                                                                        id="sgst" value="{{account_expense_data.ae_sgstval|floatformat:2}}" readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>IGST @ <input type="text" name="igstper"
                                                                            id="igstper" value="{{account_expense_data.ae_igstper}}" size="1"
                                                                            class="no-outline"></p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input type="text" class="utrt1" name="igst"
                                                                        id="igst" value="{{account_expense_data.ae_igstval|floatformat:2}}" readonly="">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>Adjustments</p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text"
                                                                        name="adjustment" id="adjustment"
                                                                        onkeyup="getbillamt();" value="{{account_expense_data.ae_adjustment}}">
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>TCS on Sale Of any Goods </p>
                                                                </div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text"
                                                                        name="sale_of_good" id="sale_of_good"
                                                                        onkeyup="getbillamt();" value="{{account_expense_data.ae_sale_of_good}}">
                                                                </div>
                                                            </div>

                                                            <div class="invoice-total-footer">
                                                                <h4>Total Amount <input class="finalamt utrt1"
                                                                        type="text" name="totalamt" value="{{account_expense_data.all_total|floatformat:2}}"
                                                                        readonly=""></h4>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="upload-sign">
                                                        <div class="form-group float-end mb-0"> <a
                                                                href="{% url 'accexpense_list'%}"
                                                                class="btn btn-primary">Cancel</a></div>
                                                        <div class="form-group float-end mb-0"> <button
                                                                class="btn btn-primary" type="submit" id="btn_submit"
                                                                name="btn_submit">Save</button> </div>
                                                                <button type="reset" class="btn btn-outline-secondary me-1 btn-rounded">Reset</button>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row col-sm-6 p-5">
                                        <div class="success_message row"></div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        // Initialize counter with the value of `i_field` or set to 1 if not defined
        var i = $('#i_field').val() || 1;
        var max_fields = 500;
        var x = 1;
        function reindexRows() {
            var rowIndex = 1;
            $(".add-table-items .add-row").each(function () {
                $(this).find('.iid').val(rowIndex);
                $(this).find('input').each(function () {
                    var name = $(this).attr('name');
                    var id = $(this).attr('id');

                    // Update name and id by replacing the current index with rowIndex
                    if (name) {
                        name = name.replace(/_\d+$/, '_' + rowIndex);
                        $(this).attr('name', name);
                    }
                    if (id) {
                        id = id.replace(/_\d+$/, '_' + rowIndex);
                        $(this).attr('id', id);
                    }
                    var onkeyup = $(this).attr('onkeyup');
                if (onkeyup) {
                    onkeyup = onkeyup.replace(/_\d+/g, '_' + rowIndex); // Update all instances of _\d+ to the current rowIndex
                    $(this).attr('onkeyup', onkeyup);
                }
                });
                rowIndex++;
            });
            i = rowIndex;  // Update the global index `i` to the new row count
        }
        reindexRows();

        // Attach events for removing rows
        $(".add-table-items").on('click', '.remove-btn', function () {
            if ($('.add-row').length > 1) {
                $(this).closest('.add-row').remove();
                reindexRows();
                subtotal();
                getbillamt();
                totaltaxamt();
             
            } else {
                alert("At least one row must remain.");
            }
            return false;
        });

        // Attach events for adding new rows
        $(document).on("click", ".add-btn", function () {
            if (x < max_fields) {
                i++;
                x++;
                var rowContent = '<tr class="add-row">' +
                    '<td>' +
                    '<input type="hidden" name="iid[]" class="iid" value="' + i + '">' +
                    '</td>' +
              
                    '<td>' +
                    '<input type="text" class="form-control" name="itemcode_' + i + '" id="itemcode_' + i + '" onkeyup="purchasegetitemscodedetails(\'itemcode_' + i + '\',\'item_' + i + '\',\'qty_' + i + '\',\'rate_' + i + '\',\'hsn_' + i + '\',\'sac_' + i + '\',\'uom_' + i + '\',\'discount_' + i + '\',\'taxrate_' + i + '\'); ">' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" name="item_' + i + '" id="item_' + i + '" class="form-control item-input" onkeyup="purchasegetitemsdetails(\'itemcode_' + i + '\',\'item_' + i + '\',\'qty_' + i + '\',\'rate_' + i + '\',\'hsn_' + i + '\',\'sac_' + i + '\',\'uom_' + i + '\',\'discount_' + i + '\',\'taxrate_' + i + '\'); ">' +
                    '</td>' +
                 
                    '<td>' +
                    '<input type="text" class="form-control" name="hsn_' + i + '" id="hsn_' + i + '">' +
                    '</td>' +
                    '<td>' +
                    '<input type="number" class="form-control" step="0.01" name="qty_' + i + '" id="qty_' + i + '" onkeyup="qty(\'qty_' + i + '\');">' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" class="form-control" name="uom_' + i + '" id="uom_' + i + '">' +
                    '</td>' +
                    '<td>' +
                    '<input type="number"  step="0.001" class="form-control" step="0.01" name="rate_' + i + '" id="rate_' + i + '" onkeyup="rate(\'rate_' + i + '\');">' +
                    '</td>' +
                    '<td>' +
                    '<input type="number" class="form-control" step="0.01" name="discount_' + i + '" id="discount_' + i + '" onkeyup="discountamt(\'discount_' + i + '\');">' +
                    '</td>' +
                    '<td>' +
                    '<input type="number" class="form-control" step="0.001" name="taxrate_' + i + '" id="taxrate_' + i + '" onkeyup="rate(\'taxrate_' + i + '\');">' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" class="form-control taxamt" name="taxamt_' + i + '" id="taxamt_' + i + '" readonly>' +
                    '</td>' +
                    '<td>' +
                    '<input type="text" class="form-control totalamt" name="total_' + i + '" id="total_' + i + '" readonly>' +
                    '</td>' +
                    '<td class="add-remove text-end">' +
                    '<a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus"></i></a> ' +
                    '<a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>' +
                    '</td>' +
                    '</tr>';
                $(".add-table-items").append(rowContent);
                initializeAutocompleteForRow(i);
            }
            return false;
        });

        // Initialize autocomplete for pre-existing rows
        function initializeAutocompleteForRow(index) {
    purchasegetitemscodedetails(`itemcode_${index}`, `item_${index}`, `qty_${index}`, `rate_${index}`, `hsn_${index}`, `sac_${index}`, `uom_${index}`, `discount_${index}`, `taxrate_${index}`, `taxamt_${index}`);
    purchasegetitemsdetails(`itemcode_${index}`, `item_${index}`, `qty_${index}`, `rate_${index}`, `hsn_${index}`, `sac_${index}`, `uom_${index}`, `discount_${index}`, `taxrate_${index}`, `taxamt_${index}`);
}

        // Apply the function to all existing rows on page load
        for (var j = 1; j <= i; j++) {
            initializeAutocompleteForRow(j);
        }
    });

</script>


<script type="text/javascript">
    
function purchasegetitemscodedetails(inputname, item, qty, rate, hsn, sac, uom, discount, taxrate, taxamt) {
    $('#' + inputname).autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "{% url 'purchasegetitemscodedetails' %}",
                dataType: "json",
                type: "POST",
                data: {
                    name_startsWith: request.term,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (data) {
                    if (data.length === 0) {
                        response([{ label: "No results found", value: "", noSelect: true }]);
                    } else {
                        response($.map(data, function (item) {
                            var code = item.split("|");
                            return {
                                label: code[0],
                                value: code[0],
                                data: item
                            }
                        }));
                    }
                }
            });
        },
        autoFocus: true,
        minLength: 1,
        select: function (event, ui) {
            if (ui.item.noSelect) {
                return false;
            }
            var names = ui.item.data.split("|");
            $('#' + inputname).val(names[0]); // item_code
            $('#' + qty).val(1); // qty
            $('#' + rate).val(names[5]); // purchase_rate
            $('#' + hsn).val(names[2]); // hsn
            $('#' + sac).val(names[6]); // sku
            $('#' + discount).val(names[4]); // default_discount
            $('#' + taxrate).val(0.0); // taxrate
            $('#' + uom).val(names[7] || ''); // units
            $('#' + item).val(names[1]); // inventory_name
            $('#' + taxamt).val(0.0); // taxamt
            discountamt(inputname);
            subtotal();
            totaltaxamt();
            getbillamt();
        },
        open: function(event, ui) {
            $('.ui-menu-item').has(':contains("No results found")').addClass('ui-menu-item-no-results');
        }
    });
}

function purchasegetitemsdetails(inputname, item, qty, rate, hsn, sac, uom, discount, taxrate, taxamt) {
    $('#' + item).autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "{% url 'purchasegetitemscodedetails' %}",
                dataType: "json",
                type: "POST",
                data: {
                    description_startsWith: request.term,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (data) {
                    if (data.length === 0) {
                        response([{ label: "No results found", value: "", noSelect: true }]);
                    } else {
                        response($.map(data, function (item) {
                            var code = item.split("|");
                            return {
                                label: code[1],
                                value: code[1],
                                data: item
                            }
                        }));
                    }
                }
            });
        },
        autoFocus: true,
        minLength: 1,
        select: function (event, ui) {
            if (ui.item.noSelect) {
                return false;
            }
            var names = ui.item.data.split("|");
            $('#' + inputname).val(names[0]); // item_code
            $('#' + qty).val(1); // qty
            $('#' + rate).val(names[5]); // purchase_rate
            $('#' + hsn).val(names[2]); // hsn
            $('#' + sac).val(names[6]); // sku
            $('#' + discount).val(names[4]); // default_discount
            $('#' + taxrate).val(0.0); // taxrate
            $('#' + uom).val(names[7] || ''); // units
            $('#' + item).val(names[1]); // inventory_name
            $('#' + taxamt).val(0.0); // taxamt
            discountamt(inputname);
            subtotal();
            totaltaxamt();
            getbillamt();
        },
        open: function(event, ui) {
            $('.ui-menu-item').has(':contains("No results found")').addClass('ui-menu-item-no-results');
        }
    });
}    

    function discountamt(inputname) {
        //alert(inputname);
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);
        var rate = $('#rate_' + id_val).val();
        var discount = $('#discount_' + id_val).val();
        var qty = $('#qty_' + id_val).val();

        /*//var discountamt = rate/100;
        //var totalamt = rate-discountamt;
        var totalamt = rate-(rate*discount/100);
        $('#total_'+id_val).val(totalamt);

        var taxrate = $('#taxrate_'+id_val).val();
        var taxamt = totalamt*taxrate/100;
        //alert(taxamt);

        $('#taxamt_'+id_val).val((taxamt).toFixed(2));*/

        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
            var total = rate - (rate * discount / 100);
            //alert(totalamt);

            var totalamt = total * qty;
            //alert(totalamt);

            //t = $('#total_'+id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt()
    }

    function taxrate(inputname) {
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);

        var rate = $('#rate_' + id_val).val();
        var qty = $('#qty_' + id_val).val();
        var discount = $('#discount_' + id_val).val();


        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            // alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
            var total = rate - (rate * discount / 100);
            //alert(totalamt);

            var totalamt = total * qty;
            //alert(totalamt);

            //t = $('#total_'+id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            console.log("Vidys Madam",taxrate)
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt();

        totaltaxamt()
    }



    function totaltaxamt() {
        place_of_supply = $('#place_of_supply').val();
        const gst_number = $('#gst_number').val();
        const isMaharashtra = !gst_number || gst_number.startsWith("27");



        taxrate_0 = $('#taxrate_1').val();
        // alert(taxrate_0);

        taxrate = taxrate_0 / 2;

        if (place_of_supply == isMaharashtra) {
            var sum1 = 0;
            $(".totaltaxamt").each(function () {
                sum1 += +this.value;
            });

            taxamt = sum1 / 2;

            $('#cgst').val(taxamt);
            $('#sgst').val(taxamt);
            $('#igst').val("0.00");

            $('#cgstper').val(taxrate + '%');
            $('#sgstper').val(taxrate + '%');
            $('#igstper').val("0%");
        }
        else {
            var sum1 = 0;
            $(".totaltaxamt").each(function () {
                sum1 += +this.value;
            });

            taxamt = sum1 / 2;

            $('#cgst').val("0.00");
            $('#sgst').val("0.00");
            $('#igst').val(sum1);

            $('#cgstper').val("0%");
            $('#sgstper').val("0%");
            $('#igstper').val(taxrate_0 + '%');
        }

    }

    function qty(inputname) {
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);

        var rate = $('#rate_' + id_val).val();
        var qty = $('#qty_' + id_val).val();
        var discount = $('#discount_' + id_val).val();

     
        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
      
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
       

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
        
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
       

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt();


        totaltaxamt();
    }

    function rate(inputname) {
        input = inputname.split("_");
        id_val = input[1];
        //alert(id_val);

        var rate = $('#rate_' + id_val).val();
        var qty = $('#qty_' + id_val).val();
        var discount = $('#discount_' + id_val).val();

  
        var item_rate = $('#item_rate').val();

        if (item_rate == 'tax_exclusive') {
            //var discountamt = rate/100;
            //var total = rate-discountamt;
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            $('#total_' + id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));
        }

        if (item_rate == 'tax_inclusive') {
            //var discountamt = rate/100;
            //var total = rate-discountamt;
            var total = rate - (rate * discount / 100);
            //alert(total);
            var totalamt = total * qty;
            //alert(totalamt);

            //t = $('#total_'+id_val).val((totalamt).toFixed(2));

            var taxrate = $('#taxrate_' + id_val).val();
            var taxamt = totalamt * taxrate / 100;
            //alert(taxamt);

            $('#taxamt_' + id_val).val((taxamt).toFixed(2));

            t = totalamt - taxamt;

            $('#total_' + id_val).val((t).toFixed(2));
        }

        subtotal();

        getbillamt();

        totaltaxamt();
    }

    /*function subtotal()
    {
        var sum = 0;
        $(".totalamt").each(function()
        {
          sum += +this.value;
        });
        //alert(sum);

        $('.subtotal').val((sum).toFixed(2));
        //$('.finalamt').val(parseInt(sum));

        var sum1 = 0;
        $(".taxamt").each(function()
        {
          sum1 += +this.value;
        });

        $('.totaltaxamt').val(sum1);

        finalamt = sum+sum1;
        $('.finalamt').val(finalamt);
    }*/

    function subtotal() {
        var freight = $('#freight').val();
        // alert(freight);

        var totalamt = 0;
        $(".totalamt").each(function () {
            totalamt += +this.value;
        });
        //alert(totalamt);

        sub_total = parseInt(freight) + totalamt;

        $('.subtotal').val(sub_total);
        //$('.finalamt').val(parseInt(totalamt));

        taxrate = $('#taxrate_1').val();
        console.log("00000000000000000000000",taxrate)

        gst_amount = (sub_total * taxrate) / 100

        var sum1 = 0;
        $(".taxamt").each(function () {
            sum1 += +this.value;
        });

        $('.totaltaxamt').val(gst_amount);

        finalamt = totalamt + sum1;
        $('.finalamt').val(finalamt);
    }

    function getbillamt() {
        var sum = 0;
        $(".billamt").each(function () {
            sum += +this.value;
        });
        //alert(sum);

        $('.finalamt').val((sum).toFixed(2));
    }

    $(document).on('change', '#item_rate', function () {
        var item_rate = $(this).val();
        //alert(item_rate);

        for (var i = 0; i < 2; i++) {
            //alert(i);

            if (item_rate == 'tax_inclusive') {
                qty('qty_' + i);
                rate('rate_' + i);
                discountamt('discount_' + i);
            }

            if (item_rate == 'tax_exclusive') {
                qty('qty_' + i);
                rate('rate_' + i);
                discountamt('discount_' + i);
            }
        }


    });

    $(document).on('keyup', '#freight', function () {
        subtotal();
        totaltaxamt();
        getbillamt();
    });
</script>


<script>
    // Function to validate email
    function isValidEmail(email) {
       var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
       return emailPattern.test(email);
    }
 
    // Function to validate email and show/hide error message
    function validateEmail() {
       var emailInput = document.getElementById('id_email').value;
       var emailErrorMessage = document.getElementById('email-error-message');
 
       // Check if the email is valid
       var isValid = isValidEmail(emailInput);
 
       // Display or hide the error message based on validation result
       if (emailInput.trim() === '' || !isValid) {
          emailErrorMessage.style.display = 'inline';
       } else {
          emailErrorMessage.style.display = 'none';
       }
    }
 
    // Add an event listener for blur event (when the user leaves the input field)
    var emailInputField = document.getElementById('id_email');
    if (emailInputField) {
       emailInputField.addEventListener('blur', validateEmail);
    }
 </script>
 
 <script>
    document.addEventListener("DOMContentLoaded", function () {
     const gstNoInput = document.getElementById("gst_no_input");
     const gstError = document.getElementById("gstError");
 
     function validateGSTNo(gstNoValue) {
         if (gstNoValue.trim() === '') {
             return true;  // Allow empty value
         }
 
         const gstNoRegex = /^([0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[Z]{1}[0-9A-Z]{1})$/;
         return gstNoRegex.test(gstNoValue);
     }
 
     gstNoInput.addEventListener("input", function () {
         const gstNoValue = this.value;
 
         if (!validateGSTNo(gstNoValue)) {
             gstError.textContent = "Enter a valid GST number (e.g., 12ABCDE1234F1Z5).";
         } else {
             gstError.textContent = "";
         }
     });
 });
 
 </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.js"></script>

<script src="https://olatechs.in/crm/supreeno/assets/js/malsup-jquery.js"></script>

<script>
    $(document).on("mouseenter", ".item-input", function () {
  var currentValue = $(this).val();
  $(this).attr("title", currentValue);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const gstNoInput = document.getElementById("gst_no_input");
    const gstError = document.getElementById("gstError");
    const form = document.getElementById("quotation_form"); // Use correct form ID

    // List of valid Indian state codes for GST (01-38)
    const validStateCodes = [
        "01", "02", "03", "04", "05", "06", "07", "08", "09", "10",
        "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
        "21", "22", "23", "24", "25", "26", "27", "28", "29", "30",
        "31", "32", "33", "34", "35", "36", "37", "38"
    ];

    function validateGSTNo(gstNoValue) {
        if (gstNoValue.trim() === '') {
            return { valid: false, message: "GST number is required." };
        }

        // Convert to uppercase and remove spaces
        gstNoValue = gstNoValue.toUpperCase().replace(/\s/g, '');

        // Basic length and format check (15 chars: 2 digits + 10 PAN-like + 1 entity + Z + 1 checksum)
        const gstNoRegex = /^([0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1})$/;
        if (!gstNoRegex.test(gstNoValue)) {
            return { valid: false, message: "Invalid GST format. Expected: 12ABCDE1234F1Z5 (15 chars, ends with Z)" };
        }

        // Validate state code (positions 1-2)
        const stateCode = gstNoValue.substring(0, 2);
        if (!validStateCodes.includes(stateCode)) {
            return { valid: false, message: "Invalid state code (must be 01-38)." };
        }

        // Validate PAN part (positions 3-12: 5 letters + 4 digits + 1 letter)
        const pan = gstNoValue.substring(2, 12);
        const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
        if (!panRegex.test(pan)) {
            return { valid: false, message: "Invalid PAN format in GST number." };
        }

        // Validate entity code (position 13: 1-9 or A-Z)
        const entityCode = gstNoValue.charAt(12);
        if (!/[1-9A-Z]/.test(entityCode)) {
            return { valid: false, message: "Invalid entity code (position 13: 1-9 or A-Z)." };
        }

        // Position 14 must be 'Z'
        if (gstNoValue.charAt(13) !== 'Z') {
            return { valid: false, message: "14th character must be 'Z'." };
        }

        // Checksum (position 15: 0-9 or A-Z)
        const checksum = gstNoValue.charAt(14);
        if (!/[0-9A-Z]/.test(checksum)) {
            return { valid: false, message: "Invalid checksum (position 15: 0-9 or A-Z)." };
        }

        return { valid: true, message: "" };
    }

    // Real-time validation on input
    gstNoInput.addEventListener("input", function () {
        const gstNoValue = this.value;
        const validation = validateGSTNo(gstNoValue);
        gstError.textContent = validation.message;
        gstError.style.display = validation.valid ? "none" : "block";
        if (validation.valid) {
            this.setCustomValidity(''); // Clear browser validation
        } else {
            this.setCustomValidity(validation.message);
        }
    });

    // Form submission validation (prevents submit if invalid)
    form.addEventListener("submit", function (event) {
        const gstNoValue = gstNoInput.value;
        const validation = validateGSTNo(gstNoValue);
        if (!validation.valid) {
            event.preventDefault();
            event.stopPropagation();
            gstError.textContent = validation.message;
            gstError.style.display = "block";
            gstNoInput.focus();
            gstNoInput.style.borderColor = "red"; // Visual feedback
            setTimeout(() => {
                gstNoInput.style.borderColor = ""; // Reset after 3 seconds
            }, 3000);
            alert("Please enter a valid GST number before submitting.");
            return false;
        }
    });

    // Optional: Validate on blur (when user leaves the field)
    gstNoInput.addEventListener("blur", function () {
        const gstNoValue = this.value;
        const validation = validateGSTNo(gstNoValue);
        if (!validation.valid) {
            this.setCustomValidity(validation.message);
        } else {
            this.setCustomValidity('');
        }
    });
});
</script>

{% endblock main_content %}