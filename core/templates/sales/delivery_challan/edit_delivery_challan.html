{% extends 'dashboard/base_template.html' %}
{% block custom_css %}
{% block page_title %}
{% endblock page_title %}
<style>
    .custom-error {
        max-width: 300px;
        /* Adjust the width to your desired value */
        margin: 0 auto;
        /* Add this line to center the element */
        text-align: center;
        /* Add this line to center the text inside the element */
    }

    .input-group-text {
        cursor: pointer;
    }

    .grey-card {
        background-color: LightGray;
    }

    .negative-padding {
        margin-top: -60px;
    }
</style>
{% endblock custom_css %}
<!-- Main content -->
{% block main_content %}
<div class="page-wrapper" style="min-height: 434px;">
    <div class="content container-fluid">
        <div class="page-header invoices-page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title"> <a href="{% url 'delivery_challan_list'%}"
                            style="margin-right: 10px;"><i class="fa fa-arrow-left" data-bs-toggle="tooltip" title=""
                                data-bs-original-title="Back" aria-label="fa fa-arrow-left"></i></a>
                        Update Delivery Challan</h3>
                </div>
                <div class="col-auto"> </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card invoices-add-card">
                    <div class="card-body">
                        <form class="invoices-form" method="post" id="delivery_challan_form"
                            action="#"
                            enctype="multipart/form-data" autocomplete="off">
                            {% csrf_token %}
                            <input type="hidden" name="delivery_challan_id" id="delivery_challan_id" value="{{challan_data.id}}">
                            <div class="invoices-main-form">
                                <div class="row">

                                    <!-- <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                                <div class="form-group">
                                                    <label>Challan No</label>
                                                    <input type="text" class="form-control" name="challan_no" id="challan_no" value="">
                                                </div>
                                            </div> -->

                                    <!-- <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Challan No </label>
                                            <input type="text" class="form-control" name="challan_no" id="challan_no"
                                                value={{challan_data.dc_number}} readonly="">
                                        </div>
                                    </div> -->
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Challan No</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="challan_no" id="challan_no"
                                                    value="{{ challan_data.dc_number }}" readonly required
                                                    pattern="DC\d{3}/\d{4}-\d{2}(-[A-Z])?"
                                                    oninput="validateChallanNumber()">
                                                <div class="input-group-append">
                                                    <button type="button" id="edit_challan_no_btn" class="btn btn-outline-secondary" title="Edit Challan No." style="height: 42px;">
                                                        <i class="fa fa-edit"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <!-- Element to display the validation message -->
                                            <div id="challan_no_error" class="invalid-feedback" style="display: none;">
                                                Challan number must be in the format DC012/2024-25 or DC012/2024-25-A.
                                            </div>
                                            <!-- Element to display the duplicate error message -->
                                            <div id="duplicate_challan_error" class="invalid-feedback" style="display: none;">
                                                Challan number already exists.
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <div class=" ">
                                                <span>
                                                    <label>Challan Date <span style="color: red;">*</span></label>
                                                    <input class="form-control datetimepicker" type="text"
                                                        name="challan_date" id="challan_date" value="{{challan_data.dc_date |date:'d-m-Y'}}" required readonly
                                                        >
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Payment Term <span style="color: red;">*</span></label>
                                            <select class="form-control" name="payment_term" id="payment_term" required>
                                                <option value="{{challan_data.dc_payment_terms}}">{{challan_data.dc_payment_terms}}</option>

                                                <option value="" hidden>Select Payment Term</option>
                                                <option value="AGAINST PROFORMA INVOICE">AGAINST PROFORMA INVOICE</option>
                                                <option value="100% ADVANCE">100% ADVANCE</option>
                                                <option value="50% ADVANCE BALANCE AGAINST DELIVERY">50% ADVANCE BALANCE AGAINST DELIVERY</option>
                                                <option value="7 DAYS">7 DAYS</option>
                                                <option value="15 DAYS">15 DAYS</option>
                                                <option value="30 DAYS">30 DAYS</option>
                                                <option value="45 DAYS">45 DAYS</option>
                                                <option value="60 DAYS">60 DAYS</option>
                                                <option value="90 DAYS">90 DAYS</option>
                                                <option value="120 DAYS">120 DAYS</option>
                                                <option value="AGAINST TAX INVOICE">AGAINST TAX INVOICE</option>
                                                <option value="OTHER OPTION">OTHER OPTION</option>
                                                
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Customer Name <span style="color: red;">*</span></label>
                                            <div data-select2-id="4">
                                                <div data-select2-id="4">
                                                    <!-- <select id="customer_Name" name="customer_Name"
                                                        class="form-control">
                                                        <option value="{{challan_data.dc_customer_name.id }}">{{challan_data.dc_customer_name.customer}}</option>
                                                        {% for i in all_customer_name %}
                                                        <option value="{{i.id}}">{{i.customer}}</option>
                                                        {% endfor %}
                                                    </select> -->
                                                    <input type="hidden" class="form-control" name="customer_id" id="customer_id"
                                                            value="{{challan_data.dc_customer_name_id}}">
                                                    <input type="text" class="form-control" name="customer_Name" id="customer_Name"
                                                            value="{{challan_data.dc_customer_name.customer}}" required readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Challan Type <span style="color: red;">*</span></label>
                                            <select class="form-control" name="challan_type" id="challan_type" required>
                                                <option value="{{challan_data.dc_type}}">{{challan_data.dc_type}}
                                                </option>
                                                <option value="Job Work">Job Work</option>
                                                <option value="Supply on Approval">Supply on Approval</option>
                                                <option value="Others" >Others</option>
                                            </select>
                                        </div>
                                    </div>


                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Place Of Supply <span style="color: red;">*</span></label>
                                            <select class="form-control" name="place_of_supply" id="place_of_supply" required
                                               >
                                               <option value="{{challan_data.dc_supply_place}}">{{challan_data.dc_supply_place}}</option>

                                               <option value="" hidden>State/Province</option>
                                               <option value="ANDAMAN AND NICOBAR ISLANDS">ANDAMAN AND NICOBAR ISLANDS</option>
                                               <option value="ANDHRA PRADESH (BEFORE DIVISION)">ANDHRA PRADESH (BEFORE DIVISION)</option>
                                               <option value="ANDHRA PRADESH (NEW)">ANDHRA PRADESH (NEW)</option>
                                               <option value="ARUNACHAL PRADESH">ARUNACHAL PRADESH</option>
                                               <option value="ASSAM">ASSAM</option>
                                               <option value="BIHAR">BIHAR</option>
                                               <option value="CHANDIGARH">CHANDIGARH</option>
                                               <option value="CHHATTISGARH">CHHATTISGARH</option>
                                               <option value="DADRA AND NAGAR HAVELI AND DAMAN AND DIU">DADRA AND NAGAR HAVELI AND DAMAN AND DIU</option>
                                               <option value="DAMAN AND DIU">DAMAN AND DIU</option>
                                               <option value="DELHI">DELHI</option>
                                               <option value="GOA">GOA</option>
                                               <option value="GUJARAT">GUJARAT</option>
                                               <option value="HARYANA">HARYANA</option>
                                               <option value="HIMACHAL PRADESH">HIMACHAL PRADESH</option>
                                               <option value="JAMMU AND KASHMIR">JAMMU AND KASHMIR</option>
                                               <option value="JHARKHAND">JHARKHAND</option>
                                               <option value="KARNATAKA">KARNATAKA</option>
                                               <option value="KERALA">KERALA</option>
                                               <option value="LADAKH">LADAKH</option>
                                               <option value="LAKSHADWEEP">LAKSHADWEEP</option>
                                               <option value="MADHYA PRADESH">MADHYA PRADESH</option>
                                               <option value="MAHARASHTRA">MAHARASHTRA</option>
                                               <option value="MANIPUR">MANIPUR</option>
                                               <option value="MEGHALAYA">MEGHALAYA</option>
                                               <option value="MIZORAM">MIZORAM</option>
                                               <option value="NAGALAND">NAGALAND</option>
                                               <option value="ODISHA">ODISHA</option>
                                               <option value="OTHER TERRITORY">OTHER TERRITORY</option>
                                               <option value="PUDUCHERRY">PUDUCHERRY</option>
                                               <option value="PUNJAB">PUNJAB</option>
                                               <option value="RAJASTHAN">RAJASTHAN</option>
                                               <option value="SIKKIM">SIKKIM</option>
                                               <option value="TAMIL NADU">TAMIL NADU</option>
                                               <option value="TELANGANA">TELANGANA</option>
                                               <option value="TRIPURA">TRIPURA</option>
                                               <option value="UTTAR PRADESH">UTTAR PRADESH</option>
                                               <option value="UTTARAKHAND">UTTARAKHAND</option>
                                               <option value="WEST BENGAL">WEST BENGAL</option>

                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label >Dispatch Through <span style="color: red;">*</span></label>
                                            <div>
                                                <select class="form-control" name="transporter_name"
                                                    id="transporter_name" required>
                                                    <option value="{{challan_data.dc_dispatch.id}}">{{challan_data.dc_dispatch.name}}</option>
                                                    {% for i in all_dispatch_through %}
                                                    <option value="{{i.id}}">{{i.name}}</option>
                                                    {% endfor %}

                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Sales Order No. </label>
                                            <input type="text" class="form-control" name="sales_order_no"
                                                id="sales_order_no" value="{{challan_data.dc_sales_order_no}}" >
                                        </div>
                                    </div>

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label >Delivery Type <span style="color: red;">*</span></label>
                                            <select class="form-control" name="delivery_type" id="delivery_type" required>
                                                <option value="{{challan_data.dc_delivery_type}}">{{challan_data.dc_delivery_type}} </option>
                                                <option value="PAID" >PAID</option>

                                                <option value="TO PAY">TO PAY</option>

                                                <option value="DOOR DELIVERY">DOOR DELIVERY</option>

                                                <option value="SELF COLLECTION">SELF COLLECTION</option>

                                            </select>
                                        </div>
                                    </div>
                                    <!-- omkar dropdown code -->
                                    <!-- <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Delivery Type</label>
                                            <select class="form-control" name="delivery_type" id="delivery_type">
                                                <option value="{{challan_data.dc_delivery_type}}">{{challan_data.dc_delivery_type}} </option>
                                                <option value="1">PAID</option>

                                                <option value="2">TO PAY</option>

                                                <option value="3">DOOR DELIVERY</option>

                                                <option value="4">SELF COLLECTION</option>

                                            </select>
                                        </div>
                                    </div> -->

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Buyer Order No. <span style="color: red;">*</span></label>
                                            <input type="text" class="form-control" name="buyer_order_no"
                                                id="buyer_order_no" value="{{challan_data.dc_buyer_order_no}}" required>
                                        </div>
                                    </div>

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Buyer Order Date <span style="color: red;">*</span></label>
                                            <input type="text" class="form-control datetimepicker"
                                                name="buyer_order_date" id="buyer_order_date" value="{{challan_data.dc_buyer_order_date | date:'d-m-Y'}}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Shipping Address</label>
                                            <input type="text" class="form-control" name="shipping_address" id="shipping_address"
                                                value="{{challan_data.dc_shipping_address}}">
                                        </div>
                                    </div>

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Landing LR-RRNo.</label>
                                            <input type="text" class="form-control" name="lr_no" id="lr_no"
                                                value="{{challan_data.dc_landing_LR_RR_No}}">
                                        </div>
                                    </div>

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Destination</label>
                                            <input type="text" class="form-control" name="destination" id="destination"
                                                value="{{challan_data.dc_destination}}">
                                        </div>
                                    </div>
                                    <!-- <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Dispatch Document No</label>
                                            <input type="text" class="form-control" name="dc_Dispatch_document_no" id="dc_Dispatch_document_no"
                                                value="{{challan_data.dc_Dispatch_document_no}}">
                                        </div>
                                    </div> -->
                                    
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Sales Person</label>
                                            <input type="text" class="form-control" name="sales_person"
                                                id="sales_person" value="{{challan_data.dc_sales_person}}">
                                        </div>
                                    </div>

                                    <!-- <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight</label>
                                            <input type="text" class="form-control" name="freight" id="freight"
                                                value="{{challan_data.dc_freight}}">
                                        </div>
                                    </div> -->

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight(Amount)</label>
                                            <input type="text" class="form-control " name="freight_amount" id="freight_amount"  value="{{challan_data.dc_freight_amount}}" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight(Percentage)</label>
                                            <input type="text" class="form-control " name="freight_percentage" id="freight_percentage"  value="{{challan_data.dc_freight_percentage}}" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                                        </div>
                                    </div>

                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Packaging &amp; Forwading (Amount)</label>
                                            <input type="text" class="form-control " name="packaging_forwording_amount" id="packaging_forwording_amount"  value="{{challan_data.dc_packaging_forwording_amount}}"  pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Packaging &amp; Forwading (Percentage)</label>
                                            <input type="text" class="form-control" name="packaging_forwording_percentage" id="packaging_forwording_percentage"  value="{{challan_data.dc_packaging_forwording_percentage}}" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');" >
                                        </div>
                                    </div>

                            
                            
                            

                            

                                    <div class="col-md-2 ">
                                        <div class="form-group">
                                           <label>GST</label>
                                           <div>
                                              <select class="form-control" name="gst_option" id="gst_option" onchange="updateTaxFields();calculateTotalTaxAmount();">
                                                 <option value="{{challan_data.gst_option}}" selected>{{challan_data.gst_option}}</option>
                                                 <option value="Interstate">Interstate</option>
                                                 <option value="Intrastate">Intrastate</option>
                                                 
                                                 
                                               
                                              </select>
                                           </div>
                                        </div>
                                     </div>


                                    <div class="col-lg-2" style="visibility: hidden;">
                                        <div class="form-group">
                                            <label>Item Rates Are </label>
                                            <select class="form-control" name="item_rate" id="item_rate">
                                                <option value="tax_exclusive" >Tax Exclusive</option>
                                                <option value="tax_inclusive" selected="">Tax Inclusive </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="rowbb">
                                        <div class="invoice-add-table">
                                            <div class="table-responsive">
                                                <table class="table table-center add-table-items"  id="append_table">
                                                    <thead>
                                                        <tr>
                                                            <th></th>
                                                            <th style="padding-left: 30px;">Item Code</th>
                                                            <th width="180px">Description of Goods</th>
                                                            <th>HSN</th>
                                                            <th>Qty</th>
                                                            <th>UOM</th>
                                                            <th>Unit Price</th>
                                                            <th>Disc(%)</th>
                                                            <th>Tax Rate</th>
                                                            <th>Tax Amt</th>
                                                            <th>Total</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for j in challan_item_data %}
                                                    <tr class="add-row">
                                                        <td><input type="hidden" name="iid[]" class="iid" value="{{len_dc_items}}">
                                                        </td>

                                                        <td><input type="text" style="width: 120px;" class="form-control"
                                                                name="itemcode_{{ forloop.counter }}"
                                                                id="itemcode_{{ forloop.counter }}"
                                                                value="{{j.dc_item_code}}"
                                                                onkeyup="getitemscodedetails('itemcode_{{ forloop.counter }}','item_{{ forloop.counter }}','godown_{{ forloop.counter }}','qty_{{ forloop.counter }}','rate_{{ forloop.counter }}','hsn_{{ forloop.counter }}','uom_{{ forloop.counter }}','discount_{{ forloop.counter }}','taxrate_{{ forloop.counter }}');">
                                                        </td>

                                                        <td><input type="text" class="form-control"
                                                                name="item_{{ forloop.counter }}"
                                                                id="item_{{ forloop.counter }}"
                                                                onkeyup="getitemsdetails('item_{{ forloop.counter }}','godown_{{ forloop.counter }}','qty_{{ forloop.counter }}','rate_{{ forloop.counter }}','hsn_{{ forloop.counter }}','uom_{{ forloop.counter }}','discount_{{ forloop.counter }}','taxrate_{{ forloop.counter }}','itemcode_{{ forloop.counter }}');"
                                                                value="{{j.dc_description_goods}}" placeholder=" " >
                                                        </td>

                                                        <td><input type="text" class="form-control"
                                                                name="hsn_{{ forloop.counter }}"
                                                                id="hsn_{{ forloop.counter }}" value="{{j.dc_hsn}}" readonly>
                                                        </td>

                                                        <td><input type="text" class="form-control"
                                                                name="qty_{{ forloop.counter }}"
                                                                id="qty_{{ forloop.counter }}"
                                                                value="{{j.dc_qantity}}"
                                                                onkeyup="taxrate('qty_{{ forloop.counter }}')"> </td>

                                                        <td><input type="text" class="form-control"
                                                                name="uom_{{ forloop.counter }}"
                                                                id="uom_{{ forloop.counter }}" value="{{j.dc_uom}}" readonly>
                                                        </td>

                                                        <td><input type="text" class="form-control"
                                                                name="rate_{{ forloop.counter }}"
                                                                id="rate_{{ forloop.counter }}"
                                                                value="{{j.dc_unit_price}}"
                                                                onkeyup="taxrate('rate_{{ forloop.counter }}')"></td>

                                                        <td><input type="text" class="form-control"
                                                                name="discount_{{ forloop.counter }}"
                                                                id="discount_{{ forloop.counter }}"
                                                                value="{{j.dc_discount}}"
                                                                onkeyup="taxrate('discount_{{ forloop.counter }}')">
                                                        </td>

                                                        <td><input type="number" class="form-control"
                                                                name="taxrate_{{ forloop.counter }}"
                                                                id="taxrate_{{ forloop.counter }}"
                                                                value="{{j.dc_tax_rate}}"
                                                                onkeyup="taxrate('taxrate_{{ forloop.counter }}')" required>
                                                        </td>

                                                        <td><input type="text" class="form-control taxamt"
                                                                name="taxamt_{{ forloop.counter }}"
                                                                id="taxamt_{{ forloop.counter }}"
                                                                value="{{j.dc_tax_amount}}" readonly></td>

                                                        <td><input type="text" class="form-control totalamt"
                                                                name="total_{{ forloop.counter }}"
                                                                id="total_{{ forloop.counter }}"
                                                                value="{{j.dc_total}}" readonly></td>

                                                        <td class="add-remove text-end">
                                                            <a href="javascript:void(0);" class="add-btn me-2"><i
                                                                    class="fas fa-plus-circle"></i></a>

                                                            <a href="javascript:void(0);" class="remove-btn "><i
                                                                    class="fe fe-trash-2"></i></a>
                                                        </td>
                                                    </tr>
                                                        <input type="hidden" id="i_field" value="{{len_dc_items}}">
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-7 col-md-6">
                                                <!-- <div class="form-group float-end mb-0"> <button class="btn btn-primary" type="submit">Add Item</button> </div> -->
                                                <div class="invoice-fields">
                                                    <h4 class="field-title">Terms and Conditions</h4> <br>
                                                 <textarea class="form-control" name="note">{{challan_data.dc_note}}</textarea>

                                                </div>
                                            </div>
                                            <div class="col-lg-5 col-md-6">
                                                <div class="invoice-total-card">
                                                    <h4 class="invoice-total-title">Summary</h4>
                                                    <div class="invoice-total-box">
                                                        <div class="invoice-total-inner">

                                                            <div class="total-tax-amt" hidden>
                                                                <label for="total_tax_amount">Total Tax Amount:</label>
                                                                <input type="text" id="total_tax_amount" class="form-control" readonly>
                                                            </div>
                                                           


                                                    <!-- omk -->
                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <p>Sub Total </p>
                                                        </div>
                                                        <div class="col-lg-6 ">
                                                            <input type="text" class="subtotal billamt utrt1"
                                                                name="subtotal" id="subtotal" value="{{challan_data.dc_sub_total}}"
                                                                readonly="">
                                                        </div>
                                                    </div>



                                                    <div class="row">
                                                        <!-- <div class="col-lg-6"><p>Tax Amt</p></div> -->
                                                        <div class="col-lg-6 ">
                                                            <input type="hidden"
                                                                class="totaltaxamt billamt utrt1"
                                                                name="total_taxamt" id="total_taxamt"
                                                                value="{{challan_data.dc_total}}" readonly="">
                                                        </div>
                                                    </div>

                                                    <!-- <div class="row">
                                                                <div class="col-lg-6"><p>Freight</p></div>
                                                                <div class="col-lg-6 ">
                                                                    <input class="billamt utrt1" type="text" name="freight" id="freight" value="0.00" onkeyup=";" >
                                                                </div>
                                                            </div> -->

                                                    <div class="row">
                                                        <!-- <div class="col-lg-6"><p>Tax Amt</p></div> -->
                                                        <div class="col-lg-6 ">
                                                            <input type="hidden"
                                                                class="totaltaxamt billamt utrt1"
                                                                name="total_taxamt" id="total_taxamt"
                                                                value="0.00" readonly="">
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <p>CGST 
                                                                <!-- @ <input type="text" name="cgstper"
                                                                    id="cgstper" value="{{challan_data.dc_cgstper}}" size="1"
                                                                    class="no-outline"> -->
                                                                </p>
                                                        </div>
                                                        <div class="col-lg-6 ">
                                                            <input type="text" class="utrt1 billamt" name="cgst"
                                                                id="cgst" value="{{challan_data.dc_cgstval}}" readonly="">
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <p>SGST
                                                                 <!-- @ <input type="text" name="sgstper"
                                                                    id="sgstper" value="{{challan_data.dc_sgstper}}" size="1"
                                                                    class="no-outline"> -->
                                                                </p>
                                                        </div>
                                                        <div class="col-lg-6 ">
                                                            <input type="text" class="utrt1 billamt" name="sgst"
                                                                id="sgst" value="{{challan_data.dc_sgstval}}" readonly="">
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <p>IGST
                                                                
                                                                </p>
                                                        </div>
                                                        <div class="col-lg-6 ">
                                                            <input type="text" class="billamt utrt1" name="igst"
                                                                id="igst" value="{{challan_data.dc_igstval}}" readonly="">
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <p>Adjustments</p>
                                                        </div>
                                                        <div class="col-lg-6 ">
                                                            <input class="billamt utrt1" type="text"
                                                                name="adjustment" id="adjustment" value="0.00"
                                                                onkeyup=";" readonly>
                                                        </div>
                                                    </div>

                                                    <div id="pfamtgst" style="display: none;">

                                                    <div class="row">
                                                        <div class="col-lg-6"><p>P&F (Amount) + GST</p></div>
                                                        <div class="col-lg-6 ">
                                                            <input class="billamt utrt1 " name="packaging_forwording_amt_amt" type="text" id="pf_amount" value="{{challan_data.dc_packaging_forwording_amt_amt}}" readonly>
                                                        </div>
                                                    </div>
                                                </div>

                                                    <div id="pfpergst" style="display: none;">

                                                    <div class="row">
                                                        <div class="col-lg-6"><p>P&F (Percentage) + GST</p></div>
                                                        <div class="col-lg-6 ">
                                                            <input class="billamt utrt1 " type="text" id="pf_percentage" name="packaging_forwording_percentage_amt" value="{{challan_data.dc_packaging_forwording_percentage_amt}}" readonly>
                                                        </div>
                                                    </div>
                                                </div>

                                                    <input type="hidden" id="subtotal" value="100.00"> <!-- Replace with actual subtotal -->
                                                    <div id="freight_amount_gst_row" style="display: none;">

                                                    <div class="row">
                                                        <div class="col-lg-6"><p>Freight (Amount) + GST</p></div>
                                                        <div class="col-lg-6 ">
                                                            <input class="billamt utrt1" type="text" name="freight_amt_amt" id="fr_amount" value="{{challan_data.dc_freight_amt_amt}}" readonly>
                                                        </div>
                                                    </div>
                                                </div>

                                                    <div id="freight_percentage_gst_row" style="display: none;">

                                                    <div class="row">
                                                        <div class="col-lg-6"><p>Freight (Percentage) + GST</p></div>
                                                        <div class="col-lg-6 ">
                                                            <input class="utrt1" type="text" id="fr_percentage" name="freight_percentage_amt" value="{{challan_data.dc_freight_percentage_amt}}" readonly>
                                                        </div>
                                                    </div>
                                                </div>

                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <p>TCS on Sale Of any Goods </p>
                                                        </div>
                                                        <div class="col-lg-6 ">
                                                            <input class="billamt utrt1" type="text"
                                                                name="sale_of_good" id="sale_of_good"
                                                                value="0.00" onkeyup=";" readonly>
                                                        </div>
                                                    </div>

                                                    <div class="invoice-total-footer">
                                                        <h4>Total Amount <input class="finalamt utrt1"
                                                                type="text" name="totalamt" id="totalamt"
                                                                value="{{challan_data.dc_total}}" readonly="">(Rs.)
                                                        </h4>
                                                    </div>
                                                    <div class="invoice-total-footer">
                                                        <h4>Total Amount in Word
                                                            -<input  name="totalamt_word" id="totalamt_word" readonly="" style="width: 370px; border: none;" value="{{challan_data.dc_total_amt_word}}"></input>
                                                        </h4>
                                                    </div>

                                                </div>
                                            </div>


                                                    <div class="upload-sign">
                                                        <div class="form-group float-end mb-0"> <a
                                                                href="{% url 'delivery_challan_list'%}"
                                                                class="btn btn-primary">Cancel</a></div>
                                                        <div class="form-group float-end mb-0"> <button
                                                                class="btn btn-primary" type="submit" id="btn_submit"
                                                                name="btn_submit">Save</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row col-sm-6 p-5">
                                        <div class="success_message row"></div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>


<script>
    document.getElementById('edit_challan_no_btn').addEventListener('click', function() {
        const challanInput = document.getElementById('challan_no');
        challanInput.removeAttribute('readonly');
        challanInput.focus(); // Optional: Focus the input for immediate editing
    });
    
    function validateChallanNumber() {
        const challanInput = document.getElementById('challan_no');
        const errorDiv = document.getElementById('challan_no_error');
        const duplicateErrorDiv = document.getElementById('duplicate_challan_error');
    
        // Validate the format
        if (challanInput.validity.patternMismatch) {
            challanInput.setCustomValidity('Challan number must be in the format DC012/2024-25 or DC012/2024-25-A.');
            errorDiv.style.display = 'block';
        } else {
            challanInput.setCustomValidity('');
            errorDiv.style.display = 'none';
        }
    
        // Check for duplicate if the format is valid
        if (!challanInput.validity.patternMismatch) {
            const originalChallanNumber = "{{ challan_data.dc_number }}";  // Get the original number from the template
    
            if (challanInput.value !== originalChallanNumber) {
                checkDuplicateChallanNumber(challanInput.value)
                    .then(isDuplicate => {
                        if (isDuplicate) {
                            challanInput.setCustomValidity('Challan number already exists.');
                            duplicateErrorDiv.style.display = 'block';
                        } else {
                            challanInput.setCustomValidity('');
                            duplicateErrorDiv.style.display = 'none';
                        }
                    });
            } else {
                challanInput.setCustomValidity('');  // No error if the number is unchanged
                duplicateErrorDiv.style.display = 'none';
            }
        }
    }
    
    function checkDuplicateChallanNumber(challan_no) {
        return fetch(`/check_duplicate_challan_no/?challan_no=${challan_no}`)
            .then(response => response.json())
            .then(data => data.is_duplicate);
    }
    </script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
     const freightAmount = document.getElementById('freight_amount');
     const freightPercentage = document.getElementById('freight_percentage');
     const packagingAmount = document.getElementById('packaging_forwording_amount');
     const packagingPercentage = document.getElementById('packaging_forwording_percentage');
 
     function toggleReadonlyFields(amountField, percentageField) {
         if (amountField.value !== '0' && amountField.value !== '') {
             percentageField.readOnly = true;
         } else if (percentageField.value !== '0' && percentageField.value !== '') {
             amountField.readOnly = true;
         } else {
             amountField.readOnly = false;
             percentageField.readOnly = false;
         }
     }
 
     // Attach event listeners for Freight fields
     freightAmount.addEventListener('input', function() {
         toggleReadonlyFields(freightAmount, freightPercentage);
     });
     freightPercentage.addEventListener('input', function() {
         toggleReadonlyFields(freightAmount, freightPercentage);
     });
 
     // Attach event listeners for Packaging & Forwarding fields
     packagingAmount.addEventListener('input', function() {
         toggleReadonlyFields(packagingAmount, packagingPercentage);
     });
     packagingPercentage.addEventListener('input', function() {
         toggleReadonlyFields(packagingAmount, packagingPercentage);
     });
 
     // Initial check in case values are pre-filled from the datalist
     toggleReadonlyFields(freightAmount, freightPercentage);
     toggleReadonlyFields(packagingAmount, packagingPercentage);
 });
 
 
 </script>

<script>

    $(document).ready(function() {
        toggleFreightFields();
    });
        
        document.addEventListener('DOMContentLoaded', function() {
            
            function toggleFreightFields() {
                
                const freightAmount = parseFloat(document.getElementById('freight_amount').value) || 0;
                const freightPercentage = parseFloat(document.getElementById('freight_percentage').value) || 0;
    
                if (freightAmount > 0) {
                    document.getElementById('freight_amount_gst_row').style.display = 'block';
                    document.getElementById('freight_percentage_gst_row').style.display = 'none';
                } else if (freightPercentage > 0) {
                    document.getElementById('freight_amount_gst_row').style.display = 'none';
                    document.getElementById('freight_percentage_gst_row').style.display = 'block';
                } else {
                    document.getElementById('freight_amount_gst_row').style.display = 'none';
                    document.getElementById('freight_percentage_gst_row').style.display = 'none';
                }
            }
    
            document.getElementById('freight_amount').addEventListener('input', toggleFreightFields);
            document.getElementById('freight_percentage').addEventListener('input', toggleFreightFields);
            // document.getElementById('customer_Name').addEventListener('input', togglePfFields);
    
            toggleFreightFields(); // Initialize the state q_freight_percentage_amt_amton page load
    
            function togglePfFields() {
                const pfAmount = parseFloat(document.getElementById('packaging_forwording_amount').value) || 0;
                const pfPercentage = parseFloat(document.getElementById('packaging_forwording_percentage').value) || 0;
    
                if (pfAmount > 0) {
                    document.getElementById('pfamtgst').style.display = 'block';
                    document.getElementById('pfpergst').style.display = 'none';
                } else if (pfPercentage > 0) {
                    document.getElementById('pfamtgst').style.display = 'none';
                    document.getElementById('pfpergst').style.display = 'block';
                } else {
                    document.getElementById('pfamtgst').style.display = 'none';
                    document.getElementById('pfpergst').style.display = 'none';
                }
            }
    
            
            document.getElementById('packaging_forwording_amount').addEventListener('input', togglePfFields);
            document.getElementById('packaging_forwording_percentage').addEventListener('input', togglePfFields);
            // document.getElementById('customer_Name').addEventListener('input', togglePfFields);
    
            togglePfFields();
    
            
    
            
        });
    </script>
    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script>

    document.getElementById('customer_Name').addEventListener('input', function() {
        var input = this.value;
        var list = document.getElementById('customer_Name_list').options;

        for (var i = 0; i < list.length; i++) {
            if (list[i].value === input) {
                console.log(list[i].dataset);
                document.getElementById('customer_id').value = list[i].dataset.id;
                document.getElementById('contact_person_name').value = list[i].dataset.contact_person;
                document.getElementById('contact_person_email').value = list[i].dataset.email;
                document.getElementById('destination').value = list[i].dataset.address;
                 $("#q_ser_type option").attr('selected', false);
                $("#q_ser_type option[value='" + list[i].dataset.service_type + "']").attr('selected', true);
                break;
            }
        }
    });
</script>
<script>
(function() {
    // Toastr Configuration
    toastr.options = {
        closeButton: true,
        debug: false,
        newestOnTop: false,
        progressBar: true,
        positionClass: "custom-toast-position",
        preventDuplicates: false,
        showDuration: "300",
        hideDuration: "1000",
        timeOut: "5000",
        extendedTimeOut: "1000",
        showEasing: "swing",
        hideEasing: "linear",
        showMethod: "fadeIn",
        hideMethod: "fadeOut"
    };

    // Form Validation
    document.getElementById('invoice_form').addEventListener('submit', function(event) {
        const customerSelect = document.getElementById('customer_id_select').value;
        const customerDatalist = document.getElementById('customer_Name').value;
        if (!customerSelect && !customerDatalist) {
            event.preventDefault();
            toastr.error('Please select a Customer Name.');
        }
    });

    // Initialize Date
    function initializeDate() {
        const dateInput = document.getElementById('challan_date');
        const today = new Date();
        const formattedDate = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
        dateInput.value = formattedDate;
    }

    // Toggle Freight and Packaging Fields
    function toggleFields() {
        const freightAmount = parseFloat(document.getElementById('freight_amount').value) || 0;
        const freightPercentage = parseFloat(document.getElementById('freight_percentage').value) || 0;
        const pfAmount = parseFloat(document.getElementById('packaging_forwording_amount').value) || 0;
        const pfPercentage = parseFloat(document.getElementById('packaging_forwording_percentage').value) || 0;

        document.getElementById('freight_amount_gst_row').style.display = freightAmount > 0 ? 'block' : 'none';
        document.getElementById('freight_percentage_gst_row').style.display = freightPercentage > 0 ? 'block' : 'none';
        document.getElementById('pfamtgst').style.display = pfAmount > 0 ? 'block' : 'none';
        document.getElementById('pfpergst').style.display = pfPercentage > 0 ? 'block' : 'none';

        document.getElementById('freight_percentage').disabled = freightAmount > 0;
        document.getElementById('freight_amount').disabled = freightPercentage > 0;
        document.getElementById('packaging_forwording_percentage').disabled = pfAmount > 0;
        document.getElementById('packaging_forwording_amount').disabled = pfPercentage > 0;
    }

    // Calculate Packaging and Freight
    function updatePFAmount() {
        const pfAmount = parseFloat(document.getElementById('packaging_forwording_amount').value) || 0;
        const gstAmount = (pfAmount * 0.18).toFixed(2);
        document.getElementById('pf_amount').value = (pfAmount + parseFloat(gstAmount)).toFixed(2);
        updateTotalInWords();
    }

    function updatePFPercentage() {
        const subtotal = parseFloat(document.getElementById('subtotal').value) || 0;
        const percentage = parseFloat(document.getElementById('packaging_forwording_percentage').value) || 0;
        const pfAmount = (subtotal * percentage) / 100;
        const gstAmount = (pfAmount * 0.18).toFixed(2);
        document.getElementById('pf_percentage').value = (pfAmount + parseFloat(gstAmount)).toFixed(2);
        updateTotalInWords();
    }

    function updateFreightAmount() {
        const frAmount = parseFloat(document.getElementById('freight_amount').value) || 0;
        const gstAmount = (frAmount * 0.18).toFixed(2);
        document.getElementById('fr_amount').value = (frAmount + parseFloat(gstAmount)).toFixed(2);
        updateTotalInWords();
    }

    function updateFreightPercentage() {
        const subtotal = parseFloat(document.getElementById('subtotal').value) || 0;
        const percentage = parseFloat(document.getElementById('freight_percentage').value) || 0;
        const frAmount = (subtotal * percentage) / 100;
        const gstAmount = (frAmount * 0.18).toFixed(2);
        document.getElementById('fr_percentage').value = (frAmount + parseFloat(gstAmount)).toFixed(2);
        updateTotalInWords();
    }

    // Calculate Row Totals
    function calculateRow(index, itemRate = 'tax_exclusive') {
        const rate = parseFloat($(`#rate_${index}`).val()) || 0;
        const qty = parseFloat($(`#qty_${index}`).val()) || 0;
        const discount = parseFloat($(`#discount_${index}`).val()) || 0;
        const taxrate = parseFloat($(`#taxrate_${index}`).val()) || 0;

        let total = rate - (rate * discount / 100);
        let totalamt = total * qty;
        let taxamt = totalamt * taxrate / 100;

        if (itemRate === 'tax_inclusive') {
            $(`#taxamt_${index}`).val(taxamt.toFixed(2));
            $(`#total_${index}`).val((totalamt - taxamt).toFixed(2));
        } else {
            $(`#total_${index}`).val(totalamt.toFixed(2));
            $(`#taxamt_${index}`).val(taxamt.toFixed(2));
        }

        subtotal();
        calculateTotalTaxAmount();
        updateTotalInWords();
    }

    // Calculate Subtotal and Taxes
    function subtotal() {
        let totalamt = 0;
        $(".totalamt").each(function() {
            totalamt += parseFloat($(this).val()) || 0;
        });
        $('.subtotal').val(totalamt.toFixed(2));

        let totalTaxAmount = 0;
        $(".taxamt").each(function() {
            totalTaxAmount += parseFloat($(this).val()) || 0;
        });

        const cgst = parseFloat($('#cgst').val()) || 0;
        const sgst = parseFloat($('#sgst').val()) || 0;
        const igst = parseFloat($('#igst').val()) || 0;
        const adjustment = parseFloat($('#adjustment').val()) || 0;
        const pfAmount = parseFloat($('#pf_amount').val()) || 0;
        const frAmount = parseFloat($('#fr_amount').val()) || 0;
        const pfPercentage = parseFloat($('#pf_percentage').val()) || 0;
        const frPercentage = parseFloat($('#fr_percentage').val()) || 0;
        const saleOfGood = parseFloat($('#sale_of_good').val()) || 0;

        const finalamt = totalamt + totalTaxAmount + adjustment + pfAmount + frAmount + pfPercentage + frPercentage + saleOfGood;
        $('.finalamt').val(finalamt.toFixed(2));
    }

    function calculateTotalTaxAmount() {
        let totalTaxAmount = 0;
        $(".taxamt").each(function() {
            totalTaxAmount += parseFloat($(this).val()) || 0;
        });
        $("#total_tax_amount").val(totalTaxAmount.toFixed(2));
        updateTaxFields();
    }

    function updateTaxFields() {
        const gstOption = document.getElementById('gst_option').value;
        const totalTaxAmount = parseFloat(document.getElementById('total_tax_amount').value) || 0;

        if (gstOption === 'Interstate') {
            document.getElementById('igst').value = totalTaxAmount.toFixed(2);
            document.getElementById('cgst').value = '0.00';
            document.getElementById('sgst').value = '0.00';
        } else if (gstOption === 'Intrastate') {
            const halfTaxAmount = (totalTaxAmount / 2).toFixed(2);
            document.getElementById('cgst').value = halfTaxAmount;
            document.getElementById('sgst').value = halfTaxAmount;
            document.getElementById('igst').value = '0.00';
        } else {
            document.getElementById('cgst').value = '0.00';
            document.getElementById('sgst').value = '0.00';
            document.getElementById('igst').value = '0.00';
        }
        subtotal();
        updateTotalInWords();
    }

    // Number to Words Conversion
    function numberToWords(n) {
        if (n < 0) return 'Invalid';
        const single = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const double = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

        if (n === 0) return 'Zero Rupees';

        function translate(num) {
            if (num < 10) return single[num] + ' ';
            if (num < 20) return double[num - 10] + ' ';
            if (num < 100) return tens[Math.floor(num / 10) - 2] + ' ' + translate(num % 10);
            if (num < 1000) return single[Math.floor(num / 100)] + ' Hundred ' + translate(num % 100);
            if (num < 100000) return translate(Math.floor(num / 1000)).trim() + ' Thousand ' + translate(num % 1000);
            if (num < 10000000) return translate(Math.floor(num / 100000)).trim() + ' Lakh ' + translate(num % 100000);
            return translate(Math.floor(num / 10000000)).trim() + ' Crore ' + translate(num % 10000000);
        }

        let [integer, decimal] = n.toString().split('.');
        let result = translate(parseInt(integer)).trim() + ' Rupees';
        if (decimal) {
            decimal = decimal.padEnd(2, '0');
            result += ' and ' + translate(parseInt(decimal)) + ' Paise';
        }
        return result.trim() + '.';
    }

    function updateTotalInWords() {
        const totalAmt = parseFloat(document.getElementById('totalamt').value) || 0;
        document.getElementById('totalamt_word').value = numberToWords(totalAmt);
    }

    // Autocomplete for Item Code
    function initializeItemCodeAutocomplete(index) {
        $(`#itemcode_${index}`).autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "{% url 'getitemscodedetails' %}",
                    dataType: "json",
                    type: "POST",
                    data: {
                        name_startsWith: request.term,
                        itemsdetails: index
                    },
                    success: function(data) {
                        response($.map(data, function(item) {
                            const code = item.split("|");
                            return {
                                label: code[0],
                                value: code[0],
                                data: item
                            };
                        }));
                    }
                });
            },
            minLength: 1,
            autoFocus: true,
            select: function(event, ui) {
                const names = ui.item.data.split("|");
                $(`#itemcode_${index}`).val(names[0]);
                $(`#item_${index}`).val(names[1]);
                $(`#hsn_${index}`).val(names[2]);
                $(`#qty_${index}`).val('1');
                $(`#rate_${index}`).val(names[5]);
                $(`#uom_${index}`).val(names[7]);
                $(`#discount_${index}`).val(names[4]);
                $(`#taxrate_${index}`).val(names[6]);
                calculateRow(index);
            },
            change: function(event, ui) {
                if (!ui.item) {
                    $(`#itemcode_${index}, #item_${index}, #hsn_${index}, #qty_${index}, #rate_${index}, #uom_${index}, #discount_${index}, #taxrate_${index}`).val('');
                }
            }
        });
    }

    // Add and Remove Rows
    $(document).on('click', '.add-btn', function() {
        const index = $('.add-row').length;
        const row = `
            <tr class="add-row">
                <input type="hidden" name="iid[]" class="iid" value="${index}">
                <td><input type="text" style="width: 120px;" class="form-control" name="itemcode_${index}" id="itemcode_${index}"></td>
                <td><input type="text" class="form-control" name="item_${index}" id="item_${index}" placeholder=" "></td>
                <td><input type="text" class="form-control" name="hsn_${index}" id="hsn_${index}"></td>
                <td><input type="text" class="form-control" name="qty_${index}" id="qty_${index}" onkeyup="qty('qty_${index}');"></td>
                <td><input type="text" class="form-control" name="uom_${index}" id="uom_${index}"></td>
                <td><input type="text" class="form-control" name="rate_${index}" id="rate_${index}" onkeyup="rate('rate_${index}');"></td>
                <td><input type="text" class="form-control" name="discount_${index}" id="discount_${index}" onkeyup="discountamt('discount_${index}');"></td>
                <td><input type="number" class="form-control taxrate_${index}" name="taxrate_${index}" id="taxrate_${index}" onkeyup="taxrate('taxrate_${index}');" required></td>
                <td><input type="text" class="form-control taxamt" name="taxamt_${index}" id="taxamt_${index}" readonly></td>
                <td><input type="text" class="form-control totalamt" name="total_${index}" id="total_${index}" readonly></td>
                <td class="add-remove text-end">
                    <a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a>
                    <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
                </td>
            </tr>`;
        $("#append_table > tbody").append(row);
        initializeItemCodeAutocomplete(index);
        $(`#qty_${index}, #rate_${index}, #discount_${index}, #taxrate_${index}`).on('keyup', function() {
            calculateRow(index);
        });
    });

    $(document).on('click', '.remove-btn', function() {
        $(this).closest('.add-row').remove();
        subtotal();
        calculateTotalTaxAmount();
        updateTotalInWords();
    });

    // Sales Order Selection
    let selectedQuotationId = null;
    document.getElementById('customer_Name').addEventListener('change', function() {
        const input = this.value;
        const options = document.getElementById('customer_Name_list').options;
        for (let i = 0; i < options.length; i++) {
            if (options[i].value === input) {
                document.getElementById('customer_id').value = options[i].dataset.id;
                document.getElementById('sales_person').value = options[i].dataset.contact_person;
                document.getElementById('sales_order_no').value = options[i].dataset.so_number;
                document.getElementById('customer_Name').value = options[i].dataset.so_customer_name;
                document.getElementById('igst').value = options[i].dataset.so_igstval;
                document.getElementById('cgst').value = options[i].dataset.so_cgstval;
                document.getElementById('sgst').value = options[i].dataset.so_sgstval;
                document.getElementById('buyer_order_no').value = options[i].dataset.so_buyer_order_no;
                document.getElementById('buyer_order_date').value = options[i].dataset.so_buyer_order_date;
                document.getElementById('shipping_address').value = options[i].dataset.so_shipping_address;
                document.getElementById('freight_amount').value = options[i].dataset.freight_amount;
                document.getElementById('packaging_forwording_amount').value = options[i].dataset.p_and_f_amount;
                document.getElementById('freight_percentage').value = options[i].dataset.freight_percentage;
                document.getElementById('packaging_forwording_percentage').value = options[i].dataset.p_and_f_percentage;
                $(`#gst_option option[value="${options[i].dataset.gst_option}"]`).prop('selected', true);
                $(`#payment_term option[value="${options[i].dataset.payment_terms}"]`).prop('selected', true);
                $(`#place_of_supply option[value="${options[i].dataset.supply_place}"]`).prop('selected', true);
                selectedQuotationId = options[i].dataset.id_sales;
                if (selectedQuotationId) {
                    fetchQuotationItems(selectedQuotationId);
                }
                break;
            }
        }
        toggleFields();
        updatePFAmount();
        updateFreightAmount();
        updatePFPercentage();
        updateFreightPercentage();
    });

    function fetchQuotationItems(quotationId) {
        fetch(`/get-sales_order-items/${quotationId}/`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('quotation-items-body');
                tbody.innerHTML = '';
                data.forEach((item, index) => {
                    const row = `
                        <tr class="add-row">
                            <input type="hidden" name="iid[]" class="iid" value="${index}">
                            <td><input style="width: 120px;" type="text" class="form-control" name="itemcode_${index}" id="itemcode_${index}" value="${item.so_item_code}"></td>
                            <td><input type="text" class="form-control" name="item_${index}" id="item_${index}" value="${item.so_description_goods}"></td>
                            <td><input type="text" class="form-control" name="hsn_${index}" id="hsn_${index}" value="${item.so_hsn}"></td>
                            <td><input type="text" class="form-control" name="qty_${index}" id="qty_${index}" value="${item.so_qantity}" onkeyup="qty('qty_${index}');"></td>
                            <td><input type="text" class="form-control" name="uom_${index}" id="uom_${index}" value="${item.so_uom}"></td>
                            <td><input type="text" class="form-control" name="rate_${index}" id="rate_${index}" value="${item.so_unit_price}" onkeyup="rate('rate_${index}');"></td>
                            <td><input type="text" class="form-control" name="discount_${index}" id="discount_${index}" value="${item.so_discount}" onkeyup="discountamt('discount_${index}');"></td>
                            <td><input type="number" class="form-control taxrate_${index}" name="taxrate_${index}" id="taxrate_${index}" value="${item.so_tax_rate}" onkeyup="taxrate('taxrate_${index}');" required></td>
                            <td><input type="text" class="form-control taxamt" name="taxamt_${index}" id="taxamt_${index}" value="${item.so_tax_amount}" readonly></td>
                            <td><input type="text" class="form-control totalamt" name="total_${index}" id="total_${index}" value="${item.so_total}" readonly></td>
                            <td class="add-remove text-end">
                                <a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a>
                                <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                    initializeItemCodeAutocomplete(index);
                    calculateRow(index);
                });
                subtotal();
                calculateTotalTaxAmount();
                updateTotalInWords();
            });
    }

    // Event Listeners
    $(document).ready(function() {
        initializeDate();
        initializeItemCodeAutocomplete(0);
        $('#freight_amount, #freight_percentage, #packaging_forwording_amount, #packaging_forwording_percentage, #gst_option').on('input', function() {
            toggleFields();
            updatePFAmount();
            updateFreightAmount();
            updatePFPercentage();
            updateFreightPercentage();
            subtotal();
            updateTotalInWords();
        });
        $('#item_rate').on('change', function() {
            $('.add-row').each(function(index) {
                calculateRow(index, $(this).val());
            });
        });
    });
})();
</script>

{% endblock main_content %}