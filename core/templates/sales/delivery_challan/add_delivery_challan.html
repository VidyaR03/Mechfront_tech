{% extends 'dashboard/base_template.html' %}
{% block title %}
Ecoway
{% endblock %}

{% block custom_css %}
<style>
    /* Inactive tab styles */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link {
        color: #ccc;
    }

    /* Active tab style */
    .nav-tabs.nav-tabs-bottom .nav-item .nav-link.active {
        color: #000;
    }

    /* Existing styles ... */

    /* jQuery Validate: Red border for invalid fields (Bootstrap fallback) */
    .form-control.is-invalid {
        border-color: #dc3545 !important;  /* Red border */
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;  /* Red glow */
    }

    /* Red text for error messages */
    .invalid-feedback {
        color: #dc3545 !important;  /* Red text */
        font-size: 0.875em;  /* Smaller font for messages */
        display: block !important;  /* Ensure visible */
    }

    /* Optional: Red text for field labels when invalid (targets parent form-group) */
    .form-group.has-error label,
    .form-group .is-invalid + .invalid-feedback ~ label {
        color: #dc3545 !important;
    }

    /* For selects (e.g., payment_term) - ensure red border */
    select.is-invalid {
        border-color: #dc3545 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");  /* Red dropdown arrow */
    }
</style>
{% endblock custom_css %}

{% block main_content %}
<div class="page-wrapper" style="min-height: 333px;">
    <div class="content container-fluid">
        <div class="page-header invoices-page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">
                        <a href="{% url 'delivery_challan_list' %}" style="margin-right: 10px;">
                            <i class="fa fa-arrow-left" data-bs-toggle="tooltip" title="Back" aria-label="Back"></i>
                        </a>
                        Add Delivery Challan
                    </h3>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card invoices-add-card">
                    <div class="card-body">
                        <form class="invoices-form" method="post" id="invoice_form" action="{% url 'add_delivery_challan' %}" enctype="multipart/form-data" autocomplete="off">
                            {% csrf_token %}
                            <div class="invoices-main-form">
                                <div class="row">
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Challan Date <span style="color: red;">*</span></label>
                                            <input class="form-control datetimepicker" type="text" name="challan_date" id="challan_date" value="{{current_date}}" required readonly>
                                        </div>
                                    </div>
              
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Customer Name <span style="color: red;">*</span></label>
                                            <select name="customer_id_select" class="form-control" id="customer_id_select">
                                                <option value="">Select Customer</option>
                                                {% for i in customer_name %}
                                                <option value="{{ i.id }}">{{ i.customer }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <input type="hidden" id="customer_id" name="customer_id">
                                            <label for="customer_Name">Customer Name from Sales Order <span style="color: red;">*</span></label>
                                            <input list="customer_Name_list" id="customer_Name" name="customer_Name" class="form-control" placeholder="Select Sales Order">
                                            <datalist id="customer_Name_list">
                                                {% for sale in sales_order_list %}
                                                <option value="{{ sale.so_number }}"
                                                        data-id="{{ sale.so_customer_name.id }}"
                                                        data-id_sales="{{ sale.id }}"
                                                        data-contact_person="{{ sale.so_sales_person }}"
                                                        data-so_customer_name="{{ sale.so_customer_name.customer }}"
                                                        data-so_igstval="{{ sale.so_igstval }}"
                                                        data-so_cgstval="{{ sale.so_cgstval }}"
                                                        data-so_sgstval="{{ sale.so_sgstval }}"
                                                        data-p_and_f_amount="{{ sale.so_packaging_forwording_amount }}"
                                                        data-freight_amount="{{ sale.so_freight_amount }}"
                                                        data-p_and_f_percentage="{{ sale.so_packaging_forwording_percentage }}"
                                                        data-freight_percentage="{{ sale.so_freight_percentage }}"
                                                        data-gst_option="{{ sale.gst_option }}"
                                                        data-payment_terms="{{ sale.so_payment_terms }}"
                                                        data-supply_place="{{ sale.so_supply_place }}"
                                                        data-so_shipping_address="{{ sale.so_shipping_address }}"
                                                        data-so_buyer_order_date="{{ sale.so_buyer_order_date }}"
                                                        data-so_buyer_order_no="{{ sale.so_buyer_order_no }}"
                                                        data-so_number="{{ sale.so_number }}">{{ sale.so_number }}--{{ sale.so_customer_name.customer }}</option>
                                                {% endfor %}
                                            </datalist>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Challan Type <span style="color: red;">*</span></label>
                                            <select class="form-control" name="challan_type" id="challan_type" required>
                                                <option value="Supply of Liquid Gas">Supply of Liquid Gas</option>
                                                <option value="Job Work">Job Work</option>
                                                <option value="Supply on Approval">Supply on Approval</option>
                                                <option value="Others" selected>Others</option>
                                            </select>
                                        </div>
                                    </div>
                                                          <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Payment Term <span style="color: red;">*</span></label>
                                            <select class="form-control" name="payment_term" id="payment_term" required>
                                                <option value="" hidden>Select Payment Term</option>
                                                <option value="AGAINST PROFORMA INVOICE">AGAINST PROFORMA INVOICE</option>
                                                <option value="100% ADVANCE">100% ADVANCE</option>
                                                <option value="50% ADVANCE BALANCE AGAINST DELIVERY">50% ADVANCE BALANCE AGAINST DELIVERY</option>
                                                <option value="7 DAYS">7 DAYS</option>
                                                <option value="15 DAYS">15 DAYS</option>
                                                <option value="30 DAYS">30 DAYS</option>
                                                <option value="45 DAYS">45 DAYS</option>
                                                <option value="60 DAYS">60 DAYS</option>
                                                <option value="90 DAYS">90 DAYS</option>
                                                <option value="120 DAYS">120 DAYS</option>
                                                <option value="AGAINST TAX INVOICE">AGAINST TAX INVOICE</option>
                                                <option value="OTHER OPTION">OTHER OPTION</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Place Of Supply <span style="color: red;">*</span></label>
                                            <select class="form-control" name="place_of_supply" id="place_of_supply" required>
                                                <option value="" hidden>State/Province</option>
                                                <option value="ANDAMAN AND NICOBAR ISLANDS">ANDAMAN AND NICOBAR ISLANDS</option>
                                                <option value="ANDHRA PRADESH (NEW)">ANDHRA PRADESH (NEW)</option>
                                                <option value="ARUNACHAL PRADESH">ARUNACHAL PRADESH</option>
                                                <option value="ASSAM">ASSAM</option>
                                                <option value="BIHAR">BIHAR</option>
                                                <option value="CHANDIGARH">CHANDIGARH</option>
                                                <option value="CHHATTISGARH">CHHATTISGARH</option>
                                                <option value="DADRA AND NAGAR HAVELI AND DAMAN AND DIU">DADRA AND NAGAR HAVELI AND DAMAN AND DIU</option>
                                                <option value="DELHI">DELHI</option>
                                                <option value="GOA">GOA</option>
                                                <option value="GUJARAT">GUJARAT</option>
                                                <option value="HARYANA">HARYANA</option>
                                                <option value="HIMACHAL PRADESH">HIMACHAL PRADESH</option>
                                                <option value="JAMMU AND KASHMIR">JAMMU AND KASHMIR</option>
                                                <option value="JHARKHAND">JHARKHAND</option>
                                                <option value="KARNATAKA">KARNATAKA</option>
                                                <option value="KERALA">KERALA</option>
                                                <option value="LADAKH">LADAKH</option>
                                                <option value="LAKSHADWEEP">LAKSHADWEEP</option>
                                                <option value="MADHYA PRADESH">MADHYA PRADESH</option>
                                                <option value="MAHARASHTRA">MAHARASHTRA</option>
                                                <option value="MANIPUR">MANIPUR</option>
                                                <option value="MEGHALAYA">MEGHALAYA</option>
                                                <option value="MIZORAM">MIZORAM</option>
                                                <option value="NAGALAND">NAGALAND</option>
                                                <option value="ODISHA">ODISHA</option>
                                                <option value="PUDUCHERRY">PUDUCHERRY</option>
                                                <option value="PUNJAB">PUNJAB</option>
                                                <option value="RAJASTHAN">RAJASTHAN</option>
                                                <option value="SIKKIM">SIKKIM</option>
                                                <option value="TAMIL NADU">TAMIL NADU</option>
                                                <option value="TELANGANA">TELANGANA</option>
                                                <option value="TRIPURA">TRIPURA</option>
                                                <option value="UTTAR PRADESH">UTTAR PRADESH</option>
                                                <option value="UTTARAKHAND">UTTARAKHAND</option>
                                                <option value="WEST BENGAL">WEST BENGAL</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Dispatch Through <span style="color: red;">*</span></label>
                                            <select class="form-control" name="transporter_name" id="transporter_name" required>
                                                <option value="" hidden>Select Transporter</option>
                                                {% for i in dispatch_through %}
                                                <option value="{{ i.id }}">{{ i.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Sales Order No.</label>
                                            <input type="text" class="form-control" name="sales_order_no" id="sales_order_no">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Delivery Type <span style="color: red;">*</span></label>
                                            <select class="form-control" name="delivery_type" id="delivery_type" required>
                                                <option value="" hidden>Select Delivery Type</option>
                                                <option value="PAID">PAID</option>
                                                <option value="TO PAY">TO PAY</option>
                                                <option value="DOOR DELIVERY">DOOR DELIVERY</option>
                                                <option value="SELF COLLECTION">SELF COLLECTION</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Buyer Order No.<span style="color: red;">*</span></label>
                                            <input type="text" class="form-control" name="buyer_order_no" id="buyer_order_no" required>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Buyer Order Date <span style="color: red;">*</span></label>
                                            <input type="text" class="form-control datetimepicker" name="buyer_order_date" id="buyer_order_date" required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Shipping Address</label>
                                            <input type="text" class="form-control" name="shipping_address" id="shipping_address">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Landing LR-RRNo.</label>
                                            <input type="text" class="form-control" name="lr_no" id="lr_no">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Destination</label>
                                            <input type="text" class="form-control" name="destination" id="destination">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Sales Person</label>
                                            <input type="text" class="form-control" name="sales_person" id="sales_person">
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight(Amount)</label>
                                            <!-- <input type="text" class="form-control" name="freight_amount" id="freight_amount" value="0" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');"> -->
                                        <input type="number" step="0.01" class="form-control" name="freight_amount" id="freight_amount" value="0.00" min="0" placeholder="Freight Amount(%)">

                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Freight(Percentage)</label>
                                            <!-- <input type="text" class="form-control" name="freight_percentage" id="freight_percentage" value="0" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');"> -->
                                           <input type="number" step="0.01" class="form-control" name="freight_percentage" id="freight_percentage" value="0.00" min="0" placeholder="Freight (%)">

                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Packaging & Forwarding (Amount)</label>
                                            <!-- <input type="text" class="form-control" name="packaging_forwording_amount" id="packaging_forwording_amount" value="0" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');"> -->
                                            <input type="number" step="0.01" class="form-control" name="packaging_forwording_amount" id="packaging_forwording_amount" value="0.00" min="0" placeholder="Packaging & Forwading">

                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-md-6 col-sm-12 col-12">
                                        <div class="form-group">
                                            <label>Packaging & Forwarding (Percentage)</label>
                                            <!-- <input type="text" class="form-control" name="packaging_forwording_percentage" id="packaging_forwording_percentage" value="0" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '');"> -->
                                            <input type="number" step="0.01" class="form-control" name="packaging_forwording_percentage" id="packaging_forwording_percentage" value="0.00" min="0" placeholder="Packaging & Forwading (%)">

                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>GST <span style="color: red;">*</span></label>
                                            <select class="form-control" name="gst_option" id="gst_option" onchange="updateTaxFields();" required>
                                                <option value="" hidden>Select GST</option>
                                                <option value="Interstate">Interstate</option>
                                                <option value="Intrastate">Intrastate</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-2" style="visibility: hidden;">
                                        <div class="form-group">
                                            <label>Item Rates Are</label>
                                            <select class="form-control" name="item_rate" id="item_rate">
                                                <option value="tax_exclusive">Tax Exclusive</option>
                                                <option value="tax_inclusive">Tax Inclusive</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="rowbb">
                                        <div class="invoice-add-table">
                                            <div class="table-responsive">
                                                <table class="table table-center add-table-items" id="append_table">
                                                    <thead>
                                                        <tr>
                                                            <th style="padding-left: 30px;">Item Code</th>
                                                            <th width="180px">Descriptions of Goods</th>
                                                            <th>HSN</th>
                                                            <th>Qty</th>
                                                            <th>UOM</th>
                                                            <th>Unit Price</th>
                                                            <th>Disc(%)</th>
                                                            <th>Tax Rate</th>
                                                            <th>Tax Amt</th>
                                                            <th>Total</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="quotation-items-body">
                                                        <input type="hidden" name="iid[]" class="iid" value="0">
                                                        <tr class="add-row">
                                                            <td><input type="text" style="width: 120px;" class="form-control" name="itemcode_0" id="itemcode_0"></td>
                                                            <td><input type="text" class="form-control" name="item_0" id="item_0" placeholder=" "></td>
                                                            <td><input type="text" class="form-control" name="hsn_0" id="hsn_0"></td>
                                                            <td><input type="text" class="form-control" name="qty_0" id="qty_0" onkeyup="qty('qty_0');"></td>
                                                            <td><input type="text" class="form-control" name="uom_0" id="uom_0"></td>
                                                            <td><input type="text" class="form-control" name="rate_0" id="rate_0" onkeyup="rate('rate_0');"></td>
                                                            <td><input type="text" class="form-control" name="discount_0" id="discount_0" onkeyup="discountamt('discount_0');"></td>
                                                            <td><input type="number" class="form-control taxrate_0" name="taxrate_0" step="0.001" id="taxrate_0" onkeyup="taxrate('taxrate_0');" required></td>
                                                            <td><input type="text" class="form-control taxamt" name="taxamt_0" id="taxamt_0" readonly></td>
                                                            <td><input type="text" class="form-control totalamt" name="total_0" id="total_0" readonly></td>
                                                            <td class="add-remove text-end">
                                                                <a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a>
                                                                <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-7 col-md-6">
                                                <div class="invoice-fields">
                                                    <h4 class="field-title">Terms and Conditions</h4>
                                                    <textarea class="form-control" name="note"></textarea>
                                                </div>
                                            </div>
                                            <div class="col-lg-5 col-md-6">
                                                <div class="invoice-total-card">
                                                    <h4 class="invoice-total-title">Summary</h4>
                                                    <div class="invoice-total-box">
                                                        <div class="invoice-total-inner">
                                                            <div class="total-tax-amt" hidden>
                                                                <label for="total_tax_amount">Total Tax Amount:</label>
                                                                <input type="text" id="total_tax_amount" class="form-control" readonly>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-6"><p>Sub Total</p></div>
                                                                <div class="col-lg-6">
                                                                    <input type="text" class="subtotal billamt utrt1" name="subtotal" id="subtotal" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>CGST</p>
                                                                </div>
                                                                <div class="col-lg-6">
                                                                    <input type="text" class="utrt1 billamt" name="cgst" id="cgst" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>SGST</p>
                                                                </div>
                                                                <div class="col-lg-6">
                                                                    <input type="text" class="utrt1 billamt" name="sgst" id="sgst" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>IGST</p>
                                                                </div>
                                                                <div class="col-lg-6">
                                                                    <input type="text" class="billamt utrt1" name="igst" id="igst" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>Adjustments</p>
                                                                </div>
                                                                <div class="col-lg-6">
                                                                    <input class="billamt utrt1" type="text" name="adjustment" id="adjustment" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                            <div id="pfamtgst" style="display: none;">
                                                                <div class="row">
                                                                    <div class="col-lg-6"><p>P&F (Amount) + GST</p></div>
                                                                    <div class="col-lg-6">
                                                                        <input class="billamt utrt1" name="packaging_forwording_amt_amt" type="text" id="pf_amount" value="0.00" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div id="pfpergst" style="display: none;">
                                                                <div class="row">
                                                                    <div class="col-lg-6"><p>P&F (Percentage) + GST</p></div>
                                                                    <div class="col-lg-6">
                                                                        <input class="billamt utrt1" type="text" name="packaging_forwording_percentage_amt" id="pf_percentage" value="0.00" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div id="freight_amount_gst_row" style="display: none;">
                                                                <div class="row">
                                                                    <div class="col-lg-6"><p>Freight (Amount) + GST</p></div>
                                                                    <div class="col-lg-6">
                                                                        <input class="billamt utrt1" type="text" name="freight_amt_amt" id="fr_amount" value="0.00" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div id="freight_percentage_gst_row" style="display: none;">
                                                                <div class="row">
                                                                    <div class="col-lg-6"><p>Freight (Percentage) + GST</p></div>
                                                                    <div class="col-lg-6">
                                                                        <input class="billamt utrt1" type="text" name="freight_percentage_amt" id="fr_percentage" value="0.00" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <p>TCS on Sale Of any Goods</p>
                                                                </div>
                                                                <div class="col-lg-6">
                                                                    <input class="billamt utrt1" type="text" name="sale_of_good" id="sale_of_good" value="0.00" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="invoice-total-footer">
                                                                <h4>Total Amount <input class="finalamt utrt1" type="text" name="totalamt" id="totalamt" value="0.00" readonly> (Rs.)</h4>
                                                            </div>
                                                            <div class="invoice-total-footer">
                                                                <h4>Total Amount in Word
                                                                    <textarea name="totalamt_word" id="totalamt_word" readonly style="width: 370px; border: none;"></textarea>
                                                                </h4>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="upload-sign">
                                                        <div class="form-group float-end mb-0">
                                                            <a href="#" class="btn btn-primary">Cancel</a>
                                                        </div>
                                                        <div class="form-group float-end mb-0">
                                                            <button class="btn btn-primary" type="submit" id="btn_submit" name="btn_submit">Save</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row col-sm-6 p-5">
                                        <div class="success_message row"></div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock main_content %}

{% block custom_js %}

<!-- External Dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.js"></script>
<script src="https://olatechs.in/crm/supreeno/assets/js/malsup-jquery.js"></script>
<script>
// Toastr Configuration
toastr.options = {
    closeButton: true,
    newestOnTop: true,
    progressBar: true,
    positionClass: "toast-top-right",
    preventDuplicates: false,
    showDuration: "300",
    hideDuration: "1000",
    timeOut: "5000",
    extendedTimeOut: "1000",
    showEasing: "swing",
    hideEasing: "linear",
    showMethod: "fadeIn",
    hideMethod: "fadeOut"
};

// Initialize Datepickers and Default Dates
$(document).ready(function() {
    const today = new Date();
    const formattedDate = `${('0' + today.getDate()).slice(-2)}-${('0' + (today.getMonth() + 1)).slice(-2)}-${today.getFullYear()}`;
    
    $('#invoice_date, #buyer_order_date').datepicker({
        dateFormat: 'dd-mm-yy',
        minDate: 0
    }).val(formattedDate);
    $('#due_date, #buyer_order_date').datepicker({
        dateFormat: 'dd-mm-yy',
        minDate: 0
    }).val(formattedDate);

    // Initialize autocomplete for the initial row
    initializeItemCodeAutocomplete(0);

    // Form Validation
    $('#invoice_form').validate({
        rules: {
            invoice_date: { required: true },
            payment_term: { required: true },
            contact_person_name: { required: true },
            ewaybill_no: { required: true },
            place_of_supply: { required: true },
            buyer_order_no: { required: true },
            buyer_order_date: { required: true },
            transporter_name: { required: true },
            gst_option: { required: true }
        },
        messages: {
            contact_person_name: "Please enter a contact person name"
        }
    });

    // Initialize Calculations
    subtotal();
});

// Toggle Freight and P&F Fields
function toggleFreightAndPF() {
    const freightAmount = parseFloat($('#freight_amount').val()) || 0;
    const freightPercentage = parseFloat($('#freight_percentage').val()) || 0;
    const pfAmount = parseFloat($('#packaging_forwording_amount').val()) || 0;
    const pfPercentage = parseFloat($('#packaging_forwording_percentage').val()) || 0;

    $('#freight_amount').prop('disabled', freightPercentage > 0);
    $('#freight_percentage').prop('disabled', freightAmount > 0);
    $('#freight_amount_gst_row').toggle(freightAmount > 0);
    $('#freight_percentage_gst_row').toggle(freightPercentage > 0);

    $('#packaging_forwording_amount').prop('disabled', pfPercentage > 0);
    $('#packaging_forwording_percentage').prop('disabled', pfAmount > 0);
    $('#pfamtgst').toggle(pfAmount > 0);
    $('#pfpergst').toggle(pfPercentage > 0);
}

// Item Code Autocomplete
// Item Code Autocomplete
function initializeItemCodeAutocomplete(index) {
    $(`#itemcode_${index}`).autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "{% url 'getitemscodedetails' %}",
                dataType: "json",
                type: "POST",
                data: {
                    name_startsWith: request.term,
                    itemsdetails: index,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    if (data.length === 0) {
                        response([{ label: "No results found", value: "__no_result__" }]);
                    } else {
                        response($.map(data, function(item) {
                            const code = item.split('|');
                            return { label: code[0], value: code[0], data: item };
                        }));
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Autocomplete error:", error);
                    toastr.error(`Failed to fetch item details: ${error}`, "Error");
                    response([]);
                }
            });
        },
        autoFocus: true,
        minLength: 1,
        select: function(event, ui) {
            if (ui.item.value === "__no_result__") {
                // Prevent "No results found" from being selectable
                event.preventDefault();
                return false;
            }
            if (ui.item.value) {
                const names = ui.item.data.split('|');
                $(`#itemcode_${index}`).val(names[0]);
                $(`#item_${index}`).val(names[1]);
                $(`#hsn_${index}`).val(names[2]);
                $(`#qty_${index}`).val(names[3] || '1');
                $(`#discount_${index}`).val(names[4] || '0');
                $(`#rate_${index}`).val(names[5]);
                $(`#taxrate_${index}`).val(names[6] || '0');
                $(`#uom_${index}`).val(names[7]);
                checkStockQuantity(`itemcode_${index}`, `qty_${index}`);
                subtotal();
                calculateTotalTaxAmount();
                updateTotalInWords();
            }
        },
        change: function(event, ui) {
            if (!ui.item || ui.item.value === "__no_result__") {
                $(`#itemcode_${index}, #item_${index}, #hsn_${index}, #qty_${index}, #rate_${index}, #uom_${index}, #discount_${index}, #taxrate_${index}`).val('');
                subtotal();
                calculateTotalTaxAmount();
                updateTotalInWords();
            }
        }
    })
    // Custom render to style "No results found"
    .data("ui-autocomplete")._renderItem = function(ul, item) {
        if (item.value === "__no_result__") {
            return $("<li>")
                .append("<div>"+ item.label +"</div>")
                .appendTo(ul);
        } else {
            return $("<li>")
                .append("<div>"+ item.label +"</div>")
                .appendTo(ul);
        }
    };
}

// Stock Quantity Check
function checkStockQuantity(itemCodeFieldId, qtyFieldId) {
    const itemCode = $(`#${itemCodeFieldId}`).val();
    const qty = $(`#${qtyFieldId}`).val();
    if (itemCode && qty) {
        $.ajax({
            url: '{% url "check_inventory_stock" %}',
            method: 'GET',
            data: { item_code: itemCode, qty: qty },
            success: function(response) {
                if (!response.success) {
                    toastr.error(`Insufficient stock! Available: ${response.available_qty}`, "Stock Warning");
                    $(`#${qtyFieldId}`).val(0);
                    subtotal();
                    calculateTotalTaxAmount();
                    updateTotalInWords();
                }
            },
            error: function(xhr, status, error) {
                console.error("Stock check error:", error);
                toastr.error(`Error checking stock: ${error}`, "Error");
            }
        });
    }
}

// Customer Selection
$('#customer_Name').on('input', function() {
    const input = this.value;
    const list = $('#customer_Name_list')[0].options;
    let selectedQuotationId = null;

    for (let option of list) {
        if (option.value === input) {
            $('#customer_id').val(option.dataset.id);
            $('#dc_id').val(option.dataset.dc_id);
            $('#contact_person_name').val(option.dataset.contact_person);
            $('#destination').val(option.dataset.dc_destination);
            $('#order_no').val(option.dataset.dc_number);
            $('#gst_option').val(option.dataset.gst_option);
            $('#buyer_order_no').val(option.dataset.buyer_order_no);
            $('#freight_amount').val(option.dataset.freight_amount);
            $('#packaging_forwording_amount').val(option.dataset.p_and_f_amount);
            $('#freight_percentage').val(option.dataset.freight_percentage);
            $('#packaging_forwording_percentage').val(option.dataset.p_and_f_percentage);
            $('#igst').val(option.dataset.dc_igstval);
            $('#cgst').val(option.dataset.dc_cgstval);
            $('#sgst').val(option.dataset.dc_sgstval);
            $('#transporter_name_id').val(option.dataset.dc_dispatch);
            $('#sales_person').val(option.dataset.contact_person);
            $('#shipping_address').val(option.dataset.dc_shipping_address);
            $('#payment_term').val(option.dataset.dc_payment_terms);
            $('#place_of_supply').val(option.dataset.dc_supply_place);
            selectedQuotationId = option.dataset.dc_id;
            break;
        }
    }
    console.log(selectedQuotationId)
    if (selectedQuotationId) {
        fetchQuotationItems(selectedQuotationId);
    }
    toggleFreightAndPF();
    subtotal();
    calculateTotalTaxAmount();
    updateTotalInWords();
});


function fetchQuotationItems(quotationId) {
    let url = "{% url 'get_dc_order_items' 0 %}".replace("0",quotationId);
    fetch(url, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const tbody = $('#quotation-items-body').empty();
        data.forEach((item, index) => {
            const row = `
                <tr class="add-row">
                    <input type="hidden" name="iid[]" class="iid" value="${index}">
                    <td><input type="text" class="form-control" name="itemcode_${index}" id="itemcode_${index}" value="${item.dc_item_code}"></td>
                    <td><input type="text" class="form-control" name="item_${index}" id="item_${index}" value="${item.dc_description_goods}"></td>
                    <td><input type="text" class="form-control" name="hsn_${index}" id="hsn_${index}" value="${item.dc_hsn}"></td>
                    <td><input type="number" class="form-control qty" name="qty_${index}" id="qty_${index}" value="${item.dc_qantity}" min="1" step="1" onkeyup="qty('qty_${index}');checkStockQuantity('itemcode_${index}', 'qty_${index}');"></td>
                    <td><input type="text" class="form-control" name="uom_${index}" id="uom_${index}" value="${item.dc_uom}"></td>
                    <td><input type="number" class="form-control rate" name="rate_${index}" id="rate_${index}" value="${item.dc_unit_price}" min="0" step="0.01" onkeyup="rate('rate_${index}');"></td>
                    <td><input type="number" class="form-control discount" name="discount_${index}" id="discount_${index}" value="${item.dc_discount}" min="0" max="100" step="0.01" onkeyup="discountamt('discount_${index}');"></td>
                    <td><input type="number" class="form-control taxrate" name="taxrate_${index}" id="taxrate_${index}" value="${item.dc_tax_rate}" min="0" step="0.01" required onkeyup="taxrate('taxrate_${index}');"></td>
                    <td><input type="text" class="form-control taxamt" name="taxamt_${index}" id="taxamt_${index}" value="${item.dc_tax_amount}" readonly></td>
                    <td><input type="text" class="form-control totalamt" name="total_${index}" id="total_${index}" value="${item.dc_total}" readonly></td>
                    <td class="add-remove text-end">
                        <a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a>
                        <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
                    </td>
                </tr>`;
            tbody.append(row);
            initializeItemCodeAutocomplete(index);
        });
        subtotal();
        calculateTotalTaxAmount();
        updateTotalInWords();
    })
    .catch(error => {
        console.error("Fetch error:", error);
        toastr.error(`Failed to fetch items: ${error}`, "Error");
    });
}
// Add/Remove Rows
$('#append_table').on('click', '.add-btn', function() {
    const i = $('.add-row').length;
    const row = `
        <tr class="add-row">
            <input type="hidden" name="iid[]" class="iid" value="${i}">
            <td><input type="text" class="form-control" name="itemcode_${i}" id="itemcode_${i}"></td>
            <td><input type="text" class="form-control" name="item_${i}" id="item_${i}"></td>
            <td><input type="text" class="form-control" name="hsn_${i}" id="hsn_${i}"></td>
            <td><input type="number" class="form-control qty" name="qty_${i}" id="qty_${i}" min="1" step="1" onkeyup="qty('qty_${i}');checkStockQuantity('itemcode_${i}', 'qty_${i}');"></td>
            <td><input type="text" class="form-control" name="uom_${i}" id="uom_${i}"></td>
            <td><input type="number" class="form-control rate" name="rate_${i}" id="rate_${i}" min="0" step="0.01" onkeyup="rate('rate_${i}');"></td>
            <td><input type="number" class="form-control discount" name="discount_${i}" id="discount_${i}" min="0" max="100" step="0.01" onkeyup="discountamt('discount_${i}');"></td>
            <td><input type="number" class="form-control taxrate" name="taxrate_${i}" id="taxrate_${i}" min="0" step="0.01" required onkeyup="taxrate('taxrate_${i}');"></td>
            <td><input type="text" class="form-control taxamt" name="taxamt_${i}" id="taxamt_${i}" readonly></td>
            <td><input type="text" class="form-control totalamt" name="total_${i}" id="total_${i}" readonly></td>
            <td class="add-remove text-end">
                <a href="javascript:void(0);" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a>
                <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
            </td>
        </tr>`;
    $('#quotation-items-body').append(row);
    initializeItemCodeAutocomplete(i);
    subtotal();
}).on('click', '.remove-btn', function() {
    $(this).closest('.add-row').remove();
    subtotal();
    calculateTotalTaxAmount();
    updateTotalInWords();
});

// Calculation Functions
function qty(inputname) {
    const id = inputname.split('_')[1];
    const rate = parseFloat($(`#rate_${id}`).val()) || 0;
    const qty = parseFloat($(`#qty_${id}`).val()) || 0;
    const discount = parseFloat($(`#discount_${id}`).val()) || 0;
    const itemRate = $('#item_rate').val();

    let total = rate - (rate * discount / 100);
    let totalamt = total * qty;
    let taxrate = parseFloat($(`#taxrate_${id}`).val()) || 0;
    let taxamt = totalamt * taxrate / 100;

    if (itemRate === 'tax_exclusive') {
        $(`#total_${id}`).val(totalamt.toFixed(2));
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
    } else {
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
        totalamt -= taxamt;
        $(`#total_${id}`).val(totalamt.toFixed(2));
    }

    subtotal();
    calculateTotalTaxAmount();
    updateTotalInWords();
}

function rate(inputname) {
    const id = inputname.split('_')[1];
    const rate = parseFloat($(`#rate_${id}`).val()) || 0;
    const qty = parseFloat($(`#qty_${id}`).val()) || 0;
    const discount = parseFloat($(`#discount_${id}`).val()) || 0;
    const itemRate = $('#item_rate').val();

    let total = rate - (rate * discount / 100);
    let totalamt = total * qty;
    let taxrate = parseFloat($(`#taxrate_${id}`).val()) || 0;
    let taxamt = totalamt * taxrate / 100;

    if (itemRate === 'tax_exclusive') {
        $(`#total_${id}`).val(totalamt.toFixed(2));
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
    } else {
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
        totalamt -= taxamt;
        $(`#total_${id}`).val(totalamt.toFixed(2));
    }

    subtotal();
    calculateTotalTaxAmount();
    updateTotalInWords();
}

function discountamt(inputname) {
    const id = inputname.split('_')[1];
    const rate = parseFloat($(`#rate_${id}`).val()) || 0;
    const qty = parseFloat($(`#qty_${id}`).val()) || 0;
    const discount = parseFloat($(`#discount_${id}`).val()) || 0;
    const itemRate = $('#item_rate').val();

    let total = rate - (rate * discount / 100);
    let totalamt = total * qty;
    let taxrate = parseFloat($(`#taxrate_${id}`).val()) || 0;
    let taxamt = totalamt * taxrate / 100;

    if (itemRate === 'tax_exclusive') {
        $(`#total_${id}`).val(totalamt.toFixed(2));
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
    } else {
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
        totalamt -= taxamt;
        $(`#total_${id}`).val(totalamt.toFixed(2));
    }

    subtotal();
    calculateTotalTaxAmount();
    updateTotalInWords();
}

function taxrate(inputname) {
    const id = inputname.split('_')[1];
    const rate = parseFloat($(`#rate_${id}`).val()) || 0;
    const qty = parseFloat($(`#qty_${id}`).val()) || 0;
    const discount = parseFloat($(`#discount_${id}`).val()) || 0;
    const itemRate = $('#item_rate').val();

    let total = rate - (rate * discount / 100);
    let totalamt = total * qty;
    let taxrate = parseFloat($(`#taxrate_${id}`).val()) || 0;
    let taxamt = totalamt * taxrate / 100;

    if (itemRate === 'tax_exclusive') {
        $(`#total_${id}`).val(totalamt.toFixed(2));
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
    } else {
        $(`#taxamt_${id}`).val(taxamt.toFixed(2));
        totalamt -= taxamt;
        $(`#total_${id}`).val(totalamt.toFixed(2));
    }

    subtotal();
    calculateTotalTaxAmount();
    updateTotalInWords();
}

function subtotal() {
    let totalamt = 0;
    let totalTax = 0;
    $('.totalamt').each(function() { totalamt += parseFloat($(this).val()) || 0; });
    $('.taxamt').each(function() { totalTax += parseFloat($(this).val()) || 0; });
    $('#subtotal').val(totalamt.toFixed(2));
    $('#total_tax_amount').val(totalTax.toFixed(2));

    const gstOption = $('#gst_option').val();
    if (gstOption === 'Interstate') {
        $('#igst').val(totalTax.toFixed(2));
        $('#cgst, #sgst').val('0.00');
    } else if (gstOption === 'Intrastate') {
        const halfTax = (totalTax / 2).toFixed(2);
        $('#cgst, #sgst').val(halfTax);
        $('#igst').val('0.00');
    } else {
        $('#cgst, #sgst, #igst').val('0.00');
    }

    const pfAmount = parseFloat($('#packaging_forwording_amount').val()) || 0;
    const pfPercentage = parseFloat($('#packaging_forwording_percentage').val()) || 0;
    const frAmount = parseFloat($('#freight_amount').val()) || 0;
    const frPercentage = parseFloat($('#freight_percentage').val()) || 0;

    let pfTotal = pfAmount > 0 ? (pfAmount * 1.18) : (pfPercentage > 0 ? (totalamt * pfPercentage / 100 * 1.18) : 0);
    let frTotal = frAmount > 0 ? (frAmount * 1.18) : (frPercentage > 0 ? (totalamt * frPercentage / 100 * 1.18) : 0);

    $('#pf_amount').val(pfTotal.toFixed(2));
    $('#pf_percentage').val(pfTotal.toFixed(2));
    $('#fr_amount').val(frTotal.toFixed(2));
    $('#fr_percentage').val(frTotal.toFixed(2));

    toggleFreightAndPF();

    const adjustment = parseFloat($('#adjustment').val()) || 0;
    const saleOfGood = parseFloat($('#sale_of_good').val()) || 0;
    const finalTotal = totalamt + totalTax + pfTotal + frTotal + adjustment + saleOfGood;
    $('#totalamt').val(finalTotal.toFixed(2));

    updateTotalInWords();
}

function calculateTotalTaxAmount() {
    let totalTaxAmount = 0;
    $('.taxamt').each(function() {
        totalTaxAmount += parseFloat($(this).val()) || 0;
    });
    $('#total_tax_amount').val(totalTaxAmount.toFixed(2));
    updateTaxFields();
}

function updateTaxFields() {
    const gstOption = $('#gst_option').val();
    const totalTaxAmount = parseFloat($('#total_tax_amount').val()) || 0;
    if (gstOption === 'Interstate') {
        $('#igst').val(totalTaxAmount.toFixed(2));
        $('#cgst, #sgst').val('0.00');
    } else if (gstOption === 'Intrastate') {
        const halfTaxAmount = (totalTaxAmount / 2).toFixed(2);
        $('#cgst, #sgst').val(halfTaxAmount);
        $('#igst').val('0.00');
    } else {
        $('#cgst, #sgst, #igst').val('0.00');
    }
}

function updateTotalInWords() {
    const totalAmt = parseFloat($('#totalamt').val()) || 0;
    const single_digit = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    const double_digit = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const below_hundred = ['Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

    function translate(n) {
        if (n === 0) return 'Zero';
        let word = '';
        if (n < 10) word = single_digit[n] + ' ';
        else if (n < 20) word = double_digit[n - 10] + ' ';
        else if (n < 100) word = below_hundred[Math.floor(n / 10) - 2] + ' ' + translate(n % 10);
        else if (n < 1000) word = single_digit[Math.floor(n / 100)] + ' Hundred ' + translate(n % 100);
        else if (n < 100000) word = translate(Math.floor(n / 1000)).trim() + ' Thousand ' + translate(n % 1000);
        else if (n < 10000000) word = translate(Math.floor(n / 100000)).trim() + ' Lakh ' + translate(n % 100000);
        else word = translate(Math.floor(n / 10000000)).trim() + ' Crore ' + translate(n % 10000000);
        return word.trim();
    }

    let [integerPart, decimalPart] = totalAmt.toString().split('.');
    let result = translate(parseInt(integerPart)) + ' Rupees';
    if (decimalPart) {
        decimalPart = decimalPart.padEnd(2, '0');
        result += ' and ' + translate(parseInt(decimalPart)) + ' Paise';
    }
    $('#totalamt_word').val(result + '.');
}

// Input Event Listeners
$('#freight_amount, #freight_percentage, #packaging_forwording_amount, #packaging_forwording_percentage, #gst_option, #item_rate').on('input', function() {
    subtotal();
    calculateTotalTaxAmount();
    updateTotalInWords();
});
</script>




<script>
$(document).ready(function () {
    // Initialize datepickers
    $('.datetimepicker').datepicker({
        dateFormat: 'dd-mm-yy',
        minDate: 0
    });

    // Set default dates
    const today = new Date();
    const formattedDate = `${('0' + today.getDate()).slice(-2)}-${('0' + (today.getMonth() + 1)).slice(-2)}-${today.getFullYear()}`;
    $('#sales_order_date, #buyer_order_date, #due_date').val(formattedDate);

    // Form validation
    $('#invoice_form').validate({
        rules: {
            customer_Name: "required",
            customer_id_select: "required",
            challan_type: "required",
            payment_term: "required",
            customer_Name_id: "required",
            so_date: "required",
            place_of_supply: "required",
            destination: "required",
            contact_person_name: "required",
            transporter_name: "required",
            invoice_type: "required",
            delivery_type: "required",
            buyer_order_no: "required",
            buyer_order_date: "required",
            gst_option: "required",
            'qty_0': "required",
            'rate_0': "required",
            'taxrate_0': "required"
        },
        messages: {
            customer_Name: "Customer Name form sales order is required",
            customer_id_select: "Customer is required",
            challan_type: "Challan is required",
            payment_term: "Payment Term is required",
            customer_Name_id: "Customer Name is required",
            so_date: "Sales Order Date is required",
            place_of_supply: "Place of Supply is required",
            destination: "Destination is required",
            contact_person_name: "Sales Person is required",
            transporter_name: "Dispatch Through is required",
            invoice_type: "Invoice Type is required",
            delivery_type: "Delivery Type is required",
            buyer_order_no: "Buyer Order No is required",
            buyer_order_date: "Buyer Order Date is required",
            gst_option: "GST option is required",
            'qty_0': "Quantity is required",
            'rate_0': "Unit Price is required",
            'taxrate_0': "Tax Rate is required"
        },
        highlight: function(element) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function(element) {
            $(element).removeClass('is-invalid');
        },
        errorElement: 'span',
        errorClass: 'invalid-feedback',
        errorPlacement: function(error, element) {
            if (element.is('select')) {
                error.insertAfter(element.closest('.form-group'));
            } else {
                error.insertAfter(element);
            }
        },
        invalidHandler: function(event, validator) {
            var errors = validator.numberOfInvalids();
            if (errors) {
                $("html, body").animate({
                    scrollTop: $(validator.errorList[0].element).offset().top - 100
                }, 500);
            }
        },
        submitHandler: function(form) {
            var email = $('#contact_person_email').val();
            if (email && email.toLowerCase() !== 'na' && email.toLowerCase() !== 'nan' && !isValidEmail(email)) {
                alert('Invalid email address.');
                return false;
            }
            form.submit();
        }
    });

});
</script>

{% endblock custom_js %}