{% extends 'dashboard/base_template.html' %}
{% block custom_css %}
{% block page_title %}
{% endblock page_title %}
<style>
    .custom-error {
        max-width: 300px;
        /* Adjust the width to your desired value */
        margin: 0 auto;
        /* Add this line to center the element */
        text-align: center;
        /* Add this line to center the text inside the element */
    }

    .input-group-text {
        cursor: pointer;
    }

    .grey-card {
        background-color: LightGray;
    }

    /* .negative-padding {
        margin-top: -60px;
    } */
    div.alphabet {
        display: table;
        width: 100%;
        margin-bottom: 1em;
        text-align: center;
    }
 
    div.alphabet span {
        display: inline-block;
        color: #3174c7;
        cursor: pointer;
        padding: 3px 8px;
        margin: 2px;
        border: 1px solid #3174c7;
        border-radius: 4px;
    }
 
    div.alphabet span:hover {
        background-color: #3174c7;
        color: white;
    }
 
    div.alphabet span.active {
        color: white;
        background-color: #3174c7;
        border-color: #3174c7;
    }
    .toast-success {
              background-color: darkgreen !important;
              color: white !important;
    }
    #toast-container {
        top: auto;
        top: 60px; /* Adjust this value to move the message further down or up */
    }
    .toast-error {
    background-color: red !important;
    color: white !important;
    }

    #toast-container {
        top: auto;
        top: 60px; /* Adjust as needed */
    }
            .dataTables_filter{
            margin-bottom: 16px !important;
        }
        .dataTables_length{
            margin-top: 8px !important;
        }
</style>
{% endblock custom_css %}
<!-- Main content -->
{% block main_content %}

<div class="page-wrapper negative-padding">
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">Proforma Invoice List</h3>
                </div>
                <div class="col-auto">
                    <a href="{% url 'performa_add_invoice_data' %}" class="btn btn-primary btn-rounded"> <i class="fas fa-plus-circle"></i>Add Proforma Invoice</a>
                </div>
            </div>
        </div>
        {% comment %} <div id="message-container" class="alert alert-success" style="display:none;">
            {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
                    {% endfor %}
            </ul>
            {% endif %}
        </div> {% endcomment %}



        <div class="row">
            <div class="col-sm-12">
                <div class="card card-table">
                    <div class="card-body">
                        <div class="table-responsive">
                            <div class="alphabet"></div>

                            <!-- <input type="date" id="startDate" class="remember">
                            <input type="date" id="endDate" class="remember">
                            <button onclick="filterTable()"class="btn btn-secondary"><i class="fa fa-filter" aria-hidden="true"style="padding-right:2px;"></i>Filter</button>
                            <button id="printTable"class="btn btn-info"><i class="fa fa-print" aria-hidden="true"style="size:10px;padding-right:3px;"></i>print</button>
                            &nbsp; -->
                            <!-- <select id="serviceTypeFilter" class="remember">
                                <option value="all" selected>All</option>
                                <option value="Lab">Lab</option>
                                <option value="Manufacturing">Manufacturing</option>
                            </select>
                            <button type="reset" class="btn btn-success reset"><i class="fa fa-undo" aria-hidden="true" style="padding-right: 3px;"></i>Reset</button> -->

                            <table id="challanTable" class="table table-center table-hover datatable">
                                <thead class="thead-light">
                                    <tr>
                                    <tr>
                                        <th>Sr No</th>
                                        <th>Date</th>
                                        <th>Proforma Invoice Number</th>
                                        <th>Delivery Challan no</th>
                                        <th>Customer Name</th>
                                        <th>Due Date</th>
                                        <th>Amount</th>
                                        <th>Due Amount</th>
                                        <!-- <th>Status</th> -->
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if invoice_data %}
                                    {% for t in invoice_data %}
                                    <tr>
                                        <td>
                                           {{forloop.counter}}
                                        </td>
                                        <td>
                                            {{t.invoice_date}}
                                        </td>
                                        <td >
                                            {{t.pi_number}}
                                        </td>
                                        <td>
                                            {% if t.invoice_delivery_no %}
                                            {{t.invoice_delivery_no}}
                                            {% else %}
                                              NA
                                            {% endif %}
                                        </td>
                                        <!-- <td>
                                            {{t.invoice_customer_name.dc_customer_name.customer}}
                                        </td> -->
                                        <td>
                                            {% if t.invoice_customer_name.dc_customer_name.customer  %}
                                            <a href="{% url 'performa_invoice_show_pdf' t.id %}" style="color:blue;">{{t.invoice_customer_name.dc_customer_name.customer}}</a>
                                            {% else %}
                                            <a href="{% url 'performa_invoice_show_pdf' t.id %}" style="color:blue;">{{t.invoice_customer.customer}}</a>
                                            {% endif %}
                                            
                                        </td>
                                        <td>{{t.invoice_due_date}}</td>
                                        <td>
                                            â‚¹{{t.invoice_sub_total}}
                                        </td>
                                        <td>{{t.invoice_total}}</td>

                                        <!-- <td style="width: 140px;">
                                            <form method="POST" action="{% url 'update_invstatus' id=t.id %}">
                                                {% csrf_token %}
                                                <select name="invoice_status" class="form-select" onchange="this.form.submit()">
                                                    <option value="Received" {% if t.invoice_status == 'Received' %} selected {% endif %}>Received</option>
                                                    <option value="Pending" {% if t.invoice_status == 'Pending' %} selected {% endif %}>Pending</option>
                                                </select>
                                            </form>
                                        </td> -->
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{% url 'performa_edit_invoice' id=t.id %}" class="btn btn-sm btn-outline-success me-1 btn-rounded"
                                                    role="button"><i class="far fa-edit me-1"></i></a>
                                                
                                                    <!-- <a href="{% url 'invoice_show_pdf' id=t.id %}" class="btn btn-sm btn-outline-success me-1 btn-rounded"
                                                    role="button"><i class="fas fa-eye"></i></a> -->

                                                    <!-- <a class="btn btn-sm btn-outline-danger me-1"
                                                    onclick="confirmDelete('{% url 'delete_invoice' id=t.id %}')">
                                                    <i class="far fa-trash-alt me-1"></i></a> -->

                                                    <a class="btn btn-sm btn-outline-danger me-1" data-bs-toggle="modal" data-bs-target="#deleteModal" 
                                                data-url="{% url 'delete_per_invoice_data' id=t.id %}">
                                                <i class="far fa-trash-alt me-1"></i></a>

                                             
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% endif %}

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this item?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

{% endblock main_content %}
{% block custom_js %}

<!-- Include Toastr CSS and JavaScript -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script>
    // Function to show the toast message
    function showToastMessage(message, type) {
      toastr[type](message);
    }
  
    // Check if a message exists and show it as a toast
    {% if messages %}
      {% for message in messages %}
        showToastMessage('{{ message }}', '{{ message.tags }}');
      {% endfor %}
    {% endif %}
  </script>
  
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#serviceTypeFilter').change(function() {
            var selectedServiceType = $(this).val();
            if (selectedServiceType === 'all') {
                $('#challanTable tbody tr').show();
            } else {
                $('#challanTable tbody tr').hide();
                $('#challanTable tbody tr').each(function() {
                    var serviceType = $(this).find('td:eq(8)').text().trim();
                    if (serviceType === selectedServiceType) {
                        $(this).show();
                    }
                });
            }
        });
    });
</script>


<script>
    function filterTable() {
        var startDate = new Date(document.getElementById('startDate').value);
        var endDate = new Date(document.getElementById('endDate').value);
        var tableRows = document.querySelectorAll('#challanTable tbody tr');

        tableRows.forEach(function(row) {
            var dateStr = row.cells[0].innerText;
            var rowDate = new Date(dateStr);
            startDate.setDate(startDate.getDate() - 1);

            // Adjust the end date to include the whole day

            if (rowDate >= startDate && rowDate < endDate) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>





<!-- Include Toastr CSS and JavaScript -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<!-- <script>
  // Function to show the toast message
  function showToastMessage(message, type) {
    toastr[type](message);
  }

  // Check if a success message exists and show it as a toast
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        showToastMessage('{{ message }}', 'success');
      {% endif %}
    {% endfor %}
  {% endif %}
</script> -->

<script>
    // Function to confirm the delete action
    function confirmDelete(url) {
        if (confirm("Are you sure you want to delete this item?")) {
            // If the user clicks OK, redirect to the delete URL
            window.location.href = url;
        }
    }
</script>
<script>
    // Show the message container
    var messageContainer = document.getElementById('message-container');
    messageContainer.style.display = 'block';

    // Automatically hide the message after 10 seconds
    setTimeout(function () {
        messageContainer.style.display = 'none';
    }, 2000); // 10000 milliseconds = 10 seconds
</script>
<!-- Include DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<!-- Include DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

<script>
    // Function to confirm the delete action
    function confirmDelete(url) {
        if (confirm("Are you sure you want to delete this item?")) {
            // If the user clicks OK, redirect to the delete URL
            window.location.href = url;
        }
    }
</script>
<script>
    // $(document).ready(function () {
    //     // Initialize DataTable with ordering set to false
    //     $('#challanTable').DataTable({
    //         "paging": true,       // Enable pagination
    //         "lengthChange": true, // Show the page length options
    //         "searching": true,    // Enable search
    //         "info": true,         // Show information
    //         "ordering": false,    // Disable ordering
    //     });
    // });



    $(document).ready(function() {
        $('#printTable').click(function(){
            startDate = $("#startDate").val(); 
            endDate = $("#endDate").val(); 
 
        $.ajax
        ({ 
        url: "#",

        data: {"startDate": startDate, "endDate": endDate, 'csrfmiddlewaretoken': '{{ csrf_token }}' },
        type: 'POST',
        xhrFields: {
                    responseType: 'blob'  // Request a Blob response for efficient file handling
                },

        success: function(response)
        {
            if (response.type === 'application/csv') {
                        var a = document.createElement('a');
                        var url = window.URL.createObjectURL(response);
                        a.href = url;
                        a.download = 'invoice.csv'; // Set the desired filename
                        a.click();
                        window.URL.revokeObjectURL(url); // Clean up memory usage
                    } else {
                        console.error('Invalid file type:', response.type);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('AJAX error:', textStatus, errorThrown);
                    // Handle any potential errors gracefully (e.g., display an error message to the user)
                }
        });    
    });
});

$(document).ready(function() {
        $(':input.remember').each(function() {
            $(this).attr('data-remember', $(this).val());
        });
        $('button.reset').click(function() {
            $(':input.remember').each(function() {
                $(this).val($(this).attr('data-remember'));
            });
        });
    });
    
</script>
<script>
    $(document).ready(function () {
        // Initialize DataTable with ordering set to false
        var table = $('#challanTable').DataTable({
            "paging": true,       // Enable pagination
            "lengthChange": true, // Show the page length options
            "searching": true,    // Enable search
            "info": true,         // Show information
            "ordering": false,    // Disable ordering
        });

        var alphabet = $('<div class="alphabet"/>').append('Search: ');
  
        $('<span class="clear active"/>')
            .data('letter', '')
            .html('ALL')
            .appendTo(alphabet);
  
        for (var i = 0; i < 26; i++) {
            var letter = String.fromCharCode(65 + i);
  
            $('<span/>')
                .data('letter', letter)
                .html(letter)
                .appendTo(alphabet);
        }
  
        alphabet.insertBefore(table.table().container());
  
        alphabet.on('click', 'span', function () {
            alphabet.find('.active').removeClass('active');
            $(this).addClass('active');
  
            var _alphabetSearch = $(this).data('letter');
            table.column(4).search('^' + _alphabetSearch, true, false).draw();
        });
    });
</script>


<script>

    document.getElementById('deleteModal').addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      var url = button.getAttribute('data-url');
      
      // Set the URL for the confirm button
      var confirmButton = document.getElementById('confirmDeleteBtn');
      confirmButton.onclick = function() {
        window.location.href = url;
      };
    });
    </script>


{% endblock custom_js %}