{% extends 'dashboard/base_template.html' %}
{% block title %}
CRM
{% endblock %}

{% block custom_css %}
<style>
    .error-message {
        color: red;
        font-size: 0.9em;
        margin-top: 5px;
        display: block;
    }
    .form-group.invalid .form-control {
        border-color: red;
    }
    .form-group.valid .form-control {
        border-color: green;
    }
</style>
{% endblock custom_css %}

{% block main_content %}
<div class="page-wrapper" style="padding-top: 0px;">
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row">
                <div class="col-sm-12">
                    <h3 class="page-title">
                        <a href="{% url 'fn_transporter_List_View' %}" style="margin-right: 10px;">
                            <i class="fa fa-arrow-left" data-bs-toggle="tooltip" title="" data-bs-original-title="Back" aria-label="fa fa-arrow-left"></i>
                        </a>
                        Edit Transporter
                    </h3>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <form method="post" id="vendor_form" action="" enctype="multipart/form-data" autocomplete="off">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Name <span style="color: red;">*</span></label>
                                        <input type="text" class="form-control" name="name" id="name" value="{{ transporter_instance.name }}" placeholder="Name" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Address <span style="color: red;">*</span></label>
                                        <input type="text" name="address" id="address" class="form-control" value="{{ transporter_instance.address }}" placeholder="Address" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>GST No</label>
                                        <input type="text" class="form-control" name="gst_no" id="gst_no_input" value="{{ transporter_instance.gst_no }}" placeholder="GST No. (e.g., 22ABCDE1234F1Z5)">
                                        <span id="gstError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Bank Name</label>
                                        <input type="text" class="form-control" name="bank_name" id="bank_name" value="{{ transporter_instance.bank_name }}" placeholder="Bank Name">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Account Number</label>
                                        <input type="text" class="form-control" name="account_number" id="account_number" value="{{ transporter_instance.account_number }}" placeholder="Account No." maxlength="17">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Branch</label>
                                        <input type="text" class="form-control" name="branch_name" id="branch_name" value="{{ transporter_instance.branch_name }}" placeholder="Branch Name">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Mobile Number <span style="color: red;">*</span></label>
                                        <input type="text" class="form-control" name="mobile" id="mobile" value="{{ transporter_instance.mobile }}" 
                                        placeholder="Mobile (10 digits)" maxlength="10" minlength="10" required>
                                        <span id="mobileError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" class="form-control" name="vendor_email" id="email" value="{{ transporter_instance.vendor_email }}" placeholder="Email Address">
                                        <span id="emailError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>IFSC Code</label>
                                        <input type="text" class="form-control" name="ifsc_code" id="ifsc_code" value="{{ transporter_instance.ifsc_code }}" placeholder="IFSC Code">
                                    </div>
                                </div>
                            </div>
                            <div class="add-customer-btns text-end">
                                <a href="{% url 'fn_transporter_List_View' %}" class="btn customer-btn-cancel btn-outline-danger me-1 btn-rounded">Cancel</a>
                                <button type="submit" class="btn btn-outline-primary me-1 btn-rounded">Save Transporter</button>
                            </div>
                            <div class="row col-sm-6 p-5">
                                <div class="success_message row"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}
{% block custom_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script>
$(document).ready(function() {
    // --- Custom Validation Methods ---
    $.validator.addMethod("validMobile", function(value, element) {
        return /^[6-9][0-9]{9}$/.test(value);
    }, "Mobile number must start with 6, 7, 8, or 9 and be 10 digits");

    $.validator.addMethod("validGST", function(value, element) {
        if (value.trim() === '') return true; // optional
        return /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/.test(value);
    }, "Enter a valid GST number (e.g., 22ABCDE1234F1Z5)");

    $.validator.addMethod("validIFSC", function(value, element) {
        if (value.trim() === '') return true; // optional
        return /^[A-Z]{4}0[A-Z0-9]{6}$/.test(value);
    }, "Enter a valid IFSC code (e.g., SBIN0001234)");

    $.validator.addMethod("validAccount", function(value, element) {
        if (value.trim() === '') return true; // optional
        return /^\d{1,17}$/.test(value);
    }, "Account number must be numeric and max 17 digits");

    // --- Initialize jQuery Validate ---
    $("#vendor_form").validate({
        rules: {
            name: { required: true, minlength: 2 },
            address: { required: true, minlength: 5 },
            mobile: { required: true, validMobile: true },
            vendor_email: { email: true },
            gst_no: { validGST: true },
            ifsc_code: { validIFSC: true },
            account_number: { validAccount: true }
        },
        messages: {
            name: { 
                required: "Please enter the transporter's name", 
                minlength: "Name must be at least 2 characters long" 
            },
            address: { 
                required: "Please enter the address", 
                minlength: "Address must be at least 5 characters long" 
            },
            mobile: {
                required: "Please enter a mobile number",
                validMobile: "Mobile number must start with 6,7,8,9 and be 10 digits"
            },
            vendor_email: { 
                email: "Enter a valid email address (e.g., user@example.com)" 
            },
            gst_no: { validGST: "Enter a valid GST number (e.g., 22ABCDE1234F1Z5)" },
            ifsc_code: { validIFSC: "Enter a valid IFSC code (e.g., SBIN0001234)" },
            account_number: { validAccount: "Account number must be numeric and max 17 digits" }
        },
        errorElement: "span",
        errorClass: "error-message",
        errorPlacement: function(error, element) {
            error.insertAfter(element);
        },
        highlight: function(element) {
            $(element).closest('.form-group').addClass('invalid').removeClass('valid');
        },
        unhighlight: function(element) {
            $(element).closest('.form-group').removeClass('invalid').addClass('valid');
        },
        submitHandler: function(form) {
            // Form will only submit if all validations pass
            form.submit();
        }
    });

    // --- Real-time Validation Feedback ---
    function attachRealtimeValidation(inputSelector, method, errorSelector, errorMessage) {
        $(inputSelector).on('input', function() {
            const value = $(this).val().trim();
            const formGroup = $(this).closest('.form-group');
            if (value === '' && method !== 'optional') {
                $(errorSelector).text("This field is required");
                formGroup.addClass('invalid').removeClass('valid');
            } else if (!method(value)) {
                $(errorSelector).text(errorMessage);
                formGroup.addClass('invalid').removeClass('valid');
            } else {
                $(errorSelector).text('');
                formGroup.removeClass('invalid').addClass('valid');
            }
        });
    }

    // Mobile real-time
    attachRealtimeValidation("#mobile", function(v){ return /^[6-9][0-9]{9}$/.test(v); }, "#mobileError", "Mobile number must start with 6-9 and be 10 digits");

    // GST real-time
    attachRealtimeValidation("#gst_no_input", function(v){ return v.trim()==='' || /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/.test(v); }, "#gstError", "Enter a valid GST number (e.g., 22ABCDE1234F1Z5)");

    // Email real-time
    attachRealtimeValidation("#email", function(v){ return v.trim()==='' || /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(v); }, "#emailError", "Enter a valid email address (e.g., user@example.com)");

});
</script>
{% endblock custom_js %}
