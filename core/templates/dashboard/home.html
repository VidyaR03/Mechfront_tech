{% extends 'dashboard/base_template.html' %}
{% block custom_css %}
{% block page_title %}
{% endblock page_title %}
<style>
.financial-overview {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.dropdown {
    position: relative;
}
.dropdown-btn {
    background: #007bff;
    color: #fff;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
}
.dropdown-menu {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    width: 120px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
.dropdown-item {
    padding: 10px;
    cursor: pointer;
    text-align: center;
}
.dropdown-item:hover {
    background: #f0f0f0;
}
</style>
{% endblock custom_css %}
{% block main_content %}

       
<div class="page-wrapper">
    <div class="content container-fluid">
        <div class="row">
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="dash-widget-header"> <span class="dash-widget-icon bg-1"> <i class="fas fa-users"></i> </span>
                            <div class="dash-count">
                                <div class="dash-title"> Total Customer </div>
                                <div class="dash-counts">
                                    <p>{{tcustomer}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="dash-widget-header"> <span class="dash-widget-icon bg-2"> <i class="fas fa-users"></i> </span>
                            <div class="dash-count">
                                <div class="dash-title">Total Vendor</div>
                                <div class="dash-counts">
                                    <p>{{total_vendor}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="dash-widget-header"> <span class="dash-widget-icon bg-3"> <i class="fas fa-file-alt"></i> </span>
                            <div class="dash-count">
                                <div class="dash-title">Total Invoices</div>
                                <div class="dash-counts">
                                    <p>{{tInvoice}}</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="dash-widget-header"> <span class="dash-widget-icon bg-4"> <i class="far fa-file"></i> </span>
                            <div class="dash-count">
                                <div class="dash-title">Total Bill</div>
                                <div class="dash-counts">
                                    <p>{{bill}}</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <br>

        <div class="row">
            <div class="col-xl-6 d-flex">
                <div class="card p-3">
                    <!-- Title & Dropdown in One Line -->
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title m-0">Sales Analysis</h5> <!-- Title on Left -->
                        <div class="dropdown">
                            <button class="btn-right btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="invoiceDropdownSALES" data-bs-toggle="dropdown" aria-expanded="false">
                                Select 
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="invoiceDropdownSALES">
                                <li><a href="javascript:void(0);" class="dropdown-item">Yearly</a></li>
                                <li><a href="javascript:void(0);" class="dropdown-item">Monthly</a></li>
                                <li><a href="javascript:void(0);" class="dropdown-item">Weekly</a></li>
                            </ul>
                        </div>
                    </div>
            
                    <!-- Chart Container -->
                    <div class="chart-container mt-3">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-6 d-flex">
                <div class="card flex-fill">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Invoice Analytics</h5>
                            <div class="dropdown">
                                <button class="btn-right btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="invoiceDropdownInvoice" data-bs-toggle="dropdown" aria-expanded="false"> Select  </button>
                                <ul class="dropdown-menu" aria-labelledby="invoiceDropdownInvoice">
                                    <li> <a href="javascript:void(0);" class="dropdown-item invoice-option" data-type="weekly">Current Week</a> </li>
                                    <li> <a href="javascript:void(0);" class="dropdown-item invoice-option" data-type="monthly">Current Month</a> </li>
                                    <li> <a href="javascript:void(0);" class="dropdown-item invoice-option" data-type="yearly">Current year</a> </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="invoice_chart"></div>
                    </div>
                </div>
            </div>
            
          
            
            
        </div>
        <br>

        <div class="row">
            <!-- Recent Invoices Section -->
            <div class="col-md-6 col-sm-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Recent Invoices</h5>
                        <a href="{% url 'invoice_list' %}" class="btn btn-sm btn-outline-primary"> View All </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table w-100">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Customer</th>
                                        <th>Invoice Date</th>
                                        <th>Invoice No.</th>
                                        <th>DC No.</th>
                                        <th>Amount</th>
                                        <th class="text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if invoices %}
                                        {% for t in invoices %}
                                            <tr>
                                                <td>
                                                    <a href="{% url 'invoice_show_pdf' t.id %}" class="text-primary">
                                                        {{ t.invoice_customer_name_customer.customer }}
                                                    </a>
                                                </td>
                                                <td>{{ t.invoice_date|date:"d-m-Y" }}</td>
                                                <td>{{ t.inv_number }}</td>
                                                <td>{{ t.invoice_delivery_no }}</td>
                                                <td>‚Çπ{{ t.invoice_total }}</td>
                                                <td class="text-right">
                                                    <a href="{% url 'invoice_show_pdf' t.id %}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No invoices found.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Recent Bills Section -->
            <div class="col-md-6 col-sm-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Recent Bills</h5>
                        <a href="{% url 'purchase_invoice_list' %}" class="btn btn-sm btn-outline-primary"> View All </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table w-100">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Vendor</th>
                                        <th>Invoice Date</th>
                                        <th>Amount</th>
                                        <th class="text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if pinvoice %}
                                        {% for t in pinvoice %}
                                            <tr>
                                                <td>{{ t.purchase_invoice_vendor_name.company_name }}</td>
                                                <td>{{ t.purchase_invoice_date|date:"d-m-Y" }}</td>
                                                <td>‚Çπ{{ t.purchase_invoice_total }}</td>
                                                <td class="text-right">
                                                    <a href="{% url 'edit_purchase_invoice' id=t.id %}" class="btn btn-sm btn-outline-success">
                                                        <i class="far fa-edit"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No bills found.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let financialChartData = JSON.parse('{{ financial_chart_data|safe }}');
        console.log("Loaded Financial Data:", financialChartData);

        let ctx = document.getElementById("financialChart").getContext("2d");
        let currentChartType = "Yearly";  // Default to Yearly
        let financialChart;

        function updateChart(chartType) {
            let labels = [];
            let creditData = [];
            let debitData = [];

            if (chartType === "Yearly") {
                let yearlyData = financialChartData.yearly;
                labels = Object.keys(yearlyData); // Use financial years as labels
                creditData = labels.map(year => yearlyData[year]?.credit?.reduce((a, b) => a + b, 0) || 0);
                debitData = labels.map(year => yearlyData[year]?.debit?.reduce((a, b) => a + b, 0) || 0);
            } 
            else if (chartType === "Monthly") {
                let latestYear = Object.keys(financialChartData.yearly).pop(); // Get latest financial year
                let monthlyData = financialChartData.yearly[latestYear];
                labels = ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"];
                creditData = monthlyData?.credit || new Array(12).fill(0);
                debitData = monthlyData?.debit || new Array(12).fill(0);
            } 
            else if (chartType === "Weekly") {
                let currentMonth = new Date().getMonth() + 1;
                let latestYear = Object.keys(financialChartData.yearly).pop(); // Latest year
                let weeklyData = financialChartData.weekly;
                labels = ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5"];
                creditData = weeklyData?.credit || new Array(5).fill(0);
                debitData = weeklyData?.debit || new Array(5).fill(0);
            }

            // Destroy old chart before creating a new one
            if (financialChart) {
                financialChart.destroy();
            }

             // **Set default dropdown selection to "Yearly"**
                let dropdownButton = document.getElementById("invoiceDropdownSALES");
                let dropdownOptions = document.querySelectorAll("#invoiceDropdownSALES + .dropdown-menu .dropdown-item");

                if (dropdownButton) {
                    dropdownButton.textContent = "Yearly"; // Set default
                }
                

            // Create new chart
            financialChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Credit",
                            data: creditData,
                            backgroundColor: "rgba(54, 162, 235, 0.6)"
                        },
                        {
                            label: "Debit",
                            data: debitData,
                            backgroundColor: "rgba(255, 99, 132, 0.6)"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        document.querySelectorAll("#invoiceDropdownSALES + .dropdown-menu .dropdown-item").forEach(item => {

            item.addEventListener("click", function () {
                let selectedType = this.textContent.trim();
                document.getElementById("invoiceDropdownSALES").textContent = selectedType; // Update button text
                updateChart(selectedType); // Updates only Sales Analysis
                console.log("Sales Analysis changed to:", selectedType); // Debugging
            });
        });


        // Initial chart load
        updateChart(currentChartType);

     
    });
</script>


<script type="application/json" id="invoice-analysis-data">
    
       {{ invoice_format_data|safe }}
  
</script>

<script>
   

document.addEventListener("DOMContentLoaded", function () {
    let invoiceDataElement = document.getElementById("invoice-analysis-data");
    let invoiceData = {};
    console.log(invoiceDataElement)
    

    if (!invoiceDataElement) {
        console.error("üö® Invoice analysis data not found!");
    } else {
        try {
            invoiceData = JSON.parse(invoiceDataElement.textContent);

            console.log("‚úÖ Invoice Data Loaded:", invoiceData);
        } catch (error) {
            console.error("‚ùå Error parsing invoice data:", error);
        }
    }

    function updateInvoiceChart(period) {
        let data = invoiceData[period] || { invoiced: 0, received: 0, pending: 0 };

        console.log("üìä Updating chart for:", period, data);

        let chartContainer = document.querySelector("#invoice_chart");
        if (!chartContainer) {
            console.error("üö® Chart container #invoice_chart not found!");
            return;
        }

        let received = Number(data.received) || 0;
        let invoiced = Number(data.invoiced) || 0;
        let pending = Number(data.pending) || 0;

          // **Check if all values are 0**
          if (received === 0 && invoiced === 0 && pending === 0) {
            chartContainer.innerHTML = `<div style="text-align:center; font-weight:bold; color:#666;">No Data Available</div>`;
            return;
        }

        var options = {
            chart: { type: 'donut', height: 350, width: '100%' },
            series: [received, invoiced, pending],
            labels: ['Received', 'Total', 'Pending'],
            colors: ['#FF5733', '#5733FF', '#FFA500'],
        };

        if (window.invoiceChart) {
            window.invoiceChart.destroy();
        }

        window.invoiceChart = new ApexCharts(chartContainer, options);
        window.invoiceChart.render();
    }

    let dropdownButton = document.getElementById("invoiceDropdownInvoice");
    let dropdownOptions = document.querySelectorAll(".invoice-option");

    if (dropdownButton) {
        dropdownButton.textContent = "Current Year"; // Default selected
    }

    if (!dropdownButton) {
        console.error("üö® Dropdown button not found!");
        return;
    }

    dropdownOptions.forEach(item => {
        item.addEventListener("click", function () {
            let selectedPeriod = this.getAttribute("data-type");
            dropdownButton.textContent = this.textContent;
            console.log("üìä Invoice Analysis changed to:", selectedPeriod);
            updateInvoiceChart(selectedPeriod);
        });
    });

    updateInvoiceChart("yearly"); // Default load Monthly data
});

</script>
{% endblock main_content %}